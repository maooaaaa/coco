<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeStation V6 | Ultimate Workspace</title>
    
    <!-- Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    
    <style>
        /* --- Core Variables --- */
        :root {
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.4);
            --accent: #8b5cf6;
            --danger: #ef4444;
            --success: #10b981;
            --bg-grad-1: #f8fafc;
            --bg-grad-2: #e2e8f0;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #0f172a;
            --text-sub: #64748b;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
        }

        body.dark {
            --primary: #60a5fa;
            --primary-glow: rgba(96, 165, 250, 0.3);
            --accent: #a78bfa;
            --bg-grad-1: #0f172a;
            --bg-grad-2: #1e293b;
            --glass-bg: rgba(30, 41, 59, 0.9);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* --- Base & Reset --- */
        body {
            margin: 0;
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
            background-attachment: fixed;
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: color 0.3s, background 0.3s;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--text-sub); border-radius: 4px; opacity: 0.3; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Glassmorphism Class */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow);
        }

        /* --- Layout --- */
        .sidebar {
            width: 260px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
            z-index: 20;
            border-right: 1px solid var(--glass-border);
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
        }
        .logo i { color: var(--primary); }
        .version-badge {
            font-size: 10px; background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; padding: 2px 8px; border-radius: 12px; font-weight: bold;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            overflow-y: auto;
        }

        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
            font-weight: 600;
            border-radius: 10px;
            font-size: 14px;
        }
        .menu-item:hover { background: rgba(128,128,128, 0.08); color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
        .menu-count { margin-left: auto; font-size: 10px; background: rgba(128,128,128,0.1); padding: 2px 6px; border-radius: 8px; }

        /* Main Area */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        .header {
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--glass-border);
        }

        .search-container { position: relative; width: 300px; }
        .search-input {
            width: 100%; padding: 10px 15px 10px 40px;
            border-radius: 20px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            transition: 0.3s;
        }
        .search-input:focus { background: var(--glass-bg); box-shadow: 0 0 0 2px var(--primary-glow); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 14px; }

        .content { flex: 1; padding: 30px; overflow-y: auto; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding-bottom: 80px;
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* Cards */
        .card {
            border-radius: 16px; padding: 20px;
            cursor: pointer; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; gap: 12px; position: relative;
            border: 1px solid transparent;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-glow); box-shadow: 0 10px 25px -5px var(--primary-glow); }
        
        .card-icon-box {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--glass-bg));
            border: 1px solid var(--glass-border);
            color: var(--primary);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
        }
        .card-title { font-weight: bold; font-size: 16px; }
        .card-desc { font-size: 13px; color: var(--text-sub); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .fav-btn {
            position: absolute; top: 15px; right: 15px;
            color: var(--text-sub); opacity: 0.3; transition: 0.2s;
        }
        .fav-btn:hover, .fav-btn.active { color: var(--accent); opacity: 1; transform: scale(1.1); }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; }
        .modal-box {
            width: 95%; max-width: 800px; max-height: 90vh;
            border-radius: 20px; display: flex; flex-direction: column;
            transform: scale(0.95); transition: 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            overflow: hidden; background: var(--glass-bg);
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .modal-header {
            padding: 15px 25px; border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 18px;
            background: rgba(var(--primary), 0.05);
        }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }

        /* UI Components */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 20px;
            border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 8px 15px; font-size: 13px; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(59, 130, 246, 0.1); }
        .btn-group { display: flex; gap: 10px; }

        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--glass-border);
            border-radius: 10px; margin-bottom: 15px; font-size: 14px;
            background: rgba(255,255,255,0.6); color: var(--text-main);
            transition: 0.2s;
        }
        body.dark input, body.dark textarea, body.dark select { background: rgba(0,0,0,0.3); }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-glow); background: var(--glass-bg); }

        .result-area {
            background: rgba(16, 185, 129, 0.08); border: 1px dashed var(--success);
            padding: 15px; border-radius: 10px; margin-top: 15px;
            text-align: center; font-weight: bold; color: var(--success);
            word-break: break-all;
        }

        /* Tool Specific Styles */
        /* Calculator Grid */
        .calc-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .calc-btn { 
            aspect-ratio: 1.3; font-size: 16px; background: rgba(128,128,128,0.1); 
            color: var(--text-main); border-radius: 8px; border:none; cursor:pointer; transition:0.1s; 
        }
        .calc-btn:hover { background: rgba(128,128,128,0.2); }
        .calc-btn.op { color: var(--primary); background: rgba(59,130,246,0.1); font-weight:bold; }
        .calc-btn.fn { color: var(--accent); background: rgba(139, 92, 246, 0.1); font-size: 14px; }
        .calc-btn.eq { background: var(--primary); color: white; grid-column: span 1; }
        .calc-disp { 
            grid-column: span 5; background: rgba(0,0,0,0.05); text-align: right; 
            padding: 15px; font-size: 28px; border-radius: 8px; margin-bottom: 10px; font-family: monospace; overflow: hidden;
        }

        /* Image Editor */
        .img-editor-container { max-height: 500px; background: #333; overflow: hidden; display: flex; justify-content: center; align-items: center; border-radius: 8px; }
        #cropper-img { max-width: 100%; max-height: 450px; }

        /* Todo */
        .todo-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--glass-border); animation: slideIn 0.2s; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 5px; }
        .todo-check { cursor: pointer; color: var(--text-sub); font-size: 18px; }
        .todo-check.done { color: var(--success); }
        .todo-text { flex: 1; }
        .todo-text.done { text-decoration: line-through; opacity: 0.5; }
        @keyframes slideIn { from{opacity:0; transform:translateX(-10px);} to{opacity:1; transform:translateX(0);} }

        /* Markdown Preview */
        #md-preview { 
            border: 1px solid var(--glass-border); padding: 15px; border-radius: 8px; 
            background: rgba(255,255,255,0.2); min-height: 100px; margin-top: 10px;
        }
        #md-preview h1 { font-size: 1.5em; border-bottom: 1px solid #ccc; }
        #md-preview blockquote { border-left: 4px solid #ccc; padding-left: 10px; color: #666; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: auto; padding: 10px 20px; flex-direction: row; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--glass-border); border-right: none; position: sticky; top:0; background: var(--glass-bg); z-index: 100; }
            .nav-menu { display: none; position: absolute; top: 60px; left: 0; right: 0; background: var(--glass-bg); padding: 20px; border-bottom: 1px solid var(--glass-border); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
            .nav-menu.active { display: flex; }
            .header { padding: 15px 20px; }
            .search-container { width: 100%; }
            .content { padding: 20px; }
            #mobile-toggle { display: block; font-size: 20px; color: var(--text-main); }
            .calc-grid { grid-template-columns: repeat(4, 1fr); }
            .calc-btn.fn { display: none; } /* スマホでは簡易モード */
            .calc-disp { grid-column: span 4; }
        }
        @media (min-width: 769px) { #mobile-toggle { display: none; } }
    </style>
</head>
<body>

    <!-- Tool Modal -->
    <div id="tool-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span id="tm-title"><i class="fas fa-tools"></i> Tool Name</span>
                <span style="cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:rgba(128,128,128,0.1);" onclick="closeModal()">×</span>
            </div>
            <div class="modal-body">
                <p id="tm-desc" style="color:var(--text-sub); margin-bottom:20px; font-size:14px;"></p>
                <div id="tm-ui"></div>
                <div id="tm-result" class="result-area" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar glass">
        <div class="logo">
            <i class="fas fa-cube"></i> 
            <span>LifeStation</span>
            <span class="version-badge">V6</span>
            <i id="mobile-toggle" class="fas fa-bars" onclick="toggleMenu()" style="margin-left:auto;"></i>
        </div>
        
        <div class="nav-menu" id="nav-menu">
            <div class="menu-item active" onclick="filter('all')"><i class="fas fa-th-large"></i> すべて <span class="menu-count" id="c-all">0</span></div>
            <div class="menu-item" onclick="filter('fav')"><i class="fas fa-star" style="color:var(--accent)"></i> お気に入り <span class="menu-count" id="c-fav">0</span></div>
            <div class="menu-item" onclick="filter('work')"><i class="fas fa-briefcase"></i> 仕事・効率化 <span class="menu-count" id="c-work">0</span></div>
            <div class="menu-item" onclick="filter('calc')"><i class="fas fa-calculator"></i> 計算・分析 <span class="menu-count" id="c-calc">0</span></div>
            <div class="menu-item" onclick="filter('image')"><i class="fas fa-image"></i> 画像処理 <span class="menu-count" id="c-image">0</span></div>
            <div class="menu-item" onclick="filter('text')"><i class="fas fa-font"></i> テキスト・開発 <span class="menu-count" id="c-text">0</span></div>
            
            <div style="margin-top:auto; padding-top:10px; border-top:1px solid var(--glass-border); display:flex; justify-content:space-between; font-size:18px;">
                <i class="fas fa-moon" onclick="toggleTheme()" style="cursor:pointer; color:var(--text-sub);" title="ダークモード切替"></i>
                <i class="fas fa-file-export" onclick="exportData()" style="cursor:pointer; color:var(--text-sub);" title="データ保存"></i>
                <i class="fas fa-trash-alt" onclick="clearData()" style="cursor:pointer; color:var(--danger);" title="データ初期化"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <header class="header glass">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="ツールを検索 (Ctrl+K)..." id="search-box" oninput="searchTools(this.value)">
            </div>
            <div style="font-size:12px; color:var(--text-sub); text-align:right;">
                <div id="clock" style="font-weight:bold; font-size:16px; color:var(--text-main);">00:00</div>
                <div id="date">Loading...</div>
            </div>
        </header>

        <div class="content">
            <div id="grid" class="grid">
                <!-- Cards will be injected here -->
            </div>
            <div style="text-align:center; margin-top:50px; color:var(--text-sub); font-size:12px;">
                LifeStation V6 - Ultimate Web Workspace
            </div>
        </div>
    </main>

    <script>
        // ============================================
        //  APP STATE & CONFIG
        // ============================================
        const STORE_KEY = 'lifestation_v6_data';
        let appData = {
            favs: [],
            todos: [],
            memo: '',
            theme: 'light'
        };
        let activeTool = null;
        let pInterval = null; // Pomodoro
        let swInterval = null; // Stopwatch
        let cropper = null; // Image Editor

        // ============================================
        //  TOOLS DEFINITION
        // ============================================
        const tools = [
            // --- WORK (仕事・効率化) ---
            {
                id: 'todo', cat: 'work', icon: 'fa-check-double', title: 'ToDoリスト', desc: 'ドラッグ移動可能なタスク管理',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="td-in" placeholder="新しいタスク..." onkeypress="if(event.key==='Enter')addTodo()" style="margin:0;">
                            <button class="btn" style="width:auto;" onclick="addTodo()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="td-list" style="margin-top:15px; max-height:400px; overflow-y:auto;"></div>
                    `;
                    renderTodos();
                }
            },
            {
                id: 'memo', cat: 'work', icon: 'fa-sticky-note', title: 'Markdownメモ', desc: 'プレビュー機能付き高機能メモ',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; height:400px;">
                            <textarea id="memo-pad" style="resize:none; height:100%;" placeholder="# Markdownが使えます" oninput="updateMemo()">${appData.memo || ''}</textarea>
                            <div id="md-preview" style="height:100%; overflow-y:auto;"></div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn btn-outline" onclick="downloadMemo()"><i class="fas fa-download"></i> .md保存</button>
                            <button class="btn btn-outline" onclick="copyMemo()"><i class="fas fa-copy"></i> コピー</button>
                        </div>
                    `;
                    updateMemo();
                }
            },
            {
                id: 'pomo', cat: 'work', icon: 'fa-clock', title: 'ポモドーロ', desc: '集中力維持のためのタイマー',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="text-align:center;">
                            <div id="pm-disp" style="font-size:72px; font-weight:800; font-family:monospace; color:var(--primary); margin:30px 0;">25:00</div>
                            <div style="display:flex; justify-content:center; gap:10px;">
                                <button class="btn" onclick="startPomo(25)">集中 (25分)</button>
                                <button class="btn" style="background:var(--success)" onclick="startPomo(5)">休憩 (5分)</button>
                                <button class="btn" style="background:var(--danger); width:auto;" onclick="stopPomo()"><i class="fas fa-stop"></i></button>
                            </div>
                        </div>
                    `;
                }
            },
            {
                id: 'stopwatch', cat: 'work', icon: 'fa-stopwatch', title: 'ストップウォッチ', desc: 'ラップ計測機能付き',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="text-align:center;">
                            <div id="sw-disp" style="font-size:60px; font-family:monospace; font-weight:bold; margin:20px 0;">00:00.00</div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
                                <button class="btn" onclick="startSW()">Start</button>
                                <button class="btn" style="background:var(--accent)" onclick="lapSW()">Lap</button>
                                <button class="btn" style="background:var(--danger)" onclick="stopSW()">Stop/Reset</button>
                            </div>
                            <div id="sw-laps" style="max-height:200px; overflow-y:auto; border-top:1px solid var(--glass-border);"></div>
                        </div>
                    `;
                }
            },

            // --- CALC (計算・分析) ---
            {
                id: 'calc', cat: 'calc', icon: 'fa-calculator', title: '関数電卓', desc: '科学技術計算に対応した高機能電卓',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div class="calc-disp" id="c-disp">0</div>
                        <div class="calc-grid">
                            <button class="calc-btn fn" onclick="cIn('Math.sin(')">sin</button>
                            <button class="calc-btn fn" onclick="cIn('Math.cos(')">cos</button>
                            <button class="calc-btn fn" onclick="cIn('Math.tan(')">tan</button>
                            <button class="calc-btn fn" onclick="cIn('Math.PI')">π</button>
                            <button class="calc-btn op" onclick="cIn('C')">AC</button>
                            
                            <button class="calc-btn fn" onclick="cIn('Math.sqrt(')">√</button>
                            <button class="calc-btn fn" onclick="cIn('(')">(</button>
                            <button class="calc-btn fn" onclick="cIn(')')">)</button>
                            <button class="calc-btn fn" onclick="cIn('**')">^</button>
                            <button class="calc-btn op" onclick="cIn('/')">÷</button>
                            
                            <button class="calc-btn" onclick="cIn('7')">7</button>
                            <button class="calc-btn" onclick="cIn('8')">8</button>
                            <button class="calc-btn" onclick="cIn('9')">9</button>
                            <button class="calc-btn op" onclick="cIn('Del')">⌫</button>
                            <button class="calc-btn op" onclick="cIn('*')">×</button>
                            
                            <button class="calc-btn" onclick="cIn('4')">4</button>
                            <button class="calc-btn" onclick="cIn('5')">5</button>
                            <button class="calc-btn" onclick="cIn('6')">6</button>
                            <button class="calc-btn op" onclick="cIn('-')">-</button>
                            <button class="calc-btn op" onclick="cIn('%')">%</button>
                            
                            <button class="calc-btn" onclick="cIn('1')">1</button>
                            <button class="calc-btn" onclick="cIn('2')">2</button>
                            <button class="calc-btn" onclick="cIn('3')">3</button>
                            <button class="calc-btn op" onclick="cIn('+')">+</button>
                            <button class="calc-btn eq" onclick="cIn('=')">=</button>
                            
                            <button class="calc-btn" onclick="cIn('0')" style="grid-column:span 2;">0</button>
                            <button class="calc-btn" onclick="cIn('.')">.</button>
                        </div>
                    `;
                    setupCalcKeys();
                }
            },
            { id: 'discount', cat: 'calc', icon: 'fa-tags', title: '割引計算', desc: '税込価格と割引額を即座に計算', inputs: ['price:元の価格(円)', 'per:割引率(%)'], func: (p,r) => { const end=Math.floor(p*(1-r/100)); return `支払額: ${end.toLocaleString()}円<br><span style="font-size:12px;color:gray">(${p*r/100}円 お得)</span>`; } },
            { id: 'age', cat: 'calc', icon: 'fa-birthday-cake', title: '年齢・暦計算', desc: '西暦和暦、年齢、干支を一括計算', inputs:['birth:誕生日 (例: 1990-01-01)'], func:(b)=>{
                const d = new Date(b); if(isNaN(d)) return '正しい日付を入力してください';
                const now = new Date();
                const age = now.getFullYear() - d.getFullYear() - (now < new Date(now.getFullYear(), d.getMonth(), d.getDate()) ? 1 : 0);
                const eto = ['申','酉','戌','亥','子','丑','寅','卯','辰','巳','午','未'][d.getFullYear()%12];
                return `年齢: ${age}歳<br>和暦: ${toWareki(d.getFullYear())}<br>干支: ${eto}`;
            }},
            { id: 'unit', cat: 'calc', icon: 'fa-balance-scale', title: '単位変換Pro', desc: '長さ/重さ/温度/面積/速度/データ', type:'custom', render:(el)=>{
                el.innerHTML=`
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <select id="u-cat" onchange="updateUnitType()"><option value="len">長さ</option><option value="wgt">重さ</option><option value="tmp">温度</option><option value="area">面積</option><option value="spd">速度</option></select>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" id="u-val" placeholder="値" style="margin:0;">
                            <select id="u-from" style="margin:0;"></select>
                            <i class="fas fa-arrow-right"></i>
                            <select id="u-to" style="margin:0;"></select>
                        </div>
                        <button class="btn" onclick="convertUnitPro()">変換</button>
                    </div>
                `;
                updateUnitType();
            }},

            // --- IMAGE (画像処理) ---
            {
                id: 'img-editor', cat: 'image', icon: 'fa-crop-alt', title: '画像エディタ', desc: 'トリミング・回転・フィルタ・保存',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <input type="file" id="img-in" accept="image/*" onchange="initCropper(this)">
                        <div class="img-editor-container" id="crop-container" style="display:none;">
                            <img id="cropper-img" src="">
                        </div>
                        <div id="editor-controls" style="display:none; margin-top:10px;">
                            <div class="btn-group" style="margin-bottom:10px; flex-wrap:wrap;">
                                <button class="btn btn-sm btn-outline" onclick="cropper.rotate(-90)"><i class="fas fa-undo"></i></button>
                                <button class="btn btn-sm btn-outline" onclick="cropper.rotate(90)"><i class="fas fa-redo"></i></button>
                                <button class="btn btn-sm btn-outline" onclick="cropper.scaleX(cropper.getData().scaleX*-1)"><i class="fas fa-arrows-alt-h"></i></button>
                                <button class="btn btn-sm btn-outline" onclick="cropper.reset()">Reset</button>
                            </div>
                            <button class="btn" onclick="exportCroppedImage()"><i class="fas fa-file-export"></i> 編集を確定して保存</button>
                        </div>
                    `;
                }
            },
            { id: 'qrcode', cat: 'image', icon: 'fa-qrcode', title: 'QR作成', desc: 'テキストやURLからQRコードを生成', inputs:['text:内容'], type:'qr' },
            { id: 'color', cat: 'image', icon: 'fa-palette', title: 'カラーピッカー', desc: '色を選択してHEX/RGBコードを取得', type:'custom', render:(el)=>{
                el.innerHTML=`<input type="color" style="height:80px; cursor:pointer;" onchange="updateColor(this.value)">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                    <div id="c-hex" style="background:rgba(0,0,0,0.1); padding:10px; text-align:center; border-radius:8px; font-weight:bold;">#000000</div>
                    <div id="c-rgb" style="background:rgba(0,0,0,0.1); padding:10px; text-align:center; border-radius:8px;">rgb(0,0,0)</div>
                </div>`;
            }},

            // --- TEXT / DEV (テキスト・開発) ---
            { id: 'regex', cat: 'text', icon: 'fa-search', title: '正規表現テスト', desc: 'リアルタイムマッチング確認', type:'custom', render:(el)=>{
                el.innerHTML = `<input type="text" id="reg-pat" placeholder="/Pattern/flags" oninput="testRegex()">
                <textarea id="reg-txt" rows="4" placeholder="対象テキスト" oninput="testRegex()"></textarea>
                <div id="reg-res" class="result-area" style="text-align:left; white-space:pre-wrap;"></div>`;
            }},
            { id: 'char', cat: 'text', icon: 'fa-text-width', title: '文字数カウント', desc: '文字数、行数、原稿用紙枚数', type:'custom', render:(el)=>{
                el.innerHTML=`<textarea id="txt-c" rows="5" placeholder="テキストを入力..." oninput="countChar()"></textarea><div id="txt-res" style="text-align:right; font-weight:bold;">0 文字</div>`;
            }},
            { id: 'json', cat: 'text', icon: 'fa-code', title: 'JSON整形', desc: '崩れたJSONを綺麗にフォーマット', inputs:['json:JSON文字列'], func:(t)=>{try{return `<pre style="text-align:left; overflow:auto; max-height:300px; background:rgba(0,0,0,0.05); padding:10px; border-radius:8px;">${JSON.stringify(JSON.parse(t),null,2)}</pre>`}catch(e){return 'Error: Invalid JSON'}} },
            { id: 'pass', cat: 'text', icon: 'fa-key', title: 'パスワード生成', desc: '強力なランダムパスワードを生成', inputs:['len:長さ(8-64)'], func:(l)=>{const c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*"; let r=""; for(let i=0;i<(l||16);i++) r+=c[Math.floor(Math.random()*c.length)]; return r;} },
            { id: 'base64', cat: 'text', icon: 'fa-database', title: 'Base64変換', desc: 'Encode / Decode', inputs:['val:値', 'mode:encode/decode'], func:(v,m)=>m==='decode'?atob(v):btoa(unescape(encodeURIComponent(v))) },
            { id: 'share', cat: 'text', icon: 'fa-share-alt', title: 'Web共有', desc: 'スマホ標準の共有メニューを開く', inputs:['url:URL', 'title:タイトル'], type:'async', func:async(u,t)=>{ if(navigator.share){ await navigator.share({title:t, url:u}); return '共有メニューを開きました'; } else return 'このブラウザは非対応です'; } },
        ];

        // ============================================
        //  INIT & CORE FUNCTIONS
        // ============================================
        window.onload = () => {
            loadData();
            updateTime();
            renderGrid(tools);
            updateCounts();
            
            document.addEventListener('keydown', (e) => {
                if(e.ctrlKey && e.key === 'k') { e.preventDefault(); document.getElementById('search-box').focus(); }
                if(e.key === 'Escape') closeModal();
            });

            setInterval(updateTime, 1000);
        };

        function loadData() {
            const d = localStorage.getItem(STORE_KEY);
            if(d) {
                appData = JSON.parse(d);
                if(appData.theme === 'dark') document.body.classList.add('dark');
            }
        }
        function saveData() { localStorage.setItem(STORE_KEY, JSON.stringify(appData)); }
        function updateTime() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('date').innerText = now.toLocaleDateString('ja-JP', {month:'short', day:'numeric', weekday:'short'});
        }
        function exportData() {
            const b = new Blob([JSON.stringify(appData)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='lifestation_backup.json'; a.click();
        }

        // ============================================
        //  UI LOGIC
        // ============================================
        function renderGrid(list) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            list.forEach(t => {
                const isFav = appData.favs.includes(t.id);
                const div = document.createElement('div');
                div.className = 'card glass';
                div.innerHTML = `
                    <i class="fas fa-star fav-btn ${isFav?'active':''}" onclick="toggleFav('${t.id}', event)"></i>
                    <div class="card-icon-box"><i class="fas ${t.icon}"></i></div>
                    <div>
                        <div class="card-title">${t.title}</div>
                        <div class="card-desc">${t.desc}</div>
                    </div>
                `;
                div.onclick = () => openTool(t);
                grid.appendChild(div);
            });
        }
        function filter(cat) {
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(window.innerWidth <= 768) toggleMenu();
            if(cat === 'all') renderGrid(tools);
            else if(cat === 'fav') renderGrid(tools.filter(t => appData.favs.includes(t.id)));
            else renderGrid(tools.filter(t => t.cat === cat));
        }
        function searchTools(q) {
            q = q.toLowerCase();
            renderGrid(tools.filter(t => t.title.toLowerCase().includes(q) || t.desc.toLowerCase().includes(q)));
        }
        function updateCounts() {
            ['work','calc','image','text'].forEach(c => document.getElementById('c-'+c).innerText = tools.filter(t => t.cat === c).length);
            document.getElementById('c-all').innerText = tools.length;
            document.getElementById('c-fav').innerText = appData.favs.length;
        }
        function toggleFav(id, e) {
            e.stopPropagation();
            if(appData.favs.includes(id)) appData.favs = appData.favs.filter(i => i !== id);
            else appData.favs.push(id);
            saveData();
            e.target.classList.toggle('active');
            updateCounts();
        }
        function toggleTheme() {
            document.body.classList.toggle('dark');
            appData.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            saveData();
        }
        function clearData() { if(confirm('初期化しますか？')) { localStorage.removeItem(STORE_KEY); location.reload(); } }
        function toggleMenu() { document.getElementById('nav-menu').classList.toggle('active'); }

        // ============================================
        //  TOOL EXECUTION
        // ============================================
        function openTool(tool) {
            activeTool = tool;
            document.getElementById('tm-title').innerHTML = `<i class="fas ${tool.icon}"></i> ${tool.title}`;
            document.getElementById('tm-desc').innerText = tool.desc;
            const ui = document.getElementById('tm-ui');
            const res = document.getElementById('tm-result');
            ui.innerHTML = '';
            res.style.display = 'none';
            res.innerHTML = '';
            
            if(tool.type === 'custom') {
                tool.render(ui);
            } else {
                if(tool.inputs) {
                    tool.inputs.forEach((inp, i) => {
                        const [key, ph] = inp.includes(':') ? inp.split(':') : ['v', inp];
                        ui.innerHTML += `<input type="text" id="in-${i}" placeholder="${ph}">`;
                    });
                }
                ui.innerHTML += `<button class="btn" onclick="execTool()">実行</button>`;
            }
            const modal = document.getElementById('tool-modal');
            modal.style.display = 'flex';
            setTimeout(()=>modal.classList.add('show'), 10);
        }

        function closeModal() {
            const modal = document.getElementById('tool-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                if(cropper) { cropper.destroy(); cropper=null; }
                stopPomo();
                stopSW();
            }, 200);
        }

        async function execTool() {
            const resBox = document.getElementById('tm-result');
            resBox.style.display = 'block';
            try {
                const args = [];
                if(activeTool.inputs) for(let i=0; i<activeTool.inputs.length; i++) args.push(document.getElementById(`in-${i}`).value);
                
                if(activeTool.type === 'qr') {
                    resBox.innerHTML = '';
                    new QRCode(resBox, args[0]);
                } else if(activeTool.type === 'async') {
                    resBox.innerHTML = 'Processing...';
                    resBox.innerHTML = await activeTool.func(...args);
                } else {
                    resBox.innerHTML = activeTool.func(...args);
                }
            } catch(e) { resBox.innerText = 'Error: 入力を確認してください'; }
        }

        // --- ToDo ---
        function addTodo() {
            const v = document.getElementById('td-in').value;
            if(!v) return;
            appData.todos.push({txt:v, done:false});
            saveData();
            document.getElementById('td-in').value = '';
            renderTodos();
        }
        function renderTodos() {
            const list = document.getElementById('td-list');
            list.innerHTML = '';
            appData.todos.forEach((t, i) => {
                const d = document.createElement('div');
                d.className = 'todo-item';
                d.innerHTML = `<i class="fas fa-check-circle todo-check ${t.done?'done':''}" onclick="togTodo(${i})"></i><span class="todo-text ${t.done?'done':''}" contenteditable="true" onblur="updTodo(${i}, this.innerText)">${t.txt}</span><i class="fas fa-times" style="color:var(--danger);cursor:pointer;" onclick="delTodo(${i})"></i>`;
                list.appendChild(d);
            });
            new Sortable(list, { onEnd: (e)=>{
                const item = appData.todos.splice(e.oldIndex, 1)[0];
                appData.todos.splice(e.newIndex, 0, item);
                saveData();
            }});
        }
        function togTodo(i) { appData.todos[i].done = !appData.todos[i].done; saveData(); renderTodos(); }
        function delTodo(i) { appData.todos.splice(i, 1); saveData(); renderTodos(); }
        function updTodo(i, t) { appData.todos[i].txt = t; saveData(); }

        // --- Memo (Markdown) ---
        function updateMemo() {
            const txt = document.getElementById('memo-pad').value;
            document.getElementById('md-preview').innerHTML = marked.parse(txt);
            appData.memo = txt;
            saveData();
        }
        function copyMemo() { navigator.clipboard.writeText(appData.memo); alert('Copied!'); }
        function downloadMemo() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([appData.memo], {type:'text/markdown'}));
            a.download = `memo_${new Date().toISOString().slice(0,10)}.md`;
            a.click();
        }

        // --- Stopwatch ---
        let swStart = 0; let swTime = 0;
        function startSW() { if(!swInterval) { swStart = Date.now() - swTime; swInterval = setInterval(updSW, 10); } }
        function stopSW() { 
            if(swInterval) { clearInterval(swInterval); swInterval=null; } 
            else { swTime=0; updSW(); document.getElementById('sw-laps').innerHTML=''; } 
        }
        function updSW() { 
            swTime = Date.now() - swStart; 
            const ms=Math.floor((swTime%1000)/10); const s=Math.floor((swTime/1000)%60); const m=Math.floor(swTime/60000);
            document.getElementById('sw-disp').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${ms.toString().padStart(2,'0')}`;
        }
        function lapSW() { 
            const t = document.getElementById('sw-disp').innerText; 
            document.getElementById('sw-laps').innerHTML = `<div style="padding:5px; border-bottom:1px solid #ccc;">${t}</div>` + document.getElementById('sw-laps').innerHTML;
        }

        // --- Pomodoro ---
        function startPomo(min) {
            stopPomo();
            let s = min * 60;
            const d = document.getElementById('pm-disp');
            pInterval = setInterval(() => {
                s--;
                d.innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                if(s<=0) { stopPomo(); alert('Time Up!'); }
            }, 1000);
        }
        function stopPomo() { if(pInterval) clearInterval(pInterval); }

        // --- Scientific Calculator ---
        let cExp = '';
        function setupCalcKeys() {
            document.onkeydown = (e) => {
                const k = e.key;
                if((k>='0'&&k<='9')||['+','-','*','/','.','(',')','%'].includes(k)) { e.preventDefault(); cIn(k); }
                else if(k==='Enter') { e.preventDefault(); cIn('='); }
                else if(k==='Backspace') { e.preventDefault(); cIn('Del'); }
                else if(k==='Escape') { e.preventDefault(); cIn('C'); }
            }
        }
        function cIn(v) {
            const d = document.getElementById('c-disp');
            if(v==='C') cExp = '';
            else if(v==='Del') cExp = cExp.slice(0,-1);
            else if(v==='=') {
                try { 
                    // Safe Eval for Math
                    const res = new Function('return ' + cExp.replace(/Math\./g, 'Math.'))();
                    cExp = String(res);
                } catch { cExp = 'Error'; }
            } else cExp += v;
            d.innerText = cExp || '0';
        }

        // --- Unit Converter Pro ---
        const units = {
            len: { m:1, cm:100, mm:1000, km:0.001, inch:39.37, ft:3.28, yd:1.09, mile:0.00062 },
            wgt: { kg:1, g:1000, mg:1000000, lb:2.204, oz:35.27 },
            tmp: { C:'C', F:'F' },
            area: { m2:1, tsubo:0.3025, ft2:10.76, acre:0.000247 },
            spd: { kmh:1, ms:0.277, mph:0.621, knot:0.539 }
        };
        function updateUnitType() {
            const t = document.getElementById('u-cat').value;
            const ks = Object.keys(units[t]);
            const mkOpt = (k) => `<option value="${k}">${k}</option>`;
            document.getElementById('u-from').innerHTML = ks.map(mkOpt).join('');
            document.getElementById('u-to').innerHTML = ks.map(mkOpt).join('');
        }
        function convertUnitPro() {
            const t = document.getElementById('u-cat').value;
            const v = parseFloat(document.getElementById('u-val').value);
            const f = document.getElementById('u-from').value;
            const to = document.getElementById('u-to').value;
            if(isNaN(v)) return;
            
            let res = 0;
            if(t === 'tmp') {
                if(f==='C' && to==='F') res = v*1.8+32;
                else if(f==='F' && to==='C') res = (v-32)/1.8;
                else res = v;
            } else {
                const base = v / units[t][f];
                res = base * units[t][to];
            }
            alert(`${v}${f} = ${res.toFixed(4)}${to}`);
        }

        // --- Image Editor (Cropper) ---
        function initCropper(input) {
            if(cropper) { cropper.destroy(); cropper=null; }
            if(!input.files[0]) return;
            const img = document.getElementById('cropper-img');
            const reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result;
                document.getElementById('crop-container').style.display='flex';
                document.getElementById('editor-controls').style.display='block';
                cropper = new Cropper(img, { viewMode: 1 });
            };
            reader.readAsDataURL(input.files[0]);
        }
        function exportCroppedImage() {
            if(!cropper) return;
            const canvas = cropper.getCroppedCanvas();
            const a = document.createElement('a');
            a.href = canvas.toDataURL('image/png');
            a.download = 'edited_image.png';
            a.click();
        }
        function updateColor(v) {
            document.getElementById('c-hex').innerText = v.toUpperCase();
            const r=parseInt(v.slice(1,3),16), g=parseInt(v.slice(3,5),16), b=parseInt(v.slice(5,7),16);
            document.getElementById('c-rgb').innerText = `rgb(${r}, ${g}, ${b})`;
        }

        // --- Text/Dev ---
        function countChar() {
            const t = document.getElementById('txt-c').value;
            document.getElementById('txt-res').innerText = `${t.length}字 | 行数:${t.split('\n').length} | 原稿:${Math.ceil(t.length/400)}枚`;
        }
        function testRegex() {
            const p = document.getElementById('reg-pat').value;
            const t = document.getElementById('reg-txt').value;
            const r = document.getElementById('reg-res');
            if(!p || !t) { r.innerText=''; return; }
            try {
                const parts = p.match(/^\/(.*?)\/([gimsuy]*)$/);
                const re = parts ? new RegExp(parts[1], parts[2]) : new RegExp(p);
                const m = t.match(re);
                r.innerText = m ? `Match Found:\n${JSON.stringify(m,null,2)}` : 'No Match';
                r.style.color = m ? 'var(--success)' : 'var(--danger)';
            } catch(e) { r.innerText = 'Invalid Regex'; r.style.color = 'var(--danger)'; }
        }
        function toWareki(y) {
            if(y>=2019) return `令和${y-2018}年`;
            if(y>=1989) return `平成${y-1988}年`;
            if(y>=1926) return `昭和${y-1925}年`;
            return y;
        }

    </script>
</body>
</html>
