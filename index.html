<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeStation V7 | Zenith Workspace</title>
    
    <!-- Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    
    <style>
        /* --- Core Variables --- */
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --accent: #ec4899;
            --danger: #ef4444;
            --success: #10b981;
            --bg-grad-1: #f3f4f6;
            --bg-grad-2: #e0e7ff;
            --glass-bg: rgba(255, 255, 255, 0.92);
            --glass-border: rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.08);
            --font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
        }

        body.dark {
            --primary: #818cf8;
            --primary-glow: rgba(129, 140, 248, 0.3);
            --accent: #f472b6;
            --bg-grad-1: #0f172a;
            --bg-grad-2: #1e1b4b;
            --glass-bg: rgba(30, 41, 59, 0.92);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
        }

        /* --- Base & Reset --- */
        body {
            margin: 0;
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
            background-attachment: fixed;
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: color 0.3s, background 0.3s;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--text-sub); border-radius: 4px; opacity: 0.3; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Glassmorphism Class */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow);
        }

        /* --- Layout --- */
        .sidebar {
            width: 260px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
            z-index: 20;
            border-right: 1px solid var(--glass-border);
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
        }
        .logo i { color: var(--primary); }
        .version-badge {
            font-size: 10px; background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; padding: 2px 8px; border-radius: 12px; font-weight: bold;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            overflow-y: auto;
        }

        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
            font-weight: 600;
            border-radius: 12px;
            font-size: 14px;
        }
        .menu-item:hover { background: rgba(128,128,128, 0.08); color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
        .menu-count { margin-left: auto; font-size: 10px; background: rgba(128,128,128,0.1); padding: 2px 6px; border-radius: 8px; }

        /* Main Area */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        .header {
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--glass-border);
        }

        .search-container { position: relative; width: 300px; }
        .search-input {
            width: 100%; padding: 10px 15px 10px 40px;
            border-radius: 20px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            transition: 0.3s;
        }
        .search-input:focus { background: var(--glass-bg); box-shadow: 0 0 0 2px var(--primary-glow); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 14px; }

        .content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* Dashboard Widgets */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeIn 0.4s ease;
        }
        .widget {
            padding: 20px; border-radius: 16px;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            min-height: 150px;
        }
        .widget-title { font-size: 14px; color: var(--text-sub); margin-bottom: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .widget-val { font-size: 28px; font-weight: 800; color: var(--text-main); }
        .widget-chart-con { flex: 1; position: relative; min-height: 100px; }

        /* Tool Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding-bottom: 80px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* Cards */
        .card {
            border-radius: 16px; padding: 20px;
            cursor: pointer; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; gap: 12px; position: relative;
            border: 1px solid transparent;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-glow); box-shadow: 0 10px 25px -5px var(--primary-glow); }
        
        .card-icon-box {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--glass-bg));
            border: 1px solid var(--glass-border);
            color: var(--primary);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
        }
        .card-title { font-weight: bold; font-size: 16px; }
        .card-desc { font-size: 13px; color: var(--text-sub); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .fav-btn {
            position: absolute; top: 15px; right: 15px;
            color: var(--text-sub); opacity: 0.3; transition: 0.2s;
        }
        .fav-btn:hover, .fav-btn.active { color: var(--accent); opacity: 1; transform: scale(1.1); }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; }
        .modal-box {
            width: 95%; max-width: 800px; max-height: 90vh;
            border-radius: 20px; display: flex; flex-direction: column;
            transform: scale(0.95); transition: 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            overflow: hidden; background: var(--glass-bg);
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .modal-header {
            padding: 15px 25px; border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 18px;
            background: rgba(var(--primary), 0.05);
        }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }

        /* UI Components */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 20px;
            border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 8px 15px; font-size: 13px; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(59, 130, 246, 0.1); }
        .btn-group { display: flex; gap: 10px; }

        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--glass-border);
            border-radius: 10px; margin-bottom: 15px; font-size: 14px;
            background: rgba(255,255,255,0.6); color: var(--text-main);
            transition: 0.2s;
        }
        body.dark input, body.dark textarea, body.dark select { background: rgba(0,0,0,0.3); }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-glow); background: var(--glass-bg); }

        .result-area {
            background: rgba(16, 185, 129, 0.08); border: 1px dashed var(--success);
            padding: 15px; border-radius: 10px; margin-top: 15px;
            text-align: center; font-weight: bold; color: var(--success);
            word-break: break-all;
        }

        /* Tool Specific Styles */
        .calc-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; 
        }
        .calc-btn { 
            aspect-ratio: 1.3; font-size: 18px; border-radius: 12px; border:none; cursor:pointer; 
            transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: 500;
            background: rgba(255,255,255,0.6); color: var(--text-main);
        }
        body.dark .calc-btn { background: rgba(255,255,255,0.1); }
        .calc-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .calc-btn:active { transform: translateY(0); }
        
        .calc-btn.op { color: white; background: var(--primary); font-weight:bold; }
        .calc-btn.fn { color: var(--accent); background: rgba(236,72,153,0.1); font-size: 14px; font-weight: bold; }
        .calc-btn.eq { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; grid-column: span 1; }
        .calc-btn.num { font-weight: bold; font-size: 20px; }
        
        .calc-disp { 
            grid-column: span 5; background: rgba(0,0,0,0.05); text-align: right; 
            padding: 20px; font-size: 32px; border-radius: 12px; margin-bottom: 15px; 
            font-family: monospace; overflow-x: auto; white-space: nowrap;
        }

        .img-editor-container { max-height: 500px; background: #333; overflow: hidden; display: flex; justify-content: center; align-items: center; border-radius: 8px; }
        #cropper-img { max-width: 100%; max-height: 450px; }

        .todo-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 5px; }
        .todo-check { cursor: pointer; color: var(--text-sub); font-size: 18px; }
        .todo-check.done { color: var(--success); }
        .todo-text { flex: 1; }
        .todo-text.done { text-decoration: line-through; opacity: 0.5; }
        
        #md-preview { border: 1px solid var(--glass-border); padding: 15px; border-radius: 8px; background: rgba(255,255,255,0.2); min-height: 100px; margin-top: 10px; }

        /* Chat UI */
        .chat-box { height: 300px; overflow-y: auto; border: 1px solid var(--glass-border); border-radius: 10px; padding: 15px; margin-bottom: 10px; background: rgba(0,0,0,0.05); }
        .chat-msg { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; }
        .chat-msg.user { background: var(--primary); color: white; margin-left: auto; }
        .chat-msg.ai { background: var(--glass-bg); color: var(--text-main); margin-right: auto; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: auto; padding: 10px 20px; flex-direction: row; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--glass-border); border-right: none; position: sticky; top:0; background: var(--glass-bg); z-index: 100; }
            .nav-menu { display: none; position: absolute; top: 60px; left: 0; right: 0; background: var(--glass-bg); padding: 20px; border-bottom: 1px solid var(--glass-border); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
            .nav-menu.active { display: flex; }
            .header { padding: 15px 20px; }
            .search-container { width: 100%; }
            .content { padding: 20px; }
            #mobile-toggle { display: block; font-size: 20px; color: var(--text-main); }
            .calc-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; }
            .calc-btn { aspect-ratio: 1.1; font-size: 16px; }
            .calc-btn.fn { font-size: 12px; }
            .calc-disp { grid-column: span 4; font-size: 28px; padding: 15px; }
            /* „Çπ„Éû„Éõ„Åß‰∏ÄÈÉ®„ÅÆÈ´òÂ∫¶„Å™Èñ¢Êï∞„ÇíÈö†„Åô„Å™„Å©„ÅÆË™øÊï¥„ÇÇÂèØ„Å†„Åå‰ªäÂõû„ÅØÂÖ®Ë°®Á§∫ */
        }
        @media (min-width: 769px) { #mobile-toggle { display: none; } }
    </style>
</head>
<body>

    <!-- Tool Modal -->
    <div id="tool-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span id="tm-title"><i class="fas fa-tools"></i> Tool Name</span>
                <span style="cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:rgba(128,128,128,0.1);" onclick="closeModal()">√ó</span>
            </div>
            <div class="modal-body">
                <p id="tm-desc" style="color:var(--text-sub); margin-bottom:20px; font-size:14px;"></p>
                <div id="tm-ui"></div>
                <div id="tm-result" class="result-area" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar glass">
        <div class="logo">
            <i class="fas fa-layer-group"></i> 
            <span>LifeStation</span>
            <span class="version-badge">V7</span>
            <i id="mobile-toggle" class="fas fa-bars" onclick="toggleMenu()" style="margin-left:auto;"></i>
        </div>
        
        <div class="nav-menu" id="nav-menu">
            <div class="menu-item active" onclick="filter('all')"><i class="fas fa-th-large"></i> „Éõ„Éº„É† <span class="menu-count" id="c-all">0</span></div>
            <div class="menu-item" onclick="filter('fav')"><i class="fas fa-star" style="color:var(--accent)"></i> „ÅäÊ∞ó„Å´ÂÖ•„Çä <span class="menu-count" id="c-fav">0</span></div>
            <div class="menu-item" onclick="filter('work')"><i class="fas fa-briefcase"></i> ‰ªï‰∫ã„ÉªÂäπÁéáÂåñ <span class="menu-count" id="c-work">0</span></div>
            <div class="menu-item" onclick="filter('calc')"><i class="fas fa-calculator"></i> Ë®àÁÆó„ÉªÂàÜÊûê <span class="menu-count" id="c-calc">0</span></div>
            <div class="menu-item" onclick="filter('image')"><i class="fas fa-image"></i> ÁîªÂÉèÂá¶ÁêÜ <span class="menu-count" id="c-image">0</span></div>
            <div class="menu-item" onclick="filter('text')"><i class="fas fa-font"></i> „ÉÜ„Ç≠„Çπ„Éà„ÉªAI <span class="menu-count" id="c-text">0</span></div>
            
            <div style="margin-top:auto; padding-top:10px; border-top:1px solid var(--glass-border); display:flex; justify-content:space-between; font-size:18px;">
                <i class="fas fa-moon" onclick="toggleTheme()" style="cursor:pointer; color:var(--text-sub);" title="„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø"></i>
                <i class="fas fa-file-export" onclick="exportData()" style="cursor:pointer; color:var(--text-sub);" title="„Éá„Éº„Çø‰øùÂ≠ò"></i>
                <i class="fas fa-trash-alt" onclick="clearData()" style="cursor:pointer; color:var(--danger);" title="„Éá„Éº„ÇøÂàùÊúüÂåñ"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <header class="header glass">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="„ÉÑ„Éº„É´„ÇíÊ§úÁ¥¢ (Ctrl+K)..." id="search-box" oninput="searchTools(this.value)">
            </div>
            <div style="font-size:12px; color:var(--text-sub); text-align:right;">
                <div id="clock" style="font-weight:bold; font-size:16px; color:var(--text-main);">00:00</div>
                <div id="date">Loading...</div>
            </div>
        </header>

        <div class="content">
            <!-- Widgets Dashboard -->
            <div class="dashboard-grid">
                <div class="widget glass">
                    <div class="widget-title"><i class="fas fa-sun"></i> Weather (Tokyo)<span id="w-loc" style="font-size:10px;"></span></div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i id="w-icon" class="fas fa-cloud" style="font-size:32px; color:var(--primary);"></i>
                        <div>
                            <div class="widget-val" id="w-temp">--¬∞C</div>
                            <div style="font-size:12px; color:var(--text-sub);" id="w-desc">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <div class="widget glass">
                    <div class="widget-title"><i class="fas fa-tasks"></i> Today's Tasks <span id="w-todo-cnt">0/0</span></div>
                    <div style="margin-top:5px; flex:1; overflow-y:auto; font-size:13px;" id="w-todo-list">
                        <!-- Tasks -->
                    </div>
                    <div style="height:4px; background:rgba(0,0,0,0.1); border-radius:2px; margin-top:10px; overflow:hidden;">
                        <div id="w-todo-bar" style="height:100%; width:0%; background:var(--success); transition:0.5s;"></div>
                    </div>
                </div>

                <div class="widget glass">
                    <div class="widget-title"><i class="fas fa-chart-bar"></i> Weekly Focus <span style="font-size:10px;">(min)</span></div>
                    <div class="widget-chart-con">
                        <canvas id="w-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="grid" class="grid">
                <!-- Cards will be injected here -->
            </div>
            
            <div style="text-align:center; margin-top:50px; color:var(--text-sub); font-size:12px;">
                LifeStation V7 Zenith - Ultimate Web Workspace
            </div>
        </div>
    </main>

    <script>
        // ============================================
        //  APP STATE & CONFIG
        // ============================================
        const STORE_KEY = 'lifestation_v7_data';
        let appData = {
            favs: [],
            todos: [],
            memo: '',
            theme: 'light',
            pomoLogs: [], // {date: '2023-10-01', min: 25}
            clips: [], // ÂÆöÂûãÊñá
            apiKey: '' // AI API Key
        };
        let activeTool = null;
        let pInterval = null;
        let swInterval = null;
        let cropper = null;
        let audioCtx = null; // Zen Audio
        let mediaRecorder = null; // Recorder
        let audioChunks = [];

        // ============================================
        //  TOOLS DEFINITION
        // ============================================
        const tools = [
            // --- WORK (‰ªï‰∫ã„ÉªÂäπÁéáÂåñ) ---
            {
                id: 'todo', cat: 'work', icon: 'fa-check-double', title: 'ToDo„É™„Çπ„Éà', desc: '„Éâ„É©„ÉÉ„Ç∞ÁßªÂãïÂèØËÉΩ„Å™„Çø„Çπ„ÇØÁÆ°ÁêÜ',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="td-in" placeholder="Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ..." onkeypress="if(event.key==='Enter')addTodo()" style="margin:0;">
                            <button class="btn" style="width:auto;" onclick="addTodo()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="td-list" style="margin-top:15px; max-height:400px; overflow-y:auto;"></div>
                    `;
                    renderTodos();
                }
            },
            {
                id: 'memo', cat: 'work', icon: 'fa-sticky-note', title: 'Markdown„É°„É¢', desc: '„Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ‰ªò„ÅçÈ´òÊ©üËÉΩ„É°„É¢',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; height:400px;">
                            <textarea id="memo-pad" style="resize:none; height:100%;" placeholder="# Markdown„Åå‰Ωø„Åà„Åæ„Åô" oninput="updateMemo()">${appData.memo || ''}</textarea>
                            <div id="md-preview" style="height:100%; overflow-y:auto;"></div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn btn-outline" onclick="downloadMemo()"><i class="fas fa-download"></i> .md‰øùÂ≠ò</button>
                            <button class="btn btn-outline" onclick="copyMemo()"><i class="fas fa-copy"></i> „Ç≥„Éî„Éº</button>
                        </div>
                    `;
                    updateMemo();
                }
            },
            {
                id: 'pomo', cat: 'work', icon: 'fa-clock', title: '„Éù„É¢„Éâ„Éº„É≠', desc: 'ÈõÜ‰∏≠ÂäõÁ∂≠ÊåÅÔºÜ„É≠„Ç∞ÂàÜÊûê',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="text-align:center;">
                            <div id="pm-disp" style="font-size:72px; font-weight:800; font-family:monospace; color:var(--primary); margin:30px 0;">25:00</div>
                            <div style="display:flex; justify-content:center; gap:10px;">
                                <button class="btn" onclick="startPomo(25)">ÈõÜ‰∏≠ (25ÂàÜ)</button>
                                <button class="btn" style="background:var(--success)" onclick="startPomo(5)">‰ºëÊÜ© (5ÂàÜ)</button>
                                <button class="btn" style="background:var(--danger); width:auto;" onclick="stopPomo()"><i class="fas fa-stop"></i></button>
                            </div>
                            <div style="margin-top:20px; font-size:12px; color:var(--text-sub);">ÂÆå‰∫Ü„Åô„Çã„Å®„É≠„Ç∞„Å´Ë®òÈå≤„Åï„Çå„Åæ„Åô</div>
                        </div>
                    `;
                }
            },
            {
                id: 'zen', cat: 'work', icon: 'fa-headphones', title: 'Zen Generator', desc: 'ÈõÜ‰∏≠Áî®Áí∞Â¢ÉÈü≥ (Rain/WhiteNoise)',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="text-align:center; padding:20px;">
                            <div style="margin-bottom:20px;">
                                <i class="fas fa-cloud-rain" style="font-size:40px; color:var(--primary); margin:10px;"></i>
                                <i class="fas fa-wind" style="font-size:40px; color:var(--text-sub); margin:10px;"></i>
                            </div>
                            <button class="btn" id="zen-btn" onclick="toggleZen()">ÂÜçÁîüÈñãÂßã (Pink Noise)</button>
                            <p style="font-size:12px; margin-top:10px; color:var(--text-sub);">‚ÄªWeb Audio API„ÅßÁîüÊàê„Åï„Çå„Çã„Éé„Ç§„Ç∫„Åß„Åô</p>
                        </div>
                    `;
                }
            },
            {
                id: 'clip', cat: 'work', icon: 'fa-clipboard-list', title: 'ÂÆöÂûãÊñáÁÆ°ÁêÜ', desc: '„ÇØ„É™„ÉÉ„Éó„Éú„Éº„ÉâÂ±•Ê≠¥ & ÂÆöÂûãÊñá',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" id="cl-in" placeholder="ÂÆöÂûãÊñá„ÇíËøΩÂä†..." style="margin:0;">
                            <button class="btn" style="width:auto;" onclick="addClip()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="cl-list" style="max-height:300px; overflow-y:auto;"></div>
                    `;
                    renderClips();
                }
            },

            // --- CALC (Ë®àÁÆó„ÉªÂàÜÊûê) ---
            {
                id: 'calc', cat: 'calc', icon: 'fa-calculator', title: 'Èñ¢Êï∞ÈõªÂçì', desc: 'ÁßëÂ≠¶ÊäÄË°ìË®àÁÆó„Éª„É¢„ÉÄ„É≥„Éá„Ç∂„Ç§„É≥',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div class="calc-disp" id="c-disp">0</div>
                        <div class="calc-grid">
                            <button class="calc-btn fn" onclick="cIn('Math.sin(')">sin</button>
                            <button class="calc-btn fn" onclick="cIn('Math.cos(')">cos</button>
                            <button class="calc-btn fn" onclick="cIn('Math.tan(')">tan</button>
                            <button class="calc-btn fn" onclick="cIn('Math.PI')">œÄ</button>
                            <button class="calc-btn op" style="background:var(--danger)" onclick="cIn('C')">AC</button>
                            
                            <button class="calc-btn fn" onclick="cIn('Math.sqrt(')">‚àö</button>
                            <button class="calc-btn fn" onclick="cIn('(')">(</button>
                            <button class="calc-btn fn" onclick="cIn(')')">)</button>
                            <button class="calc-btn fn" onclick="cIn('**')">^</button>
                            <button class="calc-btn op" onclick="cIn('/')">√∑</button>
                            
                            <button class="calc-btn num" onclick="cIn('7')">7</button>
                            <button class="calc-btn num" onclick="cIn('8')">8</button>
                            <button class="calc-btn num" onclick="cIn('9')">9</button>
                            <button class="calc-btn op" style="background:var(--text-sub)" onclick="cIn('Del')">‚å´</button>
                            <button class="calc-btn op" onclick="cIn('*')">√ó</button>
                            
                            <button class="calc-btn num" onclick="cIn('4')">4</button>
                            <button class="calc-btn num" onclick="cIn('5')">5</button>
                            <button class="calc-btn num" onclick="cIn('6')">6</button>
                            <button class="calc-btn op" onclick="cIn('-')">-</button>
                            <button class="calc-btn op" onclick="cIn('%')">%</button>
                            
                            <button class="calc-btn num" onclick="cIn('1')">1</button>
                            <button class="calc-btn num" onclick="cIn('2')">2</button>
                            <button class="calc-btn num" onclick="cIn('3')">3</button>
                            <button class="calc-btn op" onclick="cIn('+')">+</button>
                            <button class="calc-btn eq" onclick="cIn('=')">=</button>
                            
                            <button class="calc-btn num" onclick="cIn('0')" style="grid-column:span 2;">0</button>
                            <button class="calc-btn num" onclick="cIn('.')">.</button>
                        </div>
                    `;
                    setupCalcKeys();
                }
            },
            {
                id: 'warikan', cat: 'calc', icon: 'fa-users', title: 'Ââ≤„ÇäÂãòÂ•âË°å', desc: 'È£≤„Åø‰ºö„ÉªÊóÖË°å„Å´ÔºÅ„Çπ„Éû„Éº„ÉàÂâ≤„ÇäÂãò',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="display:flex; flex-direction:column; gap:15px;">
                            <div style="display:flex; gap:10px;">
                                <div style="flex:1;"><label style="font-size:12px; color:var(--text-sub);">ÂêàË®àÈáëÈ°ç (ÂÜÜ)</label><input type="number" id="w-total" placeholder="12300" style="margin:0;"></div>
                                <div style="width:100px;"><label style="font-size:12px; color:var(--text-sub);">‰∫∫Êï∞</label><input type="number" id="w-num" placeholder="3" style="margin:0;"></div>
                            </div>
                            
                            <div style="background:rgba(0,0,0,0.03); padding:10px; border-radius:10px;">
                                <div style="font-size:12px; color:var(--text-sub); margin-bottom:5px;">Ë™øÊï¥„Ç™„Éó„Ç∑„Éß„É≥</div>
                                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                                    <label style="font-size:13px;"><input type="checkbox" id="w-boss-check"> ÁâπÂÆö„ÅÆ‰∫∫„ÅåÂ§ö„ÇÅ„Å´Êâï„ÅÜ</label>
                                    <input type="number" id="w-boss-pay" placeholder="ÊîØÊâïÈ°ç" style="width:100px; margin:0; display:none;">
                                </div>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <span style="font-size:13px;">Âçò‰Ωç:</span>
                                    <select id="w-unit" style="margin:0; width:auto; padding:5px;">
                                        <option value="1">1ÂÜÜ</option>
                                        <option value="10">10ÂÜÜ</option>
                                        <option value="100" selected>100ÂÜÜ</option>
                                        <option value="500">500ÂÜÜ</option>
                                        <option value="1000">1000ÂÜÜ</option>
                                    </select>
                                    <span style="font-size:12px; color:var(--text-sub);">„ÅßÂàá„Çä‰∏ä„Åí</span>
                                </div>
                            </div>

                            <button class="btn" onclick="calcWarikan()">Ë®àÁÆó„Åô„Çã</button>
                            
                            <div id="w-result" class="result-area" style="display:none; text-align:left; line-height:1.6;"></div>
                        </div>
                    `;
                    // Checkbox logic
                    document.getElementById('w-boss-check').onchange = (e) => {
                        document.getElementById('w-boss-pay').style.display = e.target.checked ? 'block' : 'none';
                    };
                    // Calculation Logic embedded for simplicity in tool definition
                    window.calcWarikan = () => {
                        const total = parseInt(document.getElementById('w-total').value);
                        const num = parseInt(document.getElementById('w-num').value);
                        const unit = parseInt(document.getElementById('w-unit').value);
                        const isBoss = document.getElementById('w-boss-check').checked;
                        const bossPay = isBoss ? parseInt(document.getElementById('w-boss-pay').value) : 0;
                        
                        if(!total || !num) { alert('ÈáëÈ°ç„Å®‰∫∫Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                        
                        const resDiv = document.getElementById('w-result');
                        resDiv.style.display = 'block';
                        
                        let restTotal = total;
                        let regularNum = num;
                        let msg = '';
                        
                        if(isBoss) {
                            if(!bossPay) { alert('Â§ö„ÇÅ„Å´Êâï„ÅÜÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                            restTotal -= bossPay;
                            regularNum -= 1;
                            msg += `üëë <strong>Â§ö„ÇÅ„Å´Êâï„ÅÜ‰∫∫ (1Âêç):</strong> ${bossPay.toLocaleString()}ÂÜÜ<br>`;
                        }
                        
                        if(regularNum > 0) {
                            const perPersonRaw = restTotal / regularNum;
                            // Âàá„Çä‰∏ä„ÅíË®àÁÆó
                            const perPerson = Math.ceil(perPersonRaw / unit) * unit;
                            const payTotal = (isBoss ? bossPay : 0) + (perPerson * regularNum);
                            const pool = payTotal - total;
                            
                            msg += `üë§ <strong>‰∏Ä‰∫∫„ÅÇ„Åü„Çä (${regularNum}Âêç):</strong> ${perPerson.toLocaleString()}ÂÜÜ<br>`;
                            msg += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--success);">`;
                            msg += `üí∞ <strong>ÊîØÊâïÁ∑èÈ°ç:</strong> ${payTotal.toLocaleString()}ÂÜÜ<br>`;
                            if(pool > 0) msg += `üéÅ <strong>‰Ωô„Çä („Éó„Éº„É´Èáë):</strong> ${pool.toLocaleString()}ÂÜÜ`;
                            else if(pool < 0) msg += `‚ö†Ô∏è <strong>‰∏çË∂≥:</strong> ${Math.abs(pool).toLocaleString()}ÂÜÜ`;
                            else msg += `‚ú® <strong>„Å¥„Å£„Åü„ÇäÔºÅ</strong>`;
                        }
                        
                        resDiv.innerHTML = msg;
                    };
                }
            },
            {
                id: 'plotter', cat: 'calc', icon: 'fa-chart-line', title: '„Ç∞„É©„Éï„Éó„É≠„ÉÉ„Çø„Éº', desc: 'Êï∞Âºè„ÇíÂÖ•Âäõ„Åó„Å¶„Ç∞„É©„Éï„ÇíÊèèÁîª',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" id="plt-eq" placeholder="‰æã: Math.sin(x) * x" value="Math.sin(x)" style="margin:0;">
                            <button class="btn" style="width:auto;" onclick="drawGraph()">ÊèèÁîª</button>
                        </div>
                        <div style="height:300px; width:100%;">
                            <canvas id="plotCanvas"></canvas>
                        </div>
                    `;
                    setTimeout(drawGraph, 100);
                }
            },
            { id: 'discount', cat: 'calc', icon: 'fa-tags', title: 'Ââ≤ÂºïË®àÁÆó', desc: 'Á®éËæº‰æ°Ê†º„Å®Ââ≤ÂºïÈ°ç„ÇíÂç≥Â∫ß„Å´Ë®àÁÆó', inputs: ['price:ÂÖÉ„ÅÆ‰æ°Ê†º(ÂÜÜ)', 'per:Ââ≤ÂºïÁéá(%)'], func: (p,r) => { const end=Math.floor(p*(1-r/100)); return `ÊîØÊâïÈ°ç: ${end.toLocaleString()}ÂÜÜ<br><span style="font-size:12px;color:gray">(${p*r/100}ÂÜÜ „ÅäÂæó)</span>`; } },
            { id: 'unit', cat: 'calc', icon: 'fa-balance-scale', title: 'Âçò‰ΩçÂ§âÊèõPro', desc: 'Èï∑„Åï/Èáç„Åï/Ê∏©Â∫¶/Èù¢Á©ç/ÈÄüÂ∫¶/„Éá„Éº„Çø', type:'custom', render:(el)=>{
                el.innerHTML=`
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <select id="u-cat" onchange="updateUnitType()"><option value="len">Èï∑„Åï</option><option value="wgt">Èáç„Åï</option><option value="tmp">Ê∏©Â∫¶</option><option value="area">Èù¢Á©ç</option><option value="spd">ÈÄüÂ∫¶</option></select>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" id="u-val" placeholder="ÂÄ§" style="margin:0;">
                            <select id="u-from" style="margin:0;"></select>
                            <i class="fas fa-arrow-right"></i>
                            <select id="u-to" style="margin:0;"></select>
                        </div>
                        <button class="btn" onclick="convertUnitPro()">Â§âÊèõ</button>
                    </div>
                `;
                updateUnitType();
            }},

            // --- IMAGE / MEDIA ---
            {
                id: 'recorder', cat: 'image', icon: 'fa-microphone', title: '„É¨„Ç≥„Éº„ÉÄ„Éº', desc: 'Èü≥Â£∞/ÁîªÈù¢Èå≤Áîª & „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
                            <button class="btn" onclick="startRecord('audio')"><i class="fas fa-microphone"></i> Èå≤Èü≥</button>
                            <button class="btn" style="background:var(--accent);" onclick="startRecord('screen')"><i class="fas fa-desktop"></i> ÁîªÈù¢Èå≤Áîª</button>
                        </div>
                        <div id="rec-status" style="text-align:center; display:none;">
                            <div style="color:var(--danger); animation:pulse 1s infinite;">‚óè Recording...</div>
                            <button class="btn" style="background:var(--danger); margin-top:10px;" onclick="stopRecord()">ÂÅúÊ≠¢ & ‰øùÂ≠ò</button>
                        </div>
                    `;
                }
            },
            {
                id: 'img-editor', cat: 'image', icon: 'fa-crop-alt', title: 'ÁîªÂÉè„Ç®„Éá„Ç£„Çø', desc: '„Éà„É™„Éü„É≥„Ç∞„ÉªÂõûËª¢„Éª„Éï„Ç£„É´„Çø„Éª‰øùÂ≠ò',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <input type="file" id="img-in" accept="image/*" onchange="initCropper(this)">
                        <div class="img-editor-container" id="crop-container" style="display:none;">
                            <img id="cropper-img" src="">
                        </div>
                        <div id="editor-controls" style="display:none; margin-top:10px;">
                            <div class="btn-group" style="margin-bottom:10px; flex-wrap:wrap;">
                                <button class="btn btn-sm btn-outline" onclick="cropper.rotate(-90)"><i class="fas fa-undo"></i></button>
                                <button class="btn btn-sm btn-outline" onclick="cropper.rotate(90)"><i class="fas fa-redo"></i></button>
                                <button class="btn btn-sm btn-outline" onclick="cropper.reset()">Reset</button>
                            </div>
                            <button class="btn" onclick="exportCroppedImage()"><i class="fas fa-file-export"></i> ‰øùÂ≠ò</button>
                        </div>
                    `;
                }
            },
            { id: 'qrcode', cat: 'image', icon: 'fa-qrcode', title: 'QR‰ΩúÊàê', desc: '„ÉÜ„Ç≠„Çπ„Éà„ÇÑURL„Åã„ÇâQR„Ç≥„Éº„Éâ„ÇíÁîüÊàê', inputs:['text:ÂÜÖÂÆπ'], type:'qr' },

            // --- TEXT / AI ---
            {
                id: 'ai-chat', cat: 'text', icon: 'fa-robot', title: 'AI Assistant', desc: 'OpenAI APIÁ≠â„Çí‰ΩøÁî®„Åó„Åü„ÉÅ„É£„ÉÉ„Éà',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <input type="password" id="ai-key" placeholder="OpenAI API Key (sk-...)" value="${appData.apiKey||''}" onchange="saveApiKey(this.value)" style="font-size:12px;">
                        <div id="ai-log" class="chat-box"></div>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="ai-in" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏..." onkeypress="if(event.key==='Enter')sendAi()" style="margin:0;">
                            <button class="btn" style="width:auto;" onclick="sendAi()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    `;
                }
            },
            { id: 'regex', cat: 'text', icon: 'fa-search', title: 'Ê≠£Ë¶èË°®Áèæ„ÉÜ„Çπ„Éà', desc: '„É™„Ç¢„É´„Çø„Ç§„É†„Éû„ÉÉ„ÉÅ„É≥„Ç∞Á¢∫Ë™ç', type:'custom', render:(el)=>{
                el.innerHTML = `<input type="text" id="reg-pat" placeholder="/Pattern/flags" oninput="testRegex()">
                <textarea id="reg-txt" rows="4" placeholder="ÂØæË±°„ÉÜ„Ç≠„Çπ„Éà" oninput="testRegex()"></textarea>
                <div id="reg-res" class="result-area" style="text-align:left; white-space:pre-wrap;"></div>`;
            }},
            { id: 'char', cat: 'text', icon: 'fa-text-width', title: 'ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„Éà', desc: 'ÊñáÂ≠óÊï∞„ÄÅË°åÊï∞„ÄÅÂéüÁ®øÁî®Á¥ôÊûöÊï∞', type:'custom', render:(el)=>{
                el.innerHTML=`<textarea id="txt-c" rows="5" placeholder="„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ..." oninput="countChar()"></textarea><div id="txt-res" style="text-align:right; font-weight:bold;">0 ÊñáÂ≠ó</div>`;
            }},
            { id: 'share', cat: 'text', icon: 'fa-share-alt', title: 'WebÂÖ±Êúâ', desc: '„Çπ„Éû„ÉõÊ®ôÊ∫ñ„ÅÆÂÖ±Êúâ„É°„Éã„É•„Éº„ÇíÈñã„Åè', inputs:['url:URL', 'title:„Çø„Ç§„Éà„É´'], type:'async', func:async(u,t)=>{ if(navigator.share){ await navigator.share({title:t, url:u}); return 'ÂÖ±Êúâ„É°„Éã„É•„Éº„ÇíÈñã„Åç„Åæ„Åó„Åü'; } else return '„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈùûÂØæÂøú„Åß„Åô'; } },
        ];

        // ============================================
        //  INIT & CORE
        // ============================================
        window.onload = () => {
            loadData();
            updateTime();
            renderGrid(tools);
            updateCounts();
            initDashboard();
            
            document.addEventListener('keydown', (e) => {
                if(e.ctrlKey && e.key === 'k') { e.preventDefault(); document.getElementById('search-box').focus(); }
                if(e.key === 'Escape') closeModal();
            });

            setInterval(updateTime, 1000);
        };

        function loadData() {
            const d = localStorage.getItem(STORE_KEY);
            if(d) {
                appData = { ...appData, ...JSON.parse(d) }; // merge
                if(appData.theme === 'dark') document.body.classList.add('dark');
            }
        }
        function saveData() { localStorage.setItem(STORE_KEY, JSON.stringify(appData)); }
        function updateTime() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('date').innerText = now.toLocaleDateString('ja-JP', {month:'short', day:'numeric', weekday:'short'});
        }
        function exportData() {
            const b = new Blob([JSON.stringify(appData)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='lifestation_backup.json'; a.click();
        }

        // ============================================
        //  DASHBOARD
        // ============================================
        async function initDashboard() {
            // Weather (Open-Meteo API - Free, No Key) - Default Tokyo
            try {
                const lat=35.6895, lon=139.6917;
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const data = await res.json();
                const w = data.current_weather;
                document.getElementById('w-temp').innerText = `${w.temperature}¬∞C`;
                // Simple WMO Code mapping
                const code = w.weathercode;
                let icon = 'fa-cloud'; let desc = 'Cloudy';
                if(code===0) { icon='fa-sun'; desc='Sunny'; }
                else if(code<3) { icon='fa-cloud-sun'; desc='Partly Cloudy'; }
                else if(code<60) { icon='fa-smog'; desc='Foggy'; }
                else if(code<80) { icon='fa-cloud-rain'; desc='Rainy'; }
                else { icon='fa-bolt'; desc='Storm'; }
                document.getElementById('w-icon').className = `fas ${icon}`;
                document.getElementById('w-desc').innerText = desc;
            } catch(e) { document.getElementById('w-desc').innerText = 'Offline'; }

            // Tasks
            const todos = appData.todos;
            const done = todos.filter(t=>t.done).length;
            document.getElementById('w-todo-cnt').innerText = `${done}/${todos.length}`;
            document.getElementById('w-todo-bar').style.width = todos.length ? `${(done/todos.length)*100}%` : '0%';
            const list = document.getElementById('w-todo-list');
            list.innerHTML = todos.slice(0,3).map(t=>`<div style="margin-bottom:4px; ${t.done?'text-decoration:line-through;opacity:0.5':''}"><i class="fas fa-circle" style="font-size:6px; vertical-align:middle; margin-right:5px; color:var(--primary)"></i>${t.txt}</div>`).join('') || '<div style="color:var(--text-sub)">No tasks</div>';

            // Weekly Focus Chart
            const ctx = document.getElementById('w-chart').getContext('2d');
            // Get last 7 days stats
            const labels = [], data = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate()-i);
                const k = d.toISOString().slice(0,10);
                labels.push(d.toLocaleDateString('en', {weekday:'narrow'}));
                const dayLog = appData.pomoLogs.filter(l => l.date === k).reduce((a,b)=>a+b.min, 0);
                data.push(dayLog);
            }
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Focus (min)', data: data, backgroundColor: '#6366f1', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{display:false}, x:{grid:{display:false}}} }
            });
        }

        // ============================================
        //  UI LOGIC & TOOLS
        // ============================================
        function renderGrid(list) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            list.forEach(t => {
                const isFav = appData.favs.includes(t.id);
                const div = document.createElement('div');
                div.className = 'card glass';
                div.innerHTML = `
                    <i class="fas fa-star fav-btn ${isFav?'active':''}" onclick="toggleFav('${t.id}', event)"></i>
                    <div class="card-icon-box"><i class="fas ${t.icon}"></i></div>
                    <div>
                        <div class="card-title">${t.title}</div>
                        <div class="card-desc">${t.desc}</div>
                    </div>
                `;
                div.onclick = () => openTool(t);
                grid.appendChild(div);
            });
        }
        function filter(cat) {
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(window.innerWidth <= 768) toggleMenu();
            if(cat === 'all') renderGrid(tools);
            else if(cat === 'fav') renderGrid(tools.filter(t => appData.favs.includes(t.id)));
            else renderGrid(tools.filter(t => t.cat === cat));
        }
        function searchTools(q) {
            q = q.toLowerCase();
            renderGrid(tools.filter(t => t.title.toLowerCase().includes(q) || t.desc.toLowerCase().includes(q)));
        }
        function toggleFav(id, e) {
            e.stopPropagation();
            if(appData.favs.includes(id)) appData.favs = appData.favs.filter(i => i !== id);
            else appData.favs.push(id);
            saveData();
            e.target.classList.toggle('active');
            updateCounts(); // Note: updateCounts function missing in V6, added below
        }
        function updateCounts() {
            ['work','calc','image','text'].forEach(c => { try{ document.getElementById('c-'+c).innerText = tools.filter(t => t.cat === c).length }catch(e){} });
            document.getElementById('c-all').innerText = tools.length;
            document.getElementById('c-fav').innerText = appData.favs.length;
        }
        function toggleTheme() {
            document.body.classList.toggle('dark');
            appData.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            saveData();
        }
        function clearData() { if(confirm('ÂàùÊúüÂåñ„Åó„Åæ„Åô„ÅãÔºü')) { localStorage.removeItem(STORE_KEY); location.reload(); } }
        function toggleMenu() { document.getElementById('nav-menu').classList.toggle('active'); }

        // Tool Execution
        function openTool(tool) {
            activeTool = tool;
            document.getElementById('tm-title').innerHTML = `<i class="fas ${tool.icon}"></i> ${tool.title}`;
            document.getElementById('tm-desc').innerText = tool.desc;
            const ui = document.getElementById('tm-ui');
            const res = document.getElementById('tm-result');
            ui.innerHTML = ''; res.style.display = 'none'; res.innerHTML = '';
            
            if(tool.type === 'custom') {
                tool.render(ui);
            } else {
                if(tool.inputs) {
                    tool.inputs.forEach((inp, i) => {
                        const [key, ph] = inp.includes(':') ? inp.split(':') : ['v', inp];
                        ui.innerHTML += `<input type="text" id="in-${i}" placeholder="${ph}">`;
                    });
                }
                ui.innerHTML += `<button class="btn" onclick="execTool()">ÂÆüË°å</button>`;
            }
            const modal = document.getElementById('tool-modal');
            modal.style.display = 'flex';
            setTimeout(()=>modal.classList.add('show'), 10);
        }
        function closeModal() {
            const modal = document.getElementById('tool-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                if(cropper) { cropper.destroy(); cropper=null; }
                stopPomo();
                if(audioCtx) { audioCtx.close(); audioCtx=null; } // Stop Zen
                stopRecord();
            }, 200);
        }
        async function execTool() {
            const resBox = document.getElementById('tm-result');
            resBox.style.display = 'block';
            try {
                const args = [];
                if(activeTool.inputs) for(let i=0; i<activeTool.inputs.length; i++) args.push(document.getElementById(`in-${i}`).value);
                if(activeTool.type === 'qr') { resBox.innerHTML = ''; new QRCode(resBox, args[0]); }
                else if(activeTool.type === 'async') { resBox.innerHTML = 'Processing...'; resBox.innerHTML = await activeTool.func(...args); }
                else { resBox.innerHTML = activeTool.func(...args); }
            } catch(e) { resBox.innerText = 'Error'; }
        }

        // --- SPECIFIC TOOL FUNCTIONS ---

        // ToDo
        function addTodo() {
            const v = document.getElementById('td-in').value;
            if(!v) return;
            appData.todos.push({txt:v, done:false});
            saveData();
            document.getElementById('td-in').value = '';
            renderTodos();
            initDashboard(); // Update widget
        }
        function renderTodos() {
            const list = document.getElementById('td-list');
            list.innerHTML = '';
            appData.todos.forEach((t, i) => {
                const d = document.createElement('div');
                d.className = 'todo-item';
                d.innerHTML = `<i class="fas fa-check-circle todo-check ${t.done?'done':''}" onclick="togTodo(${i})"></i><span class="todo-text ${t.done?'done':''}" contenteditable="true" onblur="updTodo(${i}, this.innerText)">${t.txt}</span><i class="fas fa-times" style="color:var(--danger);cursor:pointer;" onclick="delTodo(${i})"></i>`;
                list.appendChild(d);
            });
            new Sortable(list, { onEnd: (e)=>{ const item = appData.todos.splice(e.oldIndex, 1)[0]; appData.todos.splice(e.newIndex, 0, item); saveData(); }});
        }
        function togTodo(i) { appData.todos[i].done = !appData.todos[i].done; saveData(); renderTodos(); initDashboard(); }
        function delTodo(i) { appData.todos.splice(i, 1); saveData(); renderTodos(); initDashboard(); }
        function updTodo(i, t) { appData.todos[i].txt = t; saveData(); }

        // Memo
        function updateMemo() { const txt = document.getElementById('memo-pad').value; document.getElementById('md-preview').innerHTML = marked.parse(txt); appData.memo = txt; saveData(); }
        function copyMemo() { navigator.clipboard.writeText(appData.memo); alert('Copied!'); }
        function downloadMemo() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([appData.memo], {type:'text/markdown'})); a.download = 'memo.md'; a.click(); }

        // Pomodoro
        function startPomo(min) {
            stopPomo();
            let s = min * 60;
            const d = document.getElementById('pm-disp');
            pInterval = setInterval(() => {
                s--;
                d.innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                if(s<=0) {
                    stopPomo();
                    new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                    alert('Time Up!');
                    // Log
                    appData.pomoLogs.push({date: new Date().toISOString().slice(0,10), min: min});
                    saveData();
                    initDashboard();
                }
            }, 1000);
        }
        function stopPomo() { if(pInterval) clearInterval(pInterval); }

        // Zen Generator (Pink Noise)
        function toggleZen() {
            if(audioCtx) { audioCtx.close(); audioCtx = null; document.getElementById('zen-btn').innerText = 'ÂÜçÁîüÈñãÂßã'; return; }
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const bufferSize = 4096;
            const pinkNoise = (function() {
                let b0, b1, b2, b3, b4, b5, b6;
                b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
                const node = audioCtx.createScriptProcessor(bufferSize, 1, 1);
                node.onaudioprocess = function(e) {
                    const output = e.outputBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        b0 = 0.99886 * b0 + white * 0.0555179;
                        b1 = 0.99332 * b1 + white * 0.0750759;
                        b2 = 0.96900 * b2 + white * 0.1538520;
                        b3 = 0.86650 * b3 + white * 0.3104856;
                        b4 = 0.55000 * b4 + white * 0.5329522;
                        b5 = -0.7616 * b5 - white * 0.0168980;
                        output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                        output[i] *= 0.11; // gain
                        b6 = white * 0.115926;
                    }
                };
                return node;
            })();
            pinkNoise.connect(audioCtx.destination);
            document.getElementById('zen-btn').innerText = 'ÂÅúÊ≠¢';
        }

        // Plotter
        function drawGraph() {
            const eq = document.getElementById('plt-eq').value;
            const labels = [], data = [];
            try {
                for(let x = -10; x <= 10; x += 0.5) {
                    labels.push(x.toFixed(1));
                    data.push(eval(eq.replace(/x/g, `(${x})`))); 
                }
                const ctx = document.getElementById('plotCanvas').getContext('2d');
                if(window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{ label: `f(x) = ${eq}`, data: data, borderColor: '#6366f1', tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch(e) { alert('Êï∞Âºè„Ç®„É©„Éº'); }
        }

        // Recorder
        async function startRecord(type) {
            try {
                const stream = type === 'screen' 
                    ? await navigator.mediaDevices.getDisplayMedia({video:true, audio:true})
                    : await navigator.mediaDevices.getUserMedia({audio:true});
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, {type: type==='screen'?'video/webm':'audio/webm'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `rec_${Date.now()}.webm`; a.click();
                    document.getElementById('rec-status').style.display = 'none';
                    stream.getTracks().forEach(t => t.stop());
                };
                mediaRecorder.start();
                document.getElementById('rec-status').style.display = 'block';
            } catch(e) { alert('Ê®©Èôê„ÅåÂøÖË¶Å„Åß„Åô'); }
        }
        function stopRecord() { if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); }

        // Clips
        function addClip() {
            const v = document.getElementById('cl-in').value;
            if(!v) return;
            appData.clips.push(v); saveData();
            document.getElementById('cl-in').value = '';
            renderClips();
        }
        function renderClips() {
            const l = document.getElementById('cl-list'); l.innerHTML = '';
            appData.clips.forEach((c, i) => {
                l.innerHTML += `<div class="todo-item" onclick="navigator.clipboard.writeText('${c}');alert('Copied!')" style="cursor:pointer;">
                    <div style="flex:1;">${c}</div><i class="fas fa-trash" style="color:var(--danger);" onclick="event.stopPropagation();appData.clips.splice(${i},1);saveData();renderClips();"></i>
                </div>`;
            });
        }

        // AI Chat (Mock Implementation for UI)
        function saveApiKey(k) { appData.apiKey = k; saveData(); }
        async function sendAi() {
            const msg = document.getElementById('ai-in').value;
            if(!msg) return;
            const log = document.getElementById('ai-log');
            log.innerHTML += `<div class="chat-msg user">${msg}</div>`;
            document.getElementById('ai-in').value = '';
            log.scrollTop = log.scrollHeight;

            if(!appData.apiKey) {
                log.innerHTML += `<div class="chat-msg ai">API Key„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>`;
                return;
            }

            // Simple OpenAI Call
            try {
                log.innerHTML += `<div class="chat-msg ai" id="ai-loading">...</div>`;
                const res = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appData.apiKey}` },
                    body: JSON.stringify({ model: "gpt-3.5-turbo", messages: [{role: "user", content: msg}] })
                });
                const data = await res.json();
                document.getElementById('ai-loading').remove();
                const reply = data.choices?.[0]?.message?.content || 'Error';
                log.innerHTML += `<div class="chat-msg ai">${reply}</div>`;
                log.scrollTop = log.scrollHeight;
            } catch(e) {
                document.getElementById('ai-loading').remove();
                log.innerHTML += `<div class="chat-msg ai">Error: ÈÄö‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>`;
            }
        }

        // Calc & Units & Cropper & Text Utils (Same as V6)
        let cExp = '';
        function setupCalcKeys() {
            document.onkeydown = (e) => {
                const k = e.key;
                if((k>='0'&&k<='9')||['+','-','*','/','.','(',')','%'].includes(k)) { e.preventDefault(); cIn(k); }
                else if(k==='Enter') { e.preventDefault(); cIn('='); }
                else if(k==='Backspace') { e.preventDefault(); cIn('Del'); }
                else if(k==='Escape') { e.preventDefault(); cIn('C'); }
            }
        }
        function cIn(v) {
            const d = document.getElementById('c-disp');
            if(v==='C') cExp = '';
            else if(v==='Del') cExp = cExp.slice(0,-1);
            else if(v==='=') { try { const res = new Function('return ' + cExp.replace(/Math\./g, 'Math.'))(); cExp = String(res); } catch { cExp = 'Error'; } }
            else cExp += v;
            d.innerText = cExp || '0';
        }
        const units = { len: { m:1, cm:100, mm:1000, km:0.001, inch:39.37, ft:3.28 }, wgt: { kg:1, g:1000, lb:2.204 }, tmp: { C:'C', F:'F' }, area: { m2:1, tsubo:0.3025 }, spd: { kmh:1, ms:0.277 } };
        function updateUnitType() {
            const t = document.getElementById('u-cat').value; const ks = Object.keys(units[t]);
            const mkOpt = (k) => `<option value="${k}">${k}</option>`;
            document.getElementById('u-from').innerHTML = ks.map(mkOpt).join(''); document.getElementById('u-to').innerHTML = ks.map(mkOpt).join('');
        }
        function convertUnitPro() {
            const t = document.getElementById('u-cat').value; const v = parseFloat(document.getElementById('u-val').value);
            const f = document.getElementById('u-from').value; const to = document.getElementById('u-to').value;
            if(isNaN(v)) return;
            let res = 0;
            if(t === 'tmp') { if(f==='C' && to==='F') res = v*1.8+32; else if(f==='F' && to==='C') res = (v-32)/1.8; else res = v; }
            else { res = (v / units[t][f]) * units[t][to]; }
            alert(`${v}${f} = ${res.toFixed(4)}${to}`);
        }
        function initCropper(input) {
            if(cropper) { cropper.destroy(); cropper=null; }
            if(!input.files[0]) return;
            const img = document.getElementById('cropper-img');
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; document.getElementById('crop-container').style.display='flex'; document.getElementById('editor-controls').style.display='block'; cropper = new Cropper(img, { viewMode: 1 }); };
            reader.readAsDataURL(input.files[0]);
        }
        function exportCroppedImage() { if(!cropper) return; cropper.getCroppedCanvas().toBlob(b => { const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'edited.png'; a.click(); }); }
        function countChar() { const t = document.getElementById('txt-c').value; document.getElementById('txt-res').innerText = `${t.length}Â≠ó`; }
        function testRegex() {
            const p = document.getElementById('reg-pat').value; const t = document.getElementById('reg-txt').value; const r = document.getElementById('reg-res');
            if(!p || !t) { r.innerText=''; return; }
            try { const parts = p.match(/^\/(.*?)\/([gimsuy]*)$/); const re = parts ? new RegExp(parts[1], parts[2]) : new RegExp(p); const m = t.match(re); r.innerText = m ? `Match:\n${JSON.stringify(m,null,2)}` : 'No Match'; } catch(e) { r.innerText = 'Invalid'; }
        }
    </script>
</body>
</html>
