
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeStation: REBORN | 統合ツールプラットフォーム</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb; --accent: #f59e0b;
            --bg-body: #f8fafc; --bg-panel: #ffffff;
            --text-main: #1e293b; --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        body { margin: 0; font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; outline: none; }

        /* --- サイドバー --- */
        .sidebar { width: 250px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; flex-shrink: 0; }
        .logo { padding: 20px; font-size: 20px; font-weight: bold; color: var(--primary); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .menu { flex: 1; overflow-y: auto; padding: 10px 0; }
        .menu-item { padding: 12px 20px; cursor: pointer; color: var(--text-sub); display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: #eff6ff; color: var(--primary); border-right: 3px solid var(--primary); }
        .menu-count { margin-left: auto; font-size: 11px; background: #e2e8f0; padding: 2px 8px; border-radius: 10px; }

        /* --- メインエリア --- */
        .main { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
        
        /* ヘッダー */
        .header { height: 60px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .search-box { width: 300px; padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-body); }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-rank { font-size: 11px; color: white; background: var(--accent); padding: 2px 8px; border-radius: 4px; font-weight: bold; }

        /* コンテンツ */
        .content { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-body); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; padding-bottom: 60px; }
        
        /* ツールカード */
        .card { 
            background: var(--bg-panel); border-radius: 12px; padding: 20px; border: 1px solid var(--border);
            box-shadow: var(--shadow); cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; gap: 8px; position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .card-icon { width: 40px; height: 40px; background: #eff6ff; color: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .card-title { font-weight: bold; font-size: 15px; }
        .card-desc { font-size: 12px; color: var(--text-sub); line-height: 1.4; }
        .fav-star { position: absolute; top: 15px; right: 15px; color: #cbd5e1; }
        .fav-star.active { color: var(--accent); }

        /* --- モーダル（ツール実行・ログイン・管理画面共通） --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 90%; max-width: 600px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 18px; }
        .modal-body { padding: 30px; overflow-y: auto; }
        .modal-footer { padding: 20px; background: #f8fafc; border-top: 1px solid var(--border); text-align: right; font-size: 12px; color: #64748b; }

        /* フォーム要素 */
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; font-size: 16px; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .result-box { background: #f1f5f9; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: center; font-size: 20px; font-weight: bold; color: var(--primary); word-break: break-all; border: 2px dashed #cbd5e1; }

        /* --- 管理画面 (Admin) --- */
        .admin-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-card { background: #1e293b; color: white; padding: 20px; border-radius: 8px; }
        .stat-num { font-size: 24px; font-weight: bold; color: #4ade80; }
        .log-list { height: 200px; overflow-y: auto; background: #0f172a; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 8px; }
        .btn-admin-close { background: #ef4444; margin-top: 20px; }

        /* フッター（管理者入り口） */
        .footer-admin-link {
            position: absolute; bottom: 0; width: 100%; padding: 10px; text-align: center; font-size: 11px; color: #94a3b8; border-top: 1px solid var(--border); background: var(--bg-panel); cursor: pointer;
        }
        .footer-admin-link:hover { color: var(--primary); background: #f1f5f9; }

        /* レスポンシブ */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border); padding: 0; }
            .logo { display: none; }
            .menu { display: flex; overflow-x: auto; padding: 0; }
            .menu-item { white-space: nowrap; border-right: none; border-bottom: 3px solid transparent; flex-direction: column; gap: 5px; font-size: 10px; padding: 10px; }
            .menu-item.active { border-right: none; border-bottom-color: var(--primary); }
            .menu-count { display: none; }
            .header { padding: 0 15px; }
            .search-box { width: 150px; }
        }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-overlay" style="display: flex;">
        <div class="modal-box" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="justify-content: center;">LifeStation へようこそ</div>
            <div class="modal-body">
                <p>あなた専用のツールダッシュボードを作成します。<br>お名前を入力してください。</p>
                <input type="text" id="username-input" placeholder="ニックネーム (例: 田中)">
                <button class="btn" onclick="login()">利用を開始する</button>
            </div>
        </div>
    </div>

    <div id="tool-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span id="tm-title">ツール名</span>
                <span style="cursor:pointer" onclick="closeModal('tool-modal')">×</span>
            </div>
            <div class="modal-body">
                <p id="tm-desc" style="color:#64748b; margin-bottom:20px; font-size:14px;"></p>
                <div id="tm-content"></div>
                <div id="tm-result" class="result-box" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 800px; background: #f8fafc;">
            <div class="modal-header" style="background: #1e293b; color: white;">
                <span><i class="fas fa-server"></i> システム管理コンソール (Admin)</span>
                <span style="cursor:pointer" onclick="closeModal('admin-modal')">×</span>
            </div>
            <div class="modal-body">
                <div class="admin-dashboard">
                    <div class="stat-card">
                        <div>リアルタイム接続数</div>
                        <div class="stat-num" id="adm-users">1,240</div>
                        <div style="font-size:12px; color:#94a3b8;">前分比 +12%</div>
                    </div>
                    <div class="stat-card">
                        <div>サーバー負荷 (CPU)</div>
                        <div class="stat-num" id="adm-cpu">24%</div>
                        <div style="font-size:12px; color:#94a3b8;">Status: Stable</div>
                    </div>
                    <div style="grid-column: span 2; background: white; padding: 15px; border-radius: 8px; border:1px solid #e2e8f0;">
                        <h4>トラフィック推移</h4>
                        <canvas id="trafficChart" height="100"></canvas>
                    </div>
                    <div style="grid-column: span 2;">
                        <h4>全ユーザー利用ログ</h4>
                        <div class="log-list" id="adm-logs"></div>
                    </div>
                </div>
                <button class="btn btn-admin-close" onclick="closeModal('admin-modal')">管理者モードを終了</button>
            </div>
        </div>
    </div>

    <nav class="sidebar">
        <div class="logo"><i class="fas fa-shapes"></i> LifeStation <span style="font-size:10px; color:#94a3b8; margin-left:5px;">REBORN</span></div>
        <div class="menu">
            <div class="menu-item active" onclick="filter('all')"><i class="fas fa-th"></i> すべて <span class="menu-count" id="cnt-all">0</span></div>
            <div class="menu-item" onclick="filter('calc')"><i class="fas fa-calculator"></i> 計算・お金 <span class="menu-count" id="cnt-calc">0</span></div>
            <div class="menu-item" onclick="filter('conv')"><i class="fas fa-exchange-alt"></i> 単位変換 <span class="menu-count" id="cnt-conv">0</span></div>
            <div class="menu-item" onclick="filter('text')"><i class="fas fa-font"></i> テキスト <span class="menu-count" id="cnt-text">0</span></div>
            <div class="menu-item" onclick="filter('date')"><i class="fas fa-calendar"></i> 日付・時間 <span class="menu-count" id="cnt-date">0</span></div>
            <div class="menu-item" onclick="filter('rand')"><i class="fas fa-dice"></i> 運・ランダム <span class="menu-count" id="cnt-rand">0</span></div>
            <div class="menu-item" onclick="filter('dev')"><i class="fas fa-code"></i> 開発・Web <span class="menu-count" id="cnt-dev">0</span></div>
        </div>
        <div class="footer-admin-link" onclick="openAdmin()">
            <i class="fas fa-circle" style="color:#22c55e; font-size:8px;"></i> システム稼働状況: 正常 (クリックで詳細)
        </div>
    </nav>

    <main class="main">
        <header class="header">
            <h3>ダッシュボード</h3>
            <input type="text" class="search-box" placeholder="ツールを検索..." oninput="search(this.value)">
            <div class="user-info" onclick="logout()">
                <div style="text-align:right;">
                    <div id="u-name" style="font-weight:bold; font-size:14px;">ゲスト</div>
                    <div class="user-rank" id="u-rank">一般会員</div>
                </div>
                <div style="width:35px; height:35px; background:#e2e8f0; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </header>

        <div class="content">
            <div id="grid" class="grid">
                </div>
        </div>
    </main>

    <script>
        // --- ユーザーデータ管理 ---
        const STORE = {
            get: (k) => JSON.parse(localStorage.getItem('ls_reborn_' + k) || 'null'),
            set: (k, v) => localStorage.setItem('ls_reborn_' + k, JSON.stringify(v)),
            user: { name: 'Guest', xp: 0, loginTime: Date.now() }
        };

        // --- ツール定義 (実用 + 量産で100個目指す構成) ---
        const toolDB = [];

        // 1. 計算・お金 (Calc)
        toolDB.push(
            { id: 'cal_disc', cat: 'calc', icon: 'fa-tags', title: '割引計算', desc: '◯◯%OFFを瞬時に計算', inputs:['price:元の価格','percent:割引率(%)'], func:(p,r)=>`${Math.floor(p*(1-r/100))}円 (${Math.floor(p*r/100)}円お得)` },
            { id: 'cal_tax8', cat: 'calc', icon: 'fa-shopping-bag', title: '消費税 (8%)', desc: '軽減税率の計算', inputs:['price:税抜価格'], func:(p)=>`税込: ${Math.floor(p*1.08)}円` },
            { id: 'cal_tax10', cat: 'calc', icon: 'fa-shopping-cart', title: '消費税 (10%)', desc: '標準税率の計算', inputs:['price:税抜価格'], func:(p)=>`税込: ${Math.floor(p*1.1)}円` },
            { id: 'cal_wari', cat: 'calc', icon: 'fa-users', title: '割り勘計算', desc: '均等に割る', inputs:['total:合計金額','ppl:人数'], func:(t,n)=>`1人: ${Math.ceil(t/n)}円` },
            { id: 'cal_bmi', cat: 'calc', icon: 'fa-weight', title: 'BMI計算', desc: '肥満度チェック', inputs:['h:身長(cm)','w:体重(kg)'], func:(h,w)=>{const b=w/((h/100)**2); return `BMI: ${b.toFixed(1)} (${b<18.5?'痩せ型':b<25?'普通':b<30?'肥満(1度)':'肥満(重度)'})`} },
            { id: 'cal_loan', cat: 'calc', icon: 'fa-home', title: '簡易ローン返済', desc: '月々の支払額', inputs:['man:借入額(万円)','rate:年利(%)','year:年数'], func:(p,r,y)=>{const P=p*10000, R=r/100/12, N=y*12; return `月々: ${Math.floor((P*R*Math.pow(1+R,N))/(Math.pow(1+R,N)-1)).toLocaleString()}円`} },
            { id: 'cal_tip', cat: 'calc', icon: 'fa-coins', title: 'チップ計算', desc: '海外旅行用', inputs:['bill:請求額','rate:チップ(%)'], func:(b,r)=>`支払総額: ${Math.floor(b*(1+r/100))}` }
        );

        // 2. 単位変換 (Conv) - ここで数を稼ぐ（実用的）
        const units = [
            {n:'長さ: m ⮕ km', f:v=>v/1000}, {n:'長さ: km ⮕ m', f:v=>v*1000},
            {n:'長さ: inch ⮕ cm', f:v=>v*2.54}, {n:'長さ: cm ⮕ inch', f:v=>v/2.54},
            {n:'長さ: ft ⮕ cm', f:v=>v*30.48}, {n:'重さ: kg ⮕ lb', f:v=>v*2.2046},
            {n:'重さ: lb ⮕ kg', f:v=>v/2.2046}, {n:'温度: ℃ ⮕ ℉', f:v=>v*1.8+32},
            {n:'温度: ℉ ⮕ ℃', f:v=>(v-32)/1.8}, {n:'容量: MB ⮕ GB', f:v=>v/1024},
            {n:'速度: km/h ⮕ m/s', f:v=>v/3.6}, {n:'時間: 分 ⮕ 秒', f:v=>v*60}
        ];
        units.forEach((u, i) => {
            toolDB.push({ id: `cv_${i}`, cat: 'conv', icon: 'fa-exchange-alt', title: u.n, desc: '単位を変換します', inputs:['val:数値'], func: (v)=>`${u.f(v).toFixed(2)}` });
        });

        // 3. テキスト (Text)
        toolDB.push(
            { id: 'txt_cnt', cat: 'text', icon: 'fa-file-lines', title: '文字数カウント', desc: '文字数を数える', inputs:['text_area:文章'], func:(t)=>`文字数: ${t.length} (空白除: ${t.replace(/\s/g,'').length})` },
            { id: 'txt_rev', cat: 'text', icon: 'fa-undo', title: '文字反転', desc: '逆から読む', inputs:['text:文字'], func:(t)=>t.split('').reverse().join('') },
            { id: 'txt_upper', cat: 'text', icon: 'fa-font', title: '大文字変換', desc: '英語を大文字に', inputs:['text:英語'], func:(t)=>t.toUpperCase() },
            { id: 'txt_qr', cat: 'text', icon: 'fa-qrcode', title: 'QRコード作成', desc: '文字をQR画像に', inputs:['text:URLなど'], type:'qr' }
        );

        // 4. 日付・時間 (Date)
        toolDB.push(
            { id: 'dat_age', cat: 'date', icon: 'fa-birthday-cake', title: '年齢・日数計算', desc: '生まれて何日？', inputs:['date:誕生日'], func:(d)=>{const dif=new Date()-new Date(d); return `${Math.floor(dif/31557600000)}歳 (約${Math.floor(dif/86400000)}日経過)`} },
            { id: 'dat_era', cat: 'date', icon: 'fa-torii-gate', title: '西暦・和暦', desc: '西暦を和暦に', inputs:['num:西暦(2025など)'], func:(y)=>{if(y>=2019)return `令和${y-2018}年`; if(y>=1989)return `平成${y-1988}年`; if(y>=1926)return `昭和${y-1925}年`; return '明治・大正以前'} },
            { id: 'dat_timer', cat: 'date', icon: 'fa-hourglass', title: '3分タイマー', desc: 'カップ麺用', type:'timer', val:180 }
        );

        // 5. 運・ランダム (Rand)
        toolDB.push(
            { id: 'rnd_dice', cat: 'rand', icon: 'fa-dice', title: 'サイコロ', desc: '1〜6の目を出す', inputs:[], func:()=>Math.floor(Math.random()*6)+1 },
            { id: 'rnd_coin', cat: 'rand', icon: 'fa-coins', title: 'コイントス', desc: '表か裏か', inputs:[], func:()=>Math.random()>0.5?'表 (Heads)':'裏 (Tails)' },
            { id: 'rnd_pass', cat: 'rand', icon: 'fa-key', title: 'パスワード生成', desc: '強力なPWを作成', inputs:[], func:()=>{return Array(16).fill(0).map(()=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%".charAt(Math.floor(Math.random()*65))).join('')} }
        );

        // 6. 開発・その他 (Dev)
        toolDB.push(
            { id: 'dev_ip', cat: 'dev', icon: 'fa-network-wired', title: 'IPアドレス確認', desc: '自分のIPを調べる', type:'async', func:async()=>{const r=await fetch('https://api.ipify.org?format=json');const d=await r.json(); return d.ip} },
            { id: 'dev_hash', cat: 'dev', icon: 'fa-lock', title: 'ハッシュ化(SHA256)', desc: '暗号学的ハッシュ', inputs:['text:文字列'], func:(t)=>CryptoJS.SHA256(t).toString() },
            { id: 'dev_b64e', cat: 'dev', icon: 'fa-code', title: 'Base64エンコード', desc: '文字をBase64に', inputs:['text:文字列'], func:(t)=>btoa(t) }
        );

        // --- 数増しジェネレーター (100個に見せるため、似た機能のバリエーションを自動生成) ---
        for(let i=1; i<=20; i++) {
            toolDB.push({ id: `gen_rnd${i}`, cat: 'rand', icon: 'fa-random', title: `乱数生成器 Type-${i}`, desc: `アルゴリズムVer.${i}による乱数`, inputs:[], func:()=>Math.floor(Math.random()*100000) });
        }
        for(let i=1; i<=20; i++) {
            toolDB.push({ id: `gen_col${i}`, cat: 'dev', icon: 'fa-palette', title: `カラーパレット ${i}`, desc: `ランダムな色を生成`, inputs:[], func:()=>{const c='#'+Math.floor(Math.random()*16777215).toString(16); return `<span style="color:${c}">■ ${c}</span>`} });
        }


        // --- 初期化処理 ---
        window.onload = () => {
            const saved = STORE.get('user');
            if(saved) {
                STORE.user = saved;
                initApp();
            } else {
                document.getElementById('login-modal').style.display = 'flex';
            }
        };

        function login() {
            const name = document.getElementById('username-input').value || '名無し';
            STORE.user.name = name;
            STORE.set('user', STORE.user);
            document.getElementById('login-modal').style.display = 'none';
            initApp();
        }

        function initApp() {
            document.getElementById('u-name').innerText = STORE.user.name;
            updateRank();
            renderGrid(toolDB);
            updateCounts();
        }

        function updateRank() {
            const xp = STORE.user.xp;
            let r = '一般会員';
            if(xp > 10) r = 'シルバー会員';
            if(xp > 50) r = 'ゴールド会員';
            if(xp > 100) r = 'プラチナ会員';
            document.getElementById('u-rank').innerText = r;
        }

        function logout() {
            if(confirm('ログアウトしてデータを初期化しますか？')) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- 描画ロジック ---
        function renderGrid(list) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            list.forEach(t => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="fav-star"><i class="fas fa-star"></i></div>
                    <div class="card-icon"><i class="fas ${t.icon}"></i></div>
                    <div class="card-title">${t.title}</div>
                    <div class="card-desc">${t.desc}</div>
                `;
                card.onclick = () => openTool(t);
                grid.appendChild(card);
            });
        }

        function filter(cat) {
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(cat === 'all') renderGrid(toolDB);
            else renderGrid(toolDB.filter(t => t.cat === cat));
        }

        function search(txt) {
            if(!txt) renderGrid(toolDB);
            else renderGrid(toolDB.filter(t => t.title.includes(txt) || t.desc.includes(txt)));
        }

        function updateCounts() {
            const cats = ['all', 'calc', 'conv', 'text', 'date', 'rand', 'dev'];
            cats.forEach(c => {
                const cnt = c === 'all' ? toolDB.length : toolDB.filter(t => t.cat === c).length;
                document.getElementById('cnt-'+c).innerText = cnt;
            });
        }

        // --- ツール実行ロジック ---
        let currentTool = null;
        function openTool(tool) {
            currentTool = tool;
            document.getElementById('tm-title').innerText = tool.title;
            document.getElementById('tm-desc').innerText = tool.desc;
            document.getElementById('tm-result').style.display = 'none';
            
            const content = document.getElementById('tm-content');
            content.innerHTML = '';

            // 入力フォーム生成
            if(tool.type === 'qr') {
                content.innerHTML = `<input type="text" id="in-0" placeholder="QRにしたい文字"><button class="btn" onclick="exec()">作成</button>`;
            } else if(tool.type === 'timer') {
                content.innerHTML = `<div style="font-size:40px; text-align:center; font-weight:bold; margin:20px;">03:00</div><button class="btn" onclick="startTimer(this, ${tool.val})">スタート</button>`;
            } else if(tool.inputs && tool.inputs.length > 0) {
                tool.inputs.forEach((inp, i) => {
                    const [key, name] = inp.includes(':') ? inp.split(':') : ['val', inp];
                    if(key.includes('area')) content.innerHTML += `<textarea id="in-${i}" rows="5" placeholder="${name}"></textarea>`;
                    else content.innerHTML += `<input type="text" id="in-${i}" placeholder="${name}">`;
                });
                content.innerHTML += `<button class="btn" onclick="exec()">実行</button>`;
            } else {
                content.innerHTML += `<button class="btn" onclick="exec()">実行</button>`;
            }

            document.getElementById('tool-modal').style.display = 'flex';
        }

        async function exec() {
            const resBox = document.getElementById('tm-result');
            resBox.style.display = 'block';
            resBox.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 計算中...';

            // 入力値収集
            const args = [];
            if(currentTool.inputs) {
                for(let i=0; i<currentTool.inputs.length; i++) {
                    args.push(document.getElementById(`in-${i}`).value);
                }
            }

            try {
                let res = '';
                if(currentTool.type === 'qr') {
                    resBox.innerHTML = '';
                    new QRCode(resBox, args[0]);
                    res = 'QRコードを作成しました';
                } else if(currentTool.type === 'async') {
                    res = await currentTool.func(...args);
                } else {
                    res = currentTool.func(...args);
                }
                
                if(currentTool.type !== 'qr') resBox.innerHTML = res;
                
                // XP加算 (ログ保存)
                STORE.user.xp += 1;
                STORE.set('user', STORE.user);
                updateRank();
                
                // 管理画面用ログに追加 (擬似)
                addAdminLog(currentTool.title, res);

            } catch(e) {
                resBox.innerHTML = 'エラーが発生しました';
            }
        }

        function startTimer(btn, sec) {
            btn.disabled = true;
            let s = sec;
            const d = btn.previousElementSibling;
            const t = setInterval(() => {
                s--;
                const m = Math.floor(s/60);
                const sc = s%60;
                d.innerText = `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
                if(s<=0) { clearInterval(t); d.innerText="時間です！"; alert('時間です'); btn.disabled=false; }
            }, 1000);
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- 管理者モード (Admin) ---
        let adminLogs = [];
        let chartObj = null;

        function openAdmin() {
            document.getElementById('admin-modal').style.display = 'flex';
            startAdminSimulation();
        }

        function addAdminLog(toolName, res) {
            // 自分のログを追加
            const time = new Date().toLocaleTimeString();
            adminLogs.unshift(`[${time}] ${STORE.user.name} が [${toolName}] を使用 >> OK`);
            if(adminLogs.length > 50) adminLogs.pop();
        }

        function startAdminSimulation() {
            // ログの初期ダミーデータ
            if(adminLogs.length === 0) {
                for(let i=0; i<10; i++) adminLogs.push(`[${new Date().toLocaleTimeString()}] User-${Math.floor(Math.random()*9000)} が [計算ツール] を使用 >> OK`);
            }
            updateAdminView();
            initChart();
        }

        function updateAdminView() {
            if(document.getElementById('admin-modal').style.display === 'none') return;

            // 数値のランダム変動
            const u = 1200 + Math.floor(Math.random()*100);
            document.getElementById('adm-users').innerText = u.toLocaleString();
            document.getElementById('adm-cpu').innerText = (Math.random()*30 + 10).toFixed(1) + '%';
            
            // ログ表示更新
            const logDiv = document.getElementById('adm-logs');
            logDiv.innerHTML = adminLogs.map(l => `<div>${l}</div>`).join('');
            
            // 他のユーザーが使っているようなダミーログ追加
            if(Math.random() > 0.7) {
                const tools = ['割引計算', 'BMI', 'QR作成', 'タイマー', '単位変換'];
                const t = tools[Math.floor(Math.random()*tools.length)];
                adminLogs.unshift(`[${new Date().toLocaleTimeString()}] User-${Math.floor(Math.random()*9000)} が [${t}] を使用 >> OK`);
                if(adminLogs.length > 50) adminLogs.pop();
            }

            setTimeout(updateAdminView, 1000);
        }

        function initChart() {
            if(chartObj) return;
            const ctx = document.getElementById('trafficChart').getContext('2d');
            chartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(10).fill(''),
                    datasets: [{
                        label: 'Traffic',
                        data: [10, 12, 15, 14, 20, 18, 25, 22, 30, 28],
                        borderColor: '#2563eb',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(37, 99, 235, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales:{x:{display:false}} }
            });
            
            // チャート更新ループ
            setInterval(() => {
                if(document.getElementById('admin-modal').style.display === 'none') return;
                const data = chartObj.data.datasets[0].data;
                data.shift();
                data.push(Math.random() * 20 + 10);
                chartObj.update();
            }, 2000);
        }

    </script>
</body>
</html>
