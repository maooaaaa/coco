<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeStation V5 | 統合ワークスペース</title>
    
    <!-- Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* --- Core Variables --- */
        :root {
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.4);
            --accent: #8b5cf6;
            --danger: #ef4444;
            --success: #10b981;
            --bg-grad-1: #eff6ff;
            --bg-grad-2: #f0f9ff;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        }

        body.dark {
            --primary: #60a5fa;
            --primary-glow: rgba(96, 165, 250, 0.3);
            --accent: #a78bfa;
            --bg-grad-1: #0f172a;
            --bg-grad-2: #1e293b;
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        /* --- Base & Reset --- */
        body {
            margin: 0;
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
            background-attachment: fixed;
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: color 0.3s, background 0.3s;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--text-sub); border-radius: 3px; opacity: 0.3; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Glassmorphism Class */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow);
        }

        /* --- Layout --- */
        .sidebar {
            width: 260px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
            z-index: 20;
            border-right: 1px solid var(--glass-border);
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
        }
        .logo i { color: var(--primary); }
        .version-badge {
            font-size: 10px; background: linear-gradient(45deg, var(--primary), var(--accent));
            color: white; padding: 2px 8px; border-radius: 12px; font-weight: bold;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            overflow-y: auto;
        }

        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
            font-weight: 600;
            border-radius: 10px;
            font-size: 14px;
        }
        .menu-item:hover { background: rgba(128,128,128, 0.08); color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
        .menu-count { margin-left: auto; font-size: 10px; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 8px; }

        /* Main Area */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        .header {
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--glass-border);
        }

        .search-container { position: relative; width: 300px; }
        .search-input {
            width: 100%; padding: 10px 15px 10px 40px;
            border-radius: 20px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            transition: 0.3s;
        }
        .search-input:focus { background: var(--glass-bg); box-shadow: 0 0 0 2px var(--primary-glow); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 14px; }

        .content { flex: 1; padding: 30px; overflow-y: auto; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            padding-bottom: 80px;
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* Cards */
        .card {
            border-radius: 16px; padding: 20px;
            cursor: pointer; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; gap: 12px; position: relative;
            border: 1px solid transparent;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-glow); box-shadow: 0 10px 25px -5px var(--primary-glow); }
        
        .card-icon-box {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--glass-bg));
            border: 1px solid var(--glass-border);
            color: var(--primary);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }
        .card-title { font-weight: bold; font-size: 16px; }
        .card-desc { font-size: 12px; color: var(--text-sub); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .fav-btn {
            position: absolute; top: 15px; right: 15px;
            color: var(--text-sub); opacity: 0.3; transition: 0.2s;
        }
        .fav-btn:hover, .fav-btn.active { color: var(--accent); opacity: 1; transform: scale(1.1); }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; }
        .modal-box {
            width: 95%; max-width: 650px; max-height: 85vh;
            border-radius: 20px; display: flex; flex-direction: column;
            transform: scale(0.95); transition: 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            overflow: hidden; background: var(--glass-bg);
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .modal-header {
            padding: 15px 25px; border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 18px;
            background: rgba(var(--primary), 0.05);
        }
        .modal-body { padding: 25px; overflow-y: auto; }

        /* UI Components */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(59, 130, 246, 0.1); }

        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--glass-border);
            border-radius: 8px; margin-bottom: 15px; font-size: 14px;
            background: rgba(255,255,255,0.5); color: var(--text-main);
            transition: 0.2s;
        }
        body.dark input, body.dark textarea { background: rgba(0,0,0,0.2); }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-glow); background: var(--glass-bg); }

        .result-area {
            background: rgba(16, 185, 129, 0.05); border: 1px dashed var(--success);
            padding: 15px; border-radius: 8px; margin-top: 15px;
            text-align: center; font-weight: bold; color: var(--success);
            word-break: break-all;
        }

        /* Tool Specific Styles */
        /* Calculator Grid */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .calc-btn { aspect-ratio: 1.2; font-size: 18px; background: rgba(128,128,128,0.1); color: var(--text-main); border-radius: 8px; border:none; cursor:pointer; transition:0.1s; }
        .calc-btn:hover { background: rgba(128,128,128,0.2); }
        .calc-btn.op { color: var(--primary); background: rgba(59,130,246,0.1); font-weight:bold; }
        .calc-btn.eq { background: var(--primary); color: white; grid-column: span 2; }
        .calc-disp { grid-column: span 4; background: rgba(0,0,0,0.05); text-align: right; padding: 15px; font-size: 24px; border-radius: 8px; margin-bottom: 10px; font-family: monospace; }

        /* Todo */
        .todo-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid var(--glass-border); animation: slideIn 0.2s; }
        .todo-check { cursor: pointer; color: var(--text-sub); font-size: 18px; }
        .todo-check.done { color: var(--success); }
        .todo-text { flex: 1; }
        .todo-text.done { text-decoration: line-through; opacity: 0.5; }
        @keyframes slideIn { from{opacity:0; transform:translateX(-10px);} to{opacity:1; transform:translateX(0);} }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: auto; padding: 10px 20px; flex-direction: row; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--glass-border); border-right: none; position: sticky; top:0; background: var(--glass-bg); z-index: 100; }
            .nav-menu { display: none; position: absolute; top: 60px; left: 0; right: 0; background: var(--glass-bg); padding: 20px; border-bottom: 1px solid var(--glass-border); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
            .nav-menu.active { display: flex; }
            .header { padding: 15px 20px; }
            .search-container { width: 100%; }
            .content { padding: 20px; }
            #mobile-toggle { display: block; font-size: 20px; color: var(--text-main); }
        }
        @media (min-width: 769px) { #mobile-toggle { display: none; } }
    </style>
</head>
<body>

    <!-- Tool Modal -->
    <div id="tool-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span id="tm-title"><i class="fas fa-tools"></i> Tool Name</span>
                <span style="cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:rgba(128,128,128,0.1);" onclick="closeModal()">×</span>
            </div>
            <div class="modal-body">
                <p id="tm-desc" style="color:var(--text-sub); margin-bottom:20px; font-size:14px;"></p>
                <div id="tm-ui"></div>
                <div id="tm-result" class="result-area" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar glass">
        <div class="logo">
            <i class="fas fa-layer-group"></i> 
            <span>LifeStation</span>
            <span class="version-badge">V5</span>
            <i id="mobile-toggle" class="fas fa-bars" onclick="toggleMenu()" style="margin-left:auto;"></i>
        </div>
        
        <div class="nav-menu" id="nav-menu">
            <div class="menu-item active" onclick="filter('all')"><i class="fas fa-th-large"></i> すべて <span class="menu-count" id="c-all">0</span></div>
            <div class="menu-item" onclick="filter('fav')"><i class="fas fa-star" style="color:var(--accent)"></i> お気に入り <span class="menu-count" id="c-fav">0</span></div>
            <div class="menu-item" onclick="filter('work')"><i class="fas fa-briefcase"></i> 仕事・効率化 <span class="menu-count" id="c-work">0</span></div>
            <div class="menu-item" onclick="filter('calc')"><i class="fas fa-calculator"></i> 計算・分析 <span class="menu-count" id="c-calc">0</span></div>
            <div class="menu-item" onclick="filter('image')"><i class="fas fa-image"></i> 画像処理 <span class="menu-count" id="c-image">0</span></div>
            <div class="menu-item" onclick="filter('text')"><i class="fas fa-font"></i> テキスト・PDF <span class="menu-count" id="c-text">0</span></div>
            <div class="menu-item" onclick="filter('dev')"><i class="fas fa-code"></i> 開発・ツール <span class="menu-count" id="c-dev">0</span></div>
            
            <div style="margin-top:auto; padding-top:10px; border-top:1px solid var(--glass-border); display:flex; justify-content:space-between; font-size:18px;">
                <i class="fas fa-moon" onclick="toggleTheme()" style="cursor:pointer; color:var(--text-sub);" title="ダークモード切替"></i>
                <i class="fas fa-trash-alt" onclick="clearData()" style="cursor:pointer; color:var(--danger);" title="データ初期化"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <header class="header glass">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="ツールを検索 (Ctrl+K)..." id="search-box" oninput="searchTools(this.value)">
            </div>
            <div style="font-size:12px; color:var(--text-sub); text-align:right;">
                <div id="clock" style="font-weight:bold; font-size:16px; color:var(--text-main);">00:00</div>
                <div id="date">Loading...</div>
            </div>
        </header>

        <div class="content">
            <div id="grid" class="grid">
                <!-- Cards will be injected here -->
            </div>
            <div style="text-align:center; margin-top:50px; color:var(--text-sub); font-size:12px;">
                LifeStation V5 - Local Storage Based Workspace
            </div>
        </div>
    </main>

    <script>
        // ============================================
        //  APP STATE & CONFIG
        // ============================================
        const STORE_KEY = 'lifestation_v5_data';
        let appData = {
            favs: [],
            todos: [],
            memo: '',
            theme: 'light'
        };
        let activeTool = null;
        let pInterval = null; // Pomodoro Interval

        // ============================================
        //  TOOLS DEFINITION
        // ============================================
        const tools = [
            // --- WORK (仕事・効率化) ---
            {
                id: 'todo', cat: 'work', icon: 'fa-check-double', title: 'ToDoリスト', desc: 'ドラッグ移動可能なシンプルタスク管理',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="td-in" placeholder="新しいタスク..." onkeypress="if(event.key==='Enter')addTodo()" style="margin:0;">
                            <button class="btn" style="width:auto;" onclick="addTodo()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="td-list" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
                    `;
                    renderTodos();
                }
            },
            {
                id: 'memo', cat: 'work', icon: 'fa-sticky-note', title: 'クイックメモ', desc: '自動保存されるメモ帳 (テキスト保存可)',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <textarea id="memo-pad" rows="12" placeholder="ここにメモを入力..." oninput="saveMemo()">${appData.memo || ''}</textarea>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-outline" onclick="downloadMemo()"><i class="fas fa-download"></i> .txtで保存</button>
                            <button class="btn btn-outline" onclick="copyMemo()"><i class="fas fa-copy"></i> コピー</button>
                        </div>
                    `;
                }
            },
            {
                id: 'pomo', cat: 'work', icon: 'fa-clock', title: 'ポモドーロ', desc: '集中力維持のためのタイマー',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div style="text-align:center;">
                            <div id="pm-disp" style="font-size:64px; font-weight:800; font-family:monospace; color:var(--primary); margin:20px 0;">25:00</div>
                            <div style="display:flex; justify-content:center; gap:10px;">
                                <button class="btn" onclick="startPomo(25)">集中 (25分)</button>
                                <button class="btn" style="background:var(--success)" onclick="startPomo(5)">休憩 (5分)</button>
                                <button class="btn" style="background:var(--danger); width:auto;" onclick="stopPomo()"><i class="fas fa-stop"></i></button>
                            </div>
                        </div>
                    `;
                }
            },

            // --- CALC (計算・分析) ---
            {
                id: 'calc', cat: 'calc', icon: 'fa-calculator', title: '電卓', desc: 'キーボード操作対応の標準電卓',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <div class="calc-disp" id="c-disp">0</div>
                        <div class="calc-grid">
                            <button class="calc-btn op" onclick="cIn('C')">C</button>
                            <button class="calc-btn op" onclick="cIn('/')">÷</button>
                            <button class="calc-btn op" onclick="cIn('*')">×</button>
                            <button class="calc-btn op" onclick="cIn('Del')">⌫</button>
                            <button class="calc-btn" onclick="cIn('7')">7</button>
                            <button class="calc-btn" onclick="cIn('8')">8</button>
                            <button class="calc-btn" onclick="cIn('9')">9</button>
                            <button class="calc-btn op" onclick="cIn('-')">-</button>
                            <button class="calc-btn" onclick="cIn('4')">4</button>
                            <button class="calc-btn" onclick="cIn('5')">5</button>
                            <button class="calc-btn" onclick="cIn('6')">6</button>
                            <button class="calc-btn op" onclick="cIn('+')">+</button>
                            <button class="calc-btn" onclick="cIn('1')">1</button>
                            <button class="calc-btn" onclick="cIn('2')">2</button>
                            <button class="calc-btn" onclick="cIn('3')">3</button>
                            <button class="calc-btn eq" onclick="cIn('=')">=</button>
                            <button class="calc-btn" onclick="cIn('0')">0</button>
                            <button class="calc-btn" onclick="cIn('.')">.</button>
                        </div>
                    `;
                    document.onkeydown = (e) => {
                        const k = e.key;
                        if((k>='0'&&k<='9')||['+','-','*','/','.','Enter','Backspace','Escape'].includes(k)) {
                            e.preventDefault();
                            let map = {'Enter':'=', 'Backspace':'Del', 'Escape':'C'};
                            cIn(map[k] || k);
                        }
                    }
                }
            },
            { id: 'discount', cat: 'calc', icon: 'fa-percent', title: '割引計算', desc: '税込価格と割引額を即座に計算', inputs: ['price:元の価格(円)', 'per:割引率(%)'], func: (p,r) => { const end=Math.floor(p*(1-r/100)); return `支払額: ${end.toLocaleString()}円<br><span style="font-size:12px;color:gray">(${p*r/100}円 お得)</span>`; } },
            { id: 'date', cat: 'calc', icon: 'fa-calendar-alt', title: '日数計算', desc: '2つの日付の間の日数を計算', inputs:['d1:開始日 (YYYY-MM-DD)', 'd2:終了日 (YYYY-MM-DD)'], func:(d1,d2)=>{ const df=new Date(d2)-new Date(d1); return `差分: ${df/86400000} 日`; } },
            { id: 'unit', cat: 'calc', icon: 'fa-balance-scale', title: '単位変換', desc: 'インチ⇔センチ、ポンド⇔キロ', type:'custom', render:(el)=>{
                el.innerHTML=`
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <select id="u-type"><option value="len">長さ (inch ⇔ cm)</option><option value="wgt">重さ (lb ⇔ kg)</option></select>
                        <input type="number" id="u-val" placeholder="値">
                    </div>
                    <button class="btn" onclick="convertUnit()">変換</button>
                `;
            }},

            // --- IMAGE (画像処理) ---
            {
                id: 'img-filter', cat: 'image', icon: 'fa-magic', title: '画像フィルタ', desc: '画像を読み込みグレースケール/セピア化',
                type: 'custom',
                render: (el) => {
                    el.innerHTML = `
                        <input type="file" id="img-in" accept="image/*" onchange="loadImg(this)">
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <button class="btn btn-outline" onclick="applyFilter('gray')">モノクロ</button>
                            <button class="btn btn-outline" onclick="applyFilter('sepia')">セピア</button>
                            <button class="btn btn-outline" onclick="applyFilter('reset')">リセット</button>
                        </div>
                        <canvas id="img-can" style="max-width:100%; border:1px solid #ccc; display:none;"></canvas>
                        <button class="btn" id="img-dl" style="display:none; margin-top:10px;" onclick="dlCanvas()">画像を保存</button>
                    `;
                }
            },
            { id: 'qrcode', cat: 'image', icon: 'fa-qrcode', title: 'QR作成', desc: 'テキストやURLからQRコードを生成', inputs:['text:内容'], type:'qr' },
            { id: 'color', cat: 'image', icon: 'fa-palette', title: 'カラーピッカー', desc: '色を選択してHEX/RGBコードを取得', type:'custom', render:(el)=>{
                el.innerHTML=`<input type="color" style="height:60px; cursor:pointer;" onchange="document.getElementById('c-hex').innerText=this.value.toUpperCase(); document.getElementById('c-rgb').innerText='RGB: '+parseInt(this.value.substr(1,2),16)+','+parseInt(this.value.substr(3,2),16)+','+parseInt(this.value.substr(5,2),16)">
                <div id="c-hex" style="font-size:24px; font-weight:bold; text-align:center; margin-top:10px;">#000000</div>
                <div id="c-rgb" style="text-align:center; color:gray;">RGB: 0,0,0</div>`;
            }},

            // --- TEXT (テキスト・PDF) ---
            { id: 'char', cat: 'text', icon: 'fa-text-width', title: '文字数カウント', desc: '文字数、行数、空白なし文字数をカウント', type:'custom', render:(el)=>{
                el.innerHTML=`<textarea id="txt-c" rows="5" placeholder="テキストを入力..." oninput="countChar()"></textarea><div id="txt-res" style="text-align:right; font-weight:bold;">0 文字</div>`;
            }},
            { id: 'case', cat: 'text', icon: 'fa-font-case', title: '大文字/小文字', desc: '英語テキストの変換', inputs:['txt:テキスト'], func:(t)=>`UPPER: ${t.toUpperCase()}<br>lower: ${t.toLowerCase()}<br>Capital: ${t.charAt(0).toUpperCase()+t.slice(1)}` },
            { id: 'json', cat: 'text', icon: 'fa-code', title: 'JSON整形', desc: '崩れたJSONを綺麗にフォーマット', inputs:['json:JSON文字列'], func:(t)=>{try{return `<pre style="text-align:left; overflow:auto;">${JSON.stringify(JSON.parse(t),null,2)}</pre>`}catch(e){return 'Error: Invalid JSON'}} },
            { id: 'lorem', cat: 'text', icon: 'fa-paragraph', title: 'ダミーテキスト', desc: 'Lorem Ipsumを生成', inputs:['n:パラグラフ数'], func:(n)=>{let s="Lorem ipsum dolor sit amet, consectetur adipiscing elit. "; return s.repeat(n||1);} },

            // --- DEV/TOOLS (開発・ツール) ---
            { id: 'pass', cat: 'dev', icon: 'fa-key', title: 'パスワード生成', desc: '強力なランダムパスワードを生成', inputs:['len:長さ(8-64)'], func:(l)=>{const c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*"; let r=""; for(let i=0;i<(l||12);i++) r+=c[Math.floor(Math.random()*c.length)]; return r;} },
            { id: 'base64', cat: 'dev', icon: 'fa-database', title: 'Base64変換', desc: 'Encode / Decode', inputs:['val:値', 'mode:encode/decode'], func:(v,m)=>m==='decode'?atob(v):btoa(unescape(encodeURIComponent(v))) },
            { id: 'share', cat: 'dev', icon: 'fa-share-alt', title: 'Web共有', desc: 'OS標準の共有機能(スマホ向け)', inputs:['url:URL', 'title:タイトル'], type:'async', func:async(u,t)=>{ if(navigator.share){ await navigator.share({title:t, url:u}); return '共有メニューを開きました'; } else return 'このブラウザは非対応です'; } },
            { id: 'ua', cat: 'dev', icon: 'fa-mobile-alt', title: 'デバイス情報', desc: 'UserAgent確認', func:()=>navigator.userAgent },
        ];

        // ============================================
        //  INIT & CORE FUNCTIONS
        // ============================================
        window.onload = () => {
            loadData();
            updateTime();
            renderGrid(tools);
            updateCounts();
            
            // Global Hotkeys
            document.addEventListener('keydown', (e) => {
                if(e.ctrlKey && e.key === 'k') { e.preventDefault(); document.getElementById('search-box').focus(); }
                if(e.key === 'Escape') closeModal();
            });

            setInterval(updateTime, 1000);
        };

        function loadData() {
            const d = localStorage.getItem(STORE_KEY);
            if(d) {
                appData = JSON.parse(d);
                if(appData.theme === 'dark') document.body.classList.add('dark');
            }
        }

        function saveData() {
            localStorage.setItem(STORE_KEY, JSON.stringify(appData));
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('date').innerText = now.toLocaleDateString('ja-JP', {month:'short', day:'numeric', weekday:'short'});
        }

        // ============================================
        //  UI RENDERING
        // ============================================
        function renderGrid(list) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            list.forEach(t => {
                const isFav = appData.favs.includes(t.id);
                const div = document.createElement('div');
                div.className = 'card glass';
                div.innerHTML = `
                    <i class="fas fa-star fav-btn ${isFav?'active':''}" onclick="toggleFav('${t.id}', event)"></i>
                    <div class="card-icon-box"><i class="fas ${t.icon}"></i></div>
                    <div>
                        <div class="card-title">${t.title}</div>
                        <div class="card-desc">${t.desc}</div>
                    </div>
                `;
                div.onclick = () => openTool(t);
                grid.appendChild(div);
            });
        }

        function filter(cat) {
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if(window.innerWidth <= 768) toggleMenu(); // Mobile close

            if(cat === 'all') renderGrid(tools);
            else if(cat === 'fav') renderGrid(tools.filter(t => appData.favs.includes(t.id)));
            else renderGrid(tools.filter(t => t.cat === cat));
        }

        function searchTools(q) {
            q = q.toLowerCase();
            const res = tools.filter(t => t.title.toLowerCase().includes(q) || t.desc.toLowerCase().includes(q));
            renderGrid(res);
        }

        function updateCounts() {
            ['work','calc','image','text','dev'].forEach(c => {
                document.getElementById('c-'+c).innerText = tools.filter(t => t.cat === c).length;
            });
            document.getElementById('c-all').innerText = tools.length;
            document.getElementById('c-fav').innerText = appData.favs.length;
        }

        function toggleFav(id, e) {
            e.stopPropagation();
            if(appData.favs.includes(id)) appData.favs = appData.favs.filter(i => i !== id);
            else appData.favs.push(id);
            saveData();
            e.target.classList.toggle('active');
            updateCounts();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            appData.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            saveData();
        }

        function clearData() {
            if(confirm('全てのデータを削除して初期化しますか？')) {
                localStorage.removeItem(STORE_KEY);
                location.reload();
            }
        }

        function toggleMenu() {
            document.getElementById('nav-menu').classList.toggle('active');
        }

        // ============================================
        //  TOOL LOGIC
        // ============================================
        function openTool(tool) {
            activeTool = tool;
            document.getElementById('tm-title').innerHTML = `<i class="fas ${tool.icon}"></i> ${tool.title}`;
            document.getElementById('tm-desc').innerText = tool.desc;
            const ui = document.getElementById('tm-ui');
            const res = document.getElementById('tm-result');
            ui.innerHTML = '';
            res.style.display = 'none';
            res.innerHTML = '';
            
            // Clean up old listeners
            document.onkeydown = (e) => { if(e.key==='Escape') closeModal(); };

            if(tool.type === 'custom') {
                tool.render(ui);
            } else {
                // Generate Inputs
                if(tool.inputs) {
                    tool.inputs.forEach((inp, i) => {
                        const [key, ph] = inp.includes(':') ? inp.split(':') : ['v', inp];
                        ui.innerHTML += `<input type="text" id="in-${i}" placeholder="${ph}">`;
                    });
                }
                ui.innerHTML += `<button class="btn" onclick="execTool()">実行</button>`;
            }

            const modal = document.getElementById('tool-modal');
            modal.style.display = 'flex';
            setTimeout(()=>modal.classList.add('show'), 10);
        }

        function closeModal() {
            const modal = document.getElementById('tool-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                stopPomo(); // Timer cleanup
            }, 200);
            document.onkeydown = (e) => {
                if(e.ctrlKey && e.key === 'k') { e.preventDefault(); document.getElementById('search-box').focus(); }
            };
        }

        async function execTool() {
            const resBox = document.getElementById('tm-result');
            resBox.style.display = 'block';
            try {
                const args = [];
                if(activeTool.inputs) {
                    for(let i=0; i<activeTool.inputs.length; i++) args.push(document.getElementById(`in-${i}`).value);
                }
                
                if(activeTool.type === 'qr') {
                    resBox.innerHTML = '';
                    new QRCode(resBox, args[0]);
                } else if(activeTool.type === 'async') {
                    resBox.innerHTML = 'Processing...';
                    resBox.innerHTML = await activeTool.func(...args);
                } else {
                    resBox.innerHTML = activeTool.func(...args);
                }
            } catch(e) {
                resBox.innerText = 'Error: 入力を確認してください';
            }
        }

        // --- Specific Tool Functions ---

        // ToDo
        function addTodo() {
            const v = document.getElementById('td-in').value;
            if(!v) return;
            appData.todos.push({txt:v, done:false});
            saveData();
            document.getElementById('td-in').value = '';
            renderTodos();
        }
        function renderTodos() {
            const list = document.getElementById('td-list');
            list.innerHTML = '';
            appData.todos.forEach((t, i) => {
                const d = document.createElement('div');
                d.className = 'todo-item';
                d.innerHTML = `<i class="fas fa-check-circle todo-check ${t.done?'done':''}" onclick="togTodo(${i})"></i><span class="todo-text ${t.done?'done':''}" contenteditable="true" onblur="updTodo(${i}, this.innerText)">${t.txt}</span><i class="fas fa-times" style="color:var(--danger);cursor:pointer;" onclick="delTodo(${i})"></i>`;
                list.appendChild(d);
            });
            new Sortable(list, { onEnd: (e)=>{
                const item = appData.todos.splice(e.oldIndex, 1)[0];
                appData.todos.splice(e.newIndex, 0, item);
                saveData();
            }});
        }
        function togTodo(i) { appData.todos[i].done = !appData.todos[i].done; saveData(); renderTodos(); }
        function delTodo(i) { appData.todos.splice(i, 1); saveData(); renderTodos(); }
        function updTodo(i, t) { appData.todos[i].txt = t; saveData(); }

        // Memo
        function saveMemo() { appData.memo = document.getElementById('memo-pad').value; saveData(); }
        function copyMemo() { navigator.clipboard.writeText(appData.memo); alert('コピーしました'); }
        function downloadMemo() {
            const blob = new Blob([appData.memo], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `memo_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
        }

        // Pomodoro
        function startPomo(min) {
            stopPomo();
            let s = min * 60;
            const d = document.getElementById('pm-disp');
            pInterval = setInterval(() => {
                s--;
                d.innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                if(s<=0) {
                    stopPomo();
                    new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                    alert('時間です！');
                }
            }, 1000);
        }
        function stopPomo() { if(pInterval) clearInterval(pInterval); }

        // Calculator
        let cExp = '';
        function cIn(v) {
            const d = document.getElementById('c-disp');
            if(v==='C') cExp = '';
            else if(v==='Del') cExp = cExp.slice(0,-1);
            else if(v==='=') {
                try { cExp = String(eval(cExp)); } catch { cExp = 'Error'; }
            } else cExp += v;
            d.innerText = cExp || '0';
        }

        // Unit Converter
        function convertUnit() {
            const t = document.getElementById('u-type').value;
            const v = parseFloat(document.getElementById('u-val').value);
            if(isNaN(v)) return;
            const r = document.getElementById('tm-result');
            r.style.display = 'block';
            if(t==='len') r.innerHTML = `${v} in = ${(v*2.54).toFixed(2)} cm <br> ${v} cm = ${(v/2.54).toFixed(2)} in`;
            else r.innerHTML = `${v} lb = ${(v*0.453).toFixed(2)} kg <br> ${v} kg = ${(v/0.453).toFixed(2)} lb`;
        }

        // Image Filter
        let imgObj = new Image();
        function loadImg(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                imgObj.src = e.target.result;
                imgObj.onload = () => {
                    const c = document.getElementById('img-can');
                    const ctx = c.getContext('2d');
                    // Resize to fit width if huge
                    const maxW = 500;
                    const sc = imgObj.width > maxW ? maxW/imgObj.width : 1;
                    c.width = imgObj.width * sc;
                    c.height = imgObj.height * sc;
                    c.style.display = 'block';
                    document.getElementById('img-dl').style.display = 'block';
                    ctx.drawImage(imgObj, 0, 0, c.width, c.height);
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
        function applyFilter(type) {
            const c = document.getElementById('img-can');
            const ctx = c.getContext('2d');
            ctx.drawImage(imgObj, 0, 0, c.width, c.height); // reset
            if(type==='reset') return;
            
            const imgD = ctx.getImageData(0, 0, c.width, c.height);
            const d = imgD.data;
            for(let i=0; i<d.length; i+=4) {
                const r=d[i], g=d[i+1], b=d[i+2];
                if(type==='gray') {
                    const v = 0.34*r + 0.5*g + 0.16*b;
                    d[i]=d[i+1]=d[i+2]=v;
                } else if(type==='sepia') {
                    d[i] = r*0.393 + g*0.769 + b*0.189;
                    d[i+1] = r*0.349 + g*0.686 + b*0.168;
                    d[i+2] = r*0.272 + g*0.534 + b*0.131;
                }
            }
            ctx.putImageData(imgD, 0, 0);
        }
        function dlCanvas() {
            const l = document.createElement('a');
            l.download = 'edited_image.png';
            l.href = document.getElementById('img-can').toDataURL();
            l.click();
        }

        // Char Count
        function countChar() {
            const t = document.getElementById('txt-c').value;
            document.getElementById('txt-res').innerText = `${t.length} 文字 (空白なし: ${t.replace(/\s/g,'').length})`;
        }
    </script>
</body>
</html>
