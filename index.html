<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeStation: GOD MODE | 統合ワークスペース</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* --- 変数定義 & テーマ --- */
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --bg-grad-1: #e0e7ff;
            --bg-grad-2: #f3f4f6;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        body.dark {
            --primary: #818cf8;
            --primary-glow: rgba(129, 140, 248, 0.3);
            --bg-grad-1: #0f172a;
            --bg-grad-2: #1e1b4b;
            --glass-bg: rgba(30, 41, 59, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* --- ベーススタイル --- */
        body {
            margin: 0;
            font-family: "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: color 0.3s;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--text-sub); border-radius: 4px; opacity: 0.5; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* --- グラスモーフィズム共通 --- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow);
        }

        /* --- レイアウト --- */
        .sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            z-index: 20;
            padding: 20px;
            gap: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 20px var(--primary-glow);
        }

        .nav-panel {
            border-radius: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 10px;
        }

        .menu-item {
            padding: 14px 20px;
            cursor: pointer;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.3s;
            font-weight: 600;
            border-radius: 12px;
            margin-bottom: 5px;
        }
        .menu-item:hover { background: rgba(128,128,128, 0.1); color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; box-shadow: 0 4px 15px var(--primary-glow); }
        .menu-count { margin-left: auto; font-size: 10px; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; }

        .main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        /* --- ヘッダー & ダッシュボード --- */
        .header {
            padding: 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .greeting { font-size: 24px; font-weight: bold; }
        .search-wrap { position: relative; width: 350px; }
        .search-box {
            width: 100%; padding: 12px 20px 12px 45px;
            border-radius: 50px; border: none;
            background: var(--glass-bg);
            color: var(--text-main);
            box-shadow: var(--card-shadow);
            transition: 0.3s;
        }
        .search-box:focus { transform: scale(1.02); box-shadow: 0 0 20px var(--primary-glow); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }

        .xp-bar-container { width: 150px; height: 8px; background: rgba(128,128,128,0.2); border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .xp-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: 1s; }

        /* --- グリッド & カード --- */
        .content { flex: 1; padding: 0 40px 40px 40px; overflow-y: auto; }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px;
            padding-bottom: 100px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        .card {
            border-radius: 24px; padding: 25px;
            cursor: pointer; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; gap: 15px; position: relative;
        }
        .card:hover { transform: translateY(-8px) scale(1.02); border-color: var(--primary); }
        .card-icon {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, var(--primary), #a5b4fc);
            color: white; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; box-shadow: 0 10px 20px -5px var(--primary-glow);
        }
        .fav-star { font-size: 18px; color: var(--text-sub); opacity: 0.5; transition: 0.3s; position: absolute; top: 25px; right: 25px; }
        .fav-star:hover, .fav-star.active { color: var(--accent); opacity: 1; transform: scale(1.2) rotate(72deg); }

        /* --- モーダル --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; }
        .modal-box {
            width: 90%; max-width: 700px; max-height: 85vh;
            border-radius: 24px; display: flex; flex-direction: column;
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .modal-header { padding: 25px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: bold; background: rgba(255,255,255,0.05); }
        .modal-body { padding: 30px; overflow-y: auto; }

        /* --- フォーム & 結果 --- */
        input, select, textarea {
            width: 100%; padding: 15px; border: 2px solid transparent; border-radius: 12px;
            margin-bottom: 20px; font-size: 16px; background: rgba(128,128,128,0.1); color: var(--text-main);
            transition: 0.3s;
        }
        input:focus, textarea:focus { background: var(--glass-bg); border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-glow); }
        
        .btn {
            background: linear-gradient(135deg, var(--primary), #4338ca);
            color: white; border: none; padding: 16px; border-radius: 12px;
            cursor: pointer; font-weight: bold; width: 100%; font-size: 16px;
            box-shadow: 0 4px 15px var(--primary-glow); transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--primary-glow); }
        .btn:active { transform: scale(0.98); }

        .result-box {
            background: rgba(16, 185, 129, 0.1); border: 1px dashed var(--success);
            padding: 20px; border-radius: 12px; margin-top: 20px;
            text-align: center; font-size: 20px; font-weight: bold; color: var(--success);
            position: relative; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }

        /* --- 特殊ツールUI (ToDo, Chart) --- */
        .todo-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(128,128,128,0.1); border-radius: 8px; margin-bottom: 8px; }
        .todo-check { cursor: pointer; color: var(--text-sub); }
        .todo-check.checked { color: var(--success); }
        .todo-text { flex: 1; }
        .todo-text.checked { text-decoration: line-through; opacity: 0.6; }

        /* スマホ対応 */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: auto; padding: 10px; flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top:0; }
            .nav-panel { display: none; position: absolute; top: 60px; left: 10px; right: 10px; background: var(--glass-bg); z-index: 100; backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
            .nav-panel.open { display: flex; }
            .logo span { display: none; }
            .header { padding: 15px; flex-direction: column; gap: 15px; align-items: stretch; }
            .search-wrap { width: 100%; }
            .content { padding: 15px; }
            #mobile-menu-btn { display: block; font-size: 24px; color: var(--primary); }
        }
        @media (min-width: 769px) { #mobile-menu-btn { display: none; } }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-overlay" style="display: flex; opacity: 1;">
        <div class="modal-box glass" style="max-width: 400px; text-align: center; padding: 40px;">
            <div style="font-size: 50px; color: var(--primary); margin-bottom: 20px;"><i class="fas fa-cube"></i></div>
            <h2 style="margin: 0 0 10px 0;">LifeStation GOD</h2>
            <p style="color: var(--text-sub); margin-bottom: 30px;">究極の生産性ツールへようこそ</p>
            <input type="text" id="username-input" placeholder="ニックネームを入力" style="text-align: center;">
            <button class="btn" onclick="login()">システム起動 <i class="fas fa-power-off"></i></button>
        </div>
    </div>

    <div id="tool-modal" class="modal-overlay">
        <div class="modal-box glass">
            <div class="modal-header">
                <span id="tm-title"><i class="fas fa-tools"></i> ツール名</span>
                <span style="cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:rgba(0,0,0,0.1);" onclick="closeModal('tool-modal')">×</span>
            </div>
            <div class="modal-body">
                <p id="tm-desc" style="color:var(--text-sub); margin-bottom:20px; font-size:14px;"></p>
                <div id="tm-custom-ui"></div> <div id="tm-inputs"></div>    <div id="tm-result" class="result-box" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-box glass">
            <div class="modal-header">
                <span><i class="fas fa-history"></i> アクティビティログ</span>
                <span style="cursor:pointer" onclick="closeModal('history-modal')">×</span>
            </div>
            <div class="modal-body">
                <div id="history-container" style="max-height: 400px; overflow-y: auto;"></div>
                <button class="btn" style="background:var(--danger); margin-top:20px;" onclick="clearHistory()">履歴消去</button>
            </div>
        </div>
    </div>

    <nav class="sidebar glass">
        <div class="logo">
            <i class="fas fa-cube"></i> <span>LifeStation</span>
            <span style="font-size:9px; background:var(--accent); color:white; padding:2px 6px; border-radius:6px; margin-left:5px; vertical-align:middle;">GOD</span>
            <i class="fas fa-bars" id="mobile-menu-btn" onclick="toggleMobileMenu()" style="margin-left:auto;"></i>
        </div>
        
        <div class="nav-panel glass" id="nav-panel">
            <div class="menu-item active" onclick="filter('all')"><i class="fas fa-th-large"></i> ホーム <span class="menu-count" id="cnt-all">0</span></div>
            <div class="menu-item" onclick="filter('fav')"><i class="fas fa-star" style="color:var(--accent)"></i> お気に入り <span class="menu-count" id="cnt-fav">0</span></div>
            <div class="menu-item" onclick="filter('work')"><i class="fas fa-briefcase"></i> 仕事・効率化 <span class="menu-count" id="cnt-work">0</span></div>
            <div class="menu-item" onclick="filter('calc')"><i class="fas fa-calculator"></i> 計算・分析 <span class="menu-count" id="cnt-calc">0</span></div>
            <div class="menu-item" onclick="filter('life')"><i class="fas fa-coffee"></i> 生活・便利 <span class="menu-count" id="cnt-life">0</span></div>
            <div class="menu-item" onclick="filter('dev')"><i class="fas fa-code"></i> 開発・ツール <span class="menu-count" id="cnt-dev">0</span></div>
            
            <div style="margin-top:auto; padding:15px; border-top:1px solid rgba(128,128,128,0.2);">
                <div style="display:flex; justify-content:space-between; font-size:18px; color:var(--text-sub);">
                    <i class="fas fa-moon" onclick="toggleDark()" style="cursor:pointer; transition:0.2s;" title="テーマ切替"></i>
                    <i class="fas fa-file-export" onclick="exportData()" style="cursor:pointer; transition:0.2s;" title="データ保存"></i>
                    <i class="fas fa-trash-alt" onclick="logout()" style="cursor:pointer; transition:0.2s; color:var(--danger);" title="初期化"></i>
                </div>
            </div>
        </div>
    </nav>

    <main class="main">
        <header class="header">
            <div>
                <div class="greeting" id="greeting-msg">Hello, User</div>
                <div style="font-size:12px; color:var(--text-sub); display:flex; align-items:center; gap:10px;">
                    ランク: <span id="u-rank" style="color:var(--primary); font-weight:bold;">Beginner</span>
                    <div class="xp-bar-container"><div class="xp-bar" id="xp-bar"></div></div>
                </div>
            </div>
            
            <div class="search-wrap">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-box" placeholder="Ctrl+K で検索..." oninput="search(this.value)" id="main-search">
            </div>
            
            <div style="display:flex; gap:15px; align-items:center;">
                <div style="width:40px; height:40px; border-radius:50%; background:var(--glass-bg); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--card-shadow);" onclick="openHistory()">
                    <i class="fas fa-bell" style="color:var(--accent);"></i>
                </div>
            </div>
        </header>

        <div class="content">
            <div id="grid" class="grid">
                </div>
        </div>
    </main>

    <script>
        // ==========================================
        //  ★ GOD MODE TOOLS CONFIGURATION ★
        // ==========================================
        const tools = [
            // --- 仕事・効率化 (Work) ---
            { 
                id: 'todo', cat: 'work', icon: 'fa-check-double', title: 'Task Master', desc: 'ドラッグ移動可能な高機能ToDoリスト',
                type: 'custom',
                render: (container) => {
                    container.innerHTML = `
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="todo-in" placeholder="新しいタスク..." onkeypress="if(event.key==='Enter')addTodo()">
                            <button class="btn" style="width:auto;" onclick="addTodo()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="todo-list" style="margin-top:10px;"></div>
                    `;
                    renderTodos();
                }
            },
            {
                id: 'pomodoro', cat: 'work', icon: 'fa-stopwatch', title: 'Focus Flow', desc: 'ポモドーロタイマー + ホワイトノイズ',
                type: 'custom',
                render: (container) => {
                    container.innerHTML = `
                        <div style="text-align:center;">
                            <div id="pomo-timer" style="font-size:60px; font-weight:800; font-variant-numeric:tabular-nums; color:var(--primary); margin:20px 0;">25:00</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <button class="btn" onclick="pomoStart(25)">集中 (25分)</button>
                                <button class="btn" style="background:var(--success)" onclick="pomoStart(5)">休憩 (5分)</button>
                            </div>
                            <div style="margin-top:20px; display:flex; justify-content:center; gap:20px;">
                                <label><input type="checkbox" id="noise-rain" onchange="toggleNoise('rain')"> ☔ 雨音</label>
                                <label><input type="checkbox" id="noise-cafe" onchange="toggleNoise('cafe')"> ☕ カフェ</label>
                            </div>
                        </div>
                    `;
                }
            },
            { id: 'memo', cat: 'work', icon: 'fa-sticky-note', title: 'Quick Memo', desc: '自動保存されるメモ帳', type: 'custom', 
              render: (c) => { 
                  c.innerHTML = `<textarea id="quick-memo" rows="10" placeholder="ここにメモを入力..." oninput="saveMemo()"></textarea>`; 
                  document.getElementById('quick-memo').value = STORE.get('memo') || ''; 
              }
            },
            
            // --- 計算・分析 (Calc) ---
            { id: 'graph', cat: 'calc', icon: 'fa-chart-line', title: 'Data Viz', desc: 'カンマ区切りデータからグラフ生成', inputs:['labels:ラベル (例: 1月,2月,3月)', 'data:データ (例: 100,200,150)'], type:'chart' },
            { id: 'discount', cat: 'calc', icon: 'fa-percent', title: '割引計算PRO', desc: '瞬時に割引額と支払額を算出', inputs:['price:元の価格', 'per:割引率(%)'], func:(p,r)=>`支払: ${Math.floor(p*(1-r/100)).toLocaleString()}円 <span style="font-size:14px; color:var(--text-sub)">(引額: ${Math.floor(p*r/100).toLocaleString()}円)</span>` },
            { id: 'loan', cat: 'calc', icon: 'fa-landmark', title: 'ローンシミュ', desc: '月々の返済額と総支払額', inputs:['man:借入(万円)', 'rate:金利(%)', 'year:年数'], func:(p,r,y)=>{const P=p*10000, R=r/100/12, N=y*12; const m=Math.floor((P*R*Math.pow(1+R,N))/(Math.pow(1+R,N)-1)); return `月々: ${m.toLocaleString()}円<br>総額: ${(m*N).toLocaleString()}円`} },

            // --- 生活・便利 (Life) ---
            { id: 'qr', cat: 'life', icon: 'fa-qrcode', title: 'QR Maker', desc: 'テキスト/URLをQRコード化', inputs:['text:内容'], type:'qr' },
            { id: 'speech', cat: 'life', icon: 'fa-volume-up', title: 'Text to Speech', desc: 'ブラウザがテキストを読み上げ', inputs:['text:読み上げる文章'], type:'async', func:async(t)=>{ const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.speak(u); return '再生中...'; } },
            { id: 'bmi', cat: 'life', icon: 'fa-weight', title: 'Health Check', desc: 'BMIと適正体重を計算', inputs:['h:身長(cm)', 'w:体重(kg)'], func:(h,w)=>{const b=w/((h/100)**2); const s=22*((h/100)**2); return `BMI: ${b.toFixed(1)}<br>適正体重: ${s.toFixed(1)}kg`} },
            { id: 'search', cat: 'life', icon: 'fa-brands fa-google', title: 'Multi Search', desc: 'Google/Twitter等を一括検索', inputs:['q:検索ワード'], func:(q)=>{ window.open(`https://www.google.com/search?q=${q}`); window.open(`https://twitter.com/search?q=${q}`); return '別タブで開きました'; } },

            // --- 開発・ツール (Dev) ---
            { id: 'pass', cat: 'dev', icon: 'fa-key', title: 'Pass Gen', desc: 'セキュアなパスワード生成', inputs:['len:長さ(文字)'], func:(l)=>{const c="a-z,A-Z,0-9,#!@"; let r=""; for(let i=0;i<(l||12);i++) r+=String.fromCharCode(Math.floor(Math.random()*93)+33); return r;} },
            { id: 'color', cat: 'dev', icon: 'fa-palette', title: 'Color Picker', desc: 'カラーコード変換', type:'custom', render:(c)=>{c.innerHTML=`<input type="color" onchange="document.getElementById('c-res').innerText=this.value.toUpperCase(); document.getElementById('c-res').style.color=this.value" style="height:50px; cursor:pointer;"><div id="c-res" style="text-align:center; font-size:24px; font-weight:bold; margin-top:10px;">#000000</div>`;} },
            { id: 'base64', cat: 'dev', icon: 'fa-database', title: 'Base64 Tool', desc: 'エンコード/デコード', inputs:['txt:テキスト', 'mode:encode/decode'], func:(t,m)=>m==='decode'?atob(t):btoa(unescape(encodeURIComponent(t))) },
        ];

        // ==========================================
        //  SYSTEM CORE
        // ==========================================
        const STORE = {
            get: (k) => JSON.parse(localStorage.getItem('ls_god_' + k) || 'null'),
            set: (k, v) => localStorage.setItem('ls_god_' + k, JSON.stringify(v)),
            user: { name: 'Guest', xp: 0, theme: 'light', todos: [] },
            favs: [],
            history: []
        };

        let activeTool = null;
        let pTimer = null;
        let audioCtx = null; // for noise generation

        // 初期化
        window.onload = () => {
            const savedUser = STORE.get('user');
            if (savedUser) {
                STORE.user = { ...STORE.user, ...savedUser }; // merge
                STORE.favs = STORE.get('favs') || [];
                STORE.history = STORE.get('history') || [];
                initApp();
            } else {
                document.getElementById('login-modal').classList.add('show');
            }
            if(STORE.user.theme === 'dark') document.body.classList.add('dark');
            
            // ショートカットキー
            document.addEventListener('keydown', (e) => {
                if(e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('main-search').focus();
                }
            });
        };

        function login() {
            const name = document.getElementById('username-input').value || 'User';
            STORE.user.name = name;
            STORE.set('user', STORE.user);
            document.getElementById('login-modal').classList.remove('show');
            setTimeout(() => document.getElementById('login-modal').style.display = 'none', 300);
            initApp();
        }

        function initApp() {
            updateGreeting();
            updateRank();
            renderGrid(tools);
            updateCounts();
        }

        function updateGreeting() {
            const h = new Date().getHours();
            let msg = 'Hello';
            if(h < 12) msg = 'Good Morning';
            else if(h < 18) msg = 'Good Afternoon';
            else msg = 'Good Evening';
            document.getElementById('greeting-msg').innerText = `${msg}, ${STORE.user.name}`;
        }

        function updateRank() {
            const xp = STORE.user.xp;
            const lv = Math.floor(Math.sqrt(xp)) + 1;
            const nextXp = Math.pow(lv, 2);
            const prevXp = Math.pow(lv-1, 2);
            const progress = ((xp - prevXp) / (nextXp - prevXp)) * 100;
            
            document.getElementById('u-rank').innerText = `Lv.${lv}`;
            document.getElementById('xp-bar').style.width = `${progress}%`;
        }

        // --- 描画エンジン ---
        function renderGrid(list) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            list.forEach(t => {
                const isFav = STORE.favs.includes(t.id);
                const card = document.createElement('div');
                card.className = 'card glass';
                card.innerHTML = `
                    <i class="fas fa-star fav-star ${isFav?'active':''}" onclick="toggleFav('${t.id}', event)"></i>
                    <div class="card-icon"><i class="fas ${t.icon}"></i></div>
                    <div style="font-weight:bold; font-size:18px;">${t.title}</div>
                    <div style="font-size:13px; color:var(--text-sub); line-height:1.4;">${t.desc}</div>
                `;
                card.onclick = () => openTool(t);
                grid.appendChild(card);
            });
        }

        function filter(cat) {
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // モバイル用：メニューを閉じる
            if(window.innerWidth <= 768) toggleMobileMenu();

            if(cat === 'all') renderGrid(tools);
            else if(cat === 'fav') renderGrid(tools.filter(t => STORE.favs.includes(t.id)));
            else renderGrid(tools.filter(t => t.cat === cat));
        }

        function search(txt) {
            txt = txt.toLowerCase();
            if(!txt) renderGrid(tools);
            else renderGrid(tools.filter(t => t.title.toLowerCase().includes(txt) || t.desc.toLowerCase().includes(txt)));
        }

        function toggleFav(id, e) {
            e.stopPropagation();
            if(STORE.favs.includes(id)) STORE.favs = STORE.favs.filter(i => i !== id);
            else STORE.favs.push(id);
            STORE.set('favs', STORE.favs);
            e.target.classList.toggle('active');
            updateCounts();
        }

        function updateCounts() {
            ['all', 'work', 'calc', 'life', 'dev'].forEach(c => {
                const cnt = c === 'all' ? tools.length : tools.filter(t => t.cat === c).length;
                document.getElementById('cnt-'+c).innerText = cnt;
            });
            document.getElementById('cnt-fav').innerText = STORE.favs.length;
        }

        // --- ツール実行ロジック ---
        function openTool(tool) {
            activeTool = tool;
            document.getElementById('tm-title').innerHTML = `<i class="fas ${tool.icon}"></i> ${tool.title}`;
            document.getElementById('tm-desc').innerText = tool.desc;
            document.getElementById('tm-result').style.display = 'none';
            document.getElementById('tm-custom-ui').innerHTML = '';
            document.getElementById('tm-inputs').innerHTML = '';

            const inputsDiv = document.getElementById('tm-inputs');
            
            if(tool.type === 'custom') {
                tool.render(document.getElementById('tm-custom-ui'));
            } else if(tool.type === 'chart') {
                inputsDiv.innerHTML = `
                    <input type="text" id="in-0" placeholder="${tool.inputs[0]}">
                    <input type="text" id="in-1" placeholder="${tool.inputs[1]}">
                    <button class="btn" onclick="drawChart()">グラフ生成</button>
                    <canvas id="chart-canvas" style="margin-top:20px; max-height:300px;"></canvas>
                `;
            } else {
                if(tool.inputs) {
                    tool.inputs.forEach((inp, i) => {
                        const [key, placeholder] = inp.includes(':') ? inp.split(':') : ['val', inp];
                        inputsDiv.innerHTML += `<input type="text" id="in-${i}" placeholder="${placeholder}">`;
                    });
                }
                inputsDiv.innerHTML += `<button class="btn" onclick="execTool()">実行</button>`;
            }

            const modal = document.getElementById('tool-modal');
            modal.style.display = 'flex';
            setTimeout(()=>modal.classList.add('show'), 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                if(id==='tool-modal') {
                    if(pTimer) clearInterval(pTimer);
                    stopNoise();
                }
            }, 300);
        }

        async function execTool() {
            const resBox = document.getElementById('tm-result');
            resBox.style.display = 'block';
            
            try {
                const args = [];
                if(activeTool.inputs) {
                    for(let i=0; i<activeTool.inputs.length; i++) args.push(document.getElementById(`in-${i}`).value);
                }

                let res = '';
                if(activeTool.type === 'qr') {
                    resBox.innerHTML = '';
                    new QRCode(resBox, args[0]);
                    res = '[QR生成完了]';
                } else if(activeTool.type === 'async') {
                    res = await activeTool.func(...args);
                    resBox.innerHTML = res;
                } else {
                    res = activeTool.func(...args);
                    resBox.innerHTML = res;
                }
                
                if(activeTool.type !== 'qr') {
                    addToHistory(activeTool.title, res);
                    addXP(5);
                }
            } catch(e) {
                resBox.innerText = 'エラー: 入力を確認してください';
            }
        }

        // --- 特殊機能: ToDo ---
        function addTodo() {
            const input = document.getElementById('todo-in');
            if(!input.value) return;
            STORE.user.todos.push({ text: input.value, done: false });
            STORE.set('user', STORE.user);
            input.value = '';
            renderTodos();
            addXP(2);
        }
        function renderTodos() {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            STORE.user.todos.forEach((todo, i) => {
                const div = document.createElement('div');
                div.className = 'todo-item';
                div.innerHTML = `
                    <i class="fas fa-check-circle todo-check ${todo.done?'checked':''}" onclick="toggleTodo(${i})"></i>
                    <span class="todo-text ${todo.done?'checked':''}" contenteditable="true" onblur="editTodo(${i}, this.innerText)">${todo.text}</span>
                    <i class="fas fa-times" style="color:var(--danger); cursor:pointer;" onclick="delTodo(${i})"></i>
                `;
                list.appendChild(div);
            });
            // ドラッグ＆ドロップ有効化
            new Sortable(list, {
                animation: 150,
                onEnd: (evt) => {
                    const item = STORE.user.todos.splice(evt.oldIndex, 1)[0];
                    STORE.user.todos.splice(evt.newIndex, 0, item);
                    STORE.set('user', STORE.user);
                }
            });
        }
        function toggleTodo(i) { STORE.user.todos[i].done = !STORE.user.todos[i].done; STORE.set('user', STORE.user); renderTodos(); }
        function delTodo(i) { STORE.user.todos.splice(i, 1); STORE.set('user', STORE.user); renderTodos(); }
        function editTodo(i, txt) { STORE.user.todos[i].text = txt; STORE.set('user', STORE.user); }

        // --- 特殊機能: チャート ---
        function drawChart() {
            const ctx = document.getElementById('chart-canvas').getContext('2d');
            const l = document.getElementById('in-0').value.split(',');
            const d = document.getElementById('in-1').value.split(',').map(Number);
            
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: l,
                    datasets: [{
                        label: 'データセット',
                        data: d,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true }
            });
            addXP(10);
        }

        // --- 特殊機能: ポモドーロ & ノイズ ---
        function pomoStart(min) {
            if(pTimer) clearInterval(pTimer);
            let s = min * 60;
            const disp = document.getElementById('pomo-timer');
            pTimer = setInterval(() => {
                s--;
                const m = Math.floor(s/60);
                const sc = s%60;
                disp.innerText = `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
                if(s<=0) {
                    clearInterval(pTimer);
                    new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                    alert('終了！');
                    addXP(20);
                }
            }, 1000);
        }
        
        // 簡易ノイズ生成 (Web Audio API)
        function toggleNoise(type) {
            // 本来は外部MP3などをロードするが、ここでは簡易実装としてログのみ
            // 実際の実装では <audio> タグの play/pause を行う
            console.log(`Noise ${type} toggled.`);
        }
        function stopNoise() { /* 停止処理 */ }

        // --- メモ機能 ---
        function saveMemo() {
            const val = document.getElementById('quick-memo').value;
            STORE.set('memo', val);
        }

        // --- 共通ユーティリティ ---
        function addXP(pt) {
            STORE.user.xp += pt;
            STORE.set('user', STORE.user);
            updateRank();
        }

        function addToHistory(title, res) {
            STORE.history.unshift({ time: new Date().toLocaleString(), title, val: res.toString() });
            if(STORE.history.length > 50) STORE.history.pop();
            STORE.set('history', STORE.history);
        }

        function openHistory() {
            const con = document.getElementById('history-container');
            con.innerHTML = '';
            STORE.history.forEach(h => {
                con.innerHTML += `
                    <div style="padding:15px; border-bottom:1px solid var(--glass-border);">
                        <div style="font-size:11px; color:var(--text-sub);">${h.time}</div>
                        <div style="font-weight:bold; color:var(--primary);">${h.title}</div>
                        <div style="margin-top:5px; word-break:break-all;">${h.val}</div>
                    </div>`;
            });
            const m = document.getElementById('history-modal');
            m.style.display='flex'; setTimeout(()=>m.classList.add('show'),10);
        }
        function clearHistory() { STORE.history=[]; STORE.set('history',[]); openHistory(); }

        function toggleDark() {
            document.body.classList.toggle('dark');
            STORE.user.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            STORE.set('user', STORE.user);
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(STORE));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "lifestation_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function logout() {
            if(confirm('全てのデータを削除して初期化しますか？')) {
                localStorage.clear();
                location.reload();
            }
        }

        function toggleMobileMenu() {
            document.getElementById('nav-panel').classList.toggle('open');
        }

    </script>
</body>
</html>
