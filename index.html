<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeStation V9 | Ultimate Workspace</title>
    
    <!-- Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    
    <style>
        /* --- Core Variables --- */
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --accent: #06b6d4;
            --danger: #ef4444;
            --success: #10b981;
            --bg-grad-1: #f3f4f6;
            --bg-grad-2: #e5e7eb;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.8);
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
            --sidebar-width: 260px;
            
            /* Category Colors */
            --cat-life: #3b82f6;
            --cat-work: #6366f1;
            --cat-dev: #8b5cf6;
            --cat-eng: #f59e0b;
            --cat-media: #ec4899;
            --cat-fun: #10b981;
        }

        body.dark {
            --primary: #818cf8;
            --primary-glow: rgba(129, 140, 248, 0.3);
            --accent: #22d3ee;
            --bg-grad-1: #0f172a;
            --bg-grad-2: #111827;
            --glass-bg: rgba(30, 41, 59, 0.9);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f3f4f6;
            --text-sub: #9ca3af;
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
        }

        /* --- Base & Reset --- */
        body {
            margin: 0;
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
            background-attachment: fixed;
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: color 0.3s, background 0.3s;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--text-sub); border-radius: 4px; opacity: 0.3; }
        ::-webkit-scrollbar-track { background: transparent; }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow);
        }

        /* --- Layout --- */
        .sidebar {
            width: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
            z-index: 50;
            border-right: 1px solid var(--glass-border);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
            padding-bottom: 10px;
        }
        .logo i { color: var(--primary); }
        .version-badge {
            font-size: 10px; background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; padding: 2px 8px; border-radius: 12px; font-weight: bold;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            overflow-y: auto;
        }

        .menu-item {
            padding: 10px 14px;
            cursor: pointer;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
            font-weight: 600;
            border-radius: 8px;
            font-size: 13px;
        }
        .menu-item:hover { background: rgba(128,128,128, 0.08); color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
        .menu-count { margin-left: auto; font-size: 10px; background: rgba(128,128,128,0.2); padding: 2px 6px; border-radius: 8px; }

        /* Category Indicators */
        .cat-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* Main Area */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; transition: 0.3s; }

        .header {
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--glass-border);
            z-index: 40;
        }

        .search-container { position: relative; width: 300px; max-width: 100%; }
        .search-input {
            width: 100%; padding: 8px 15px 8px 35px;
            border-radius: 20px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            transition: 0.3s; font-size: 13px;
        }
        .search-input:focus { background: var(--glass-bg); box-shadow: 0 0 0 2px var(--primary-glow); border-color: var(--primary); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 13px; }

        .content { flex: 1; padding: 25px; overflow-y: auto; overflow-x: hidden; }
        
        /* Dashboard Widgets */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            animation: fadeIn 0.4s ease;
        }
        .widget {
            padding: 15px; border-radius: 16px;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            min-height: 140px;
            border: 1px solid var(--glass-border);
        }
        .widget-title { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .widget-val { font-size: 24px; font-weight: 800; color: var(--text-main); }
        .widget-chart-con { flex: 1; position: relative; min-height: 80px; }

        /* Tool Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            padding-bottom: 80px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* Cards */
        .card {
            border-radius: 12px; padding: 15px;
            cursor: pointer; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; gap: 10px; position: relative;
            border: 1px solid transparent; min-height: 100px;
        }
        .card:hover { transform: translateY(-3px); border-color: var(--primary-glow); box-shadow: 0 8px 20px -5px var(--primary-glow); }
        
        .card-icon-box {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--glass-bg));
            border: 1px solid var(--glass-border);
            color: var(--primary);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        .card-title { font-weight: bold; font-size: 14px; }
        .card-desc { font-size: 11px; color: var(--text-sub); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .fav-btn {
            position: absolute; top: 12px; right: 12px;
            color: var(--text-sub); opacity: 0.2; transition: 0.2s; font-size: 14px;
        }
        .fav-btn:hover, .fav-btn.active { color: var(--accent); opacity: 1; transform: scale(1.2); }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; }
        .modal-box {
            width: 90%; max-width: 800px; height: 85vh;
            border-radius: 16px; display: flex; flex-direction: column;
            transform: scale(0.95); transition: 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            overflow: hidden; background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .modal-header {
            padding: 12px 20px; border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 16px;
            background: rgba(var(--primary), 0.05);
        }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; position: relative; gap: 15px; }

        /* UI Components */
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 16px;
            border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
            user-select: none; font-size: 13px;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 5px 10px; font-size: 11px; width: auto; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(99, 102, 241, 0.1); }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid var(--glass-border);
            border-radius: 8px; margin-bottom: 10px; font-size: 13px;
            background: rgba(255,255,255,0.5); color: var(--text-main);
            transition: 0.2s; font-family: inherit;
        }
        body.dark input, body.dark textarea, body.dark select { background: rgba(0,0,0,0.3); }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-glow); background: var(--glass-bg); }
        label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: 600; color: var(--text-sub); }

        /* Result Box */
        .res-box {
            background: rgba(var(--primary), 0.05); border: 1px dashed var(--primary);
            padding: 15px; border-radius: 8px; font-size: 14px; text-align: center;
            word-break: break-all; margin-top: 10px;
        }

        /* Tools specific */
        .calc-wrapper { display: flex; flex-direction: column; height: 100%; max-height: 600px; margin: 0 auto; width: 100%; max-width: 400px; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex: 1; }
        .calc-btn { 
            width: 100%; height: 100%; min-height: 45px; font-size: 18px; border-radius: 10px; border:none; 
            cursor:pointer; background: rgba(255,255,255,0.5); color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.1s;
        }
        body.dark .calc-btn { background: rgba(255,255,255,0.05); }
        .calc-btn.op { background: var(--primary); color: white; }
        .calc-btn.eq { background: var(--accent); color: white; grid-column: span 2; }

        .todo-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
        .todo-text { flex: 1; word-break: break-all; }
        .todo-text.done { text-decoration: line-through; opacity: 0.5; }

        /* Mobile Responsive */
        .mobile-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 45;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        .mobile-overlay.show { opacity: 1; display: block; }
        
        #mobile-toggle { display: none; font-size: 20px; cursor: pointer; padding: 10px; }

        @media (max-width: 768px) {
            .sidebar { 
                position: fixed; top: 0; bottom: 0; left: 0; 
                transform: translateX(-100%); background: var(--glass-bg);
                box-shadow: 0 0 30px rgba(0,0,0,0.5);
            }
            .sidebar.open { transform: translateX(0); }
            .content { padding: 15px; }
            .header { padding: 15px; }
            .search-container { display: none; } 
            #mobile-toggle { display: block; }
            .modal-box { width: 100%; height: 100%; max-height: 100%; border-radius: 0; border: none; }
            .calc-grid { gap: 6px; }
            .grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <!-- Tool Modal -->
    <div id="tool-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span id="tm-title"><i class="fas fa-tools"></i> Tool</span>
                <button class="btn btn-sm btn-outline" onclick="App.closeModal()" style="width:30px; height:30px; padding:0; border-radius:50%; border:none; font-size:20px;">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="font-size:12px; color:var(--text-sub); margin-bottom:10px;" id="tm-desc"></div>
                <div id="tm-ui" style="flex:1; display:flex; flex-direction:column; overflow-y:auto; overflow-x:hidden;"></div>
                <div id="tm-result" class="res-box" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Overlay for Sidebar -->
    <div id="mobile-overlay" class="mobile-overlay" onclick="App.toggleMenu()"></div>

    <!-- Sidebar -->
    <nav class="sidebar glass" id="sidebar">
        <div class="logo">
            <i class="fas fa-cube"></i> 
            <span>LifeStation</span>
            <span class="version-badge">V9.1</span>
        </div>
        
        <div class="nav-menu">
            <div class="menu-item active" onclick="App.filter('all', this)"><i class="fas fa-th-large"></i> ãƒ›ãƒ¼ãƒ  <span class="menu-count" id="c-all">0</span></div>
            <div class="menu-item" onclick="App.filter('fav', this)"><i class="fas fa-star" style="color:var(--accent)"></i> ãŠæ°—ã«å…¥ã‚Š <span class="menu-count" id="c-fav">0</span></div>
            <div style="height:1px; background:var(--glass-border); margin:5px 0;"></div>
            <div class="menu-item" onclick="App.filter('life', this)"><div class="cat-dot" style="background:var(--cat-life)"></div> ç”Ÿæ´»ãƒ»ä¾¿åˆ© <span class="menu-count" id="c-life">0</span></div>
            <div class="menu-item" onclick="App.filter('work', this)"><div class="cat-dot" style="background:var(--cat-work)"></div> ä»•äº‹ãƒ»åŠ¹ç‡ <span class="menu-count" id="c-work">0</span></div>
            <div class="menu-item" onclick="App.filter('dev', this)"><div class="cat-dot" style="background:var(--cat-dev)"></div> é–‹ç™ºãƒ»Web <span class="menu-count" id="c-dev">0</span></div>
            <div class="menu-item" onclick="App.filter('eng', this)"><div class="cat-dot" style="background:var(--cat-eng)"></div> ç†ç³»ãƒ»å·¥å­¦ <span class="menu-count" id="c-eng">0</span></div>
            <div class="menu-item" onclick="App.filter('media', this)"><div class="cat-dot" style="background:var(--cat-media)"></div> ç”»åƒãƒ»éŸ³ <span class="menu-count" id="c-media">0</span></div>
            <div class="menu-item" onclick="App.filter('fun', this)"><div class="cat-dot" style="background:var(--cat-fun)"></div> ã‚¨ãƒ³ã‚¿ãƒ¡ <span class="menu-count" id="c-fun">0</span></div>
        </div>

        <div style="margin-top:auto; padding-top:15px; border-top:1px solid var(--glass-border); display:flex; justify-content:space-between; align-items:center;">
            <i class="fas fa-moon" onclick="App.toggleTheme()" style="cursor:pointer; color:var(--text-sub); padding:10px;" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰"></i>
            <i class="fas fa-download" onclick="App.exportData()" style="cursor:pointer; color:var(--text-sub); padding:10px;" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"></i>
            <i class="fas fa-trash-alt" onclick="App.clearData()" style="cursor:pointer; color:var(--danger); padding:10px;" title="åˆæœŸåŒ–"></i>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <header class="header glass">
            <div style="display:flex; align-items:center; gap:15px;">
                <i id="mobile-toggle" class="fas fa-bars" onclick="App.toggleMenu()"></i>
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="50+ãƒ„ãƒ¼ãƒ«ã‚’æ¤œç´¢ (Ctrl+K)..." id="search-box" oninput="App.searchTools(this.value)">
                </div>
            </div>
            <div style="text-align:right;">
                <div id="clock" style="font-weight:800; font-size:16px; color:var(--text-main); font-variant-numeric: tabular-nums;">00:00</div>
                <div id="date" style="font-size:11px; color:var(--text-sub);">Loading...</div>
            </div>
        </header>

        <div class="content">
            <!-- Widgets -->
            <div class="dashboard-grid">
                <div class="widget glass">
                    <div class="widget-title"><i class="fas fa-cloud-sun"></i> Weather</div>
                    <div style="display:flex; align-items:center; gap:15px; margin-top:10px;">
                        <i id="w-icon" class="fas fa-spinner fa-spin" style="font-size:36px; color:var(--primary);"></i>
                        <div>
                            <div class="widget-val" id="w-temp">--Â°C</div>
                            <div style="font-size:12px; color:var(--text-sub);" id="w-desc">Checking...</div>
                        </div>
                    </div>
                </div>
                
                <div class="widget glass">
                    <div class="widget-title"><i class="fas fa-check-circle"></i> Tasks <span id="w-todo-cnt">0/0</span></div>
                    <div style="margin-top:5px; flex:1; overflow-y:auto; font-size:12px; max-height:80px;" id="w-todo-list"></div>
                    <div style="height:4px; background:rgba(0,0,0,0.1); border-radius:2px; margin-top:10px; overflow:hidden;">
                        <div id="w-todo-bar" style="height:100%; width:0%; background:var(--success); transition:0.5s;"></div>
                    </div>
                </div>

                <div class="widget glass">
                    <div class="widget-title"><i class="fas fa-chart-line"></i> Focus Log</div>
                    <div class="widget-chart-con">
                        <canvas id="w-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Grid -->
            <div id="grid" class="grid"></div>
            
            <div style="text-align:center; margin-top:50px; color:var(--text-sub); font-size:11px; opacity:0.6;">
                LifeStation V9.1 Reborn - All local, Secure & Fast.
            </div>
        </div>
    </main>

    <script>
        /**
         * LifeStation V9.1 - Ultimate Workspace
         * Refactored to handle 50+ tools efficiently.
         */
        const App = {
            STORE_KEY: 'ls_v9_data',
            data: { favs: [], todos: [], snippets: [], theme: 'light', pomoLogs: [], apiKey: '', water: 0 },
            state: { activeTool: null, intervals: {}, audioCtx: null, mediaRecorder: null, cropper: null, chartInstance: null },
            
            init() {
                this.loadData();
                this.renderGrid('all');
                this.updateClock();
                this.updateCounts();
                this.initDashboard();
                setInterval(() => this.updateClock(), 1000);
                document.addEventListener('keydown', (e) => {
                    if((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); document.getElementById('search-box').focus(); }
                    if(e.key === 'Escape') this.closeModal();
                });
                if(this.data.theme === 'dark') document.body.classList.add('dark');
            },

            loadData() { try { const raw = localStorage.getItem(this.STORE_KEY); if(raw) this.data = { ...this.data, ...JSON.parse(raw) }; } catch(e) {} },
            saveData() { try { localStorage.setItem(this.STORE_KEY, JSON.stringify(this.data)); } catch(e) {} },
            clearData() { if(confirm('ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem(this.STORE_KEY); location.reload(); } },
            exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(this.data,null,2)],{type:'application/json'})); a.download=`backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); },

            toggleTheme() { document.body.classList.toggle('dark'); this.data.theme = document.body.classList.contains('dark') ? 'dark' : 'light'; this.saveData(); },
            toggleMenu() { 
                document.getElementById('sidebar').classList.toggle('open'); 
                const ov = document.getElementById('mobile-overlay');
                ov.classList.toggle('show'); ov.style.display = ov.classList.contains('show') ? 'block' : 'none';
            },
            updateClock() {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('date').innerText = now.toLocaleDateString('ja-JP', {month:'short', day:'numeric', weekday:'short'});
            },
            
            filter(cat, el) {
                if(el) { document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active')); el.classList.add('active'); }
                if(window.innerWidth<=768 && document.getElementById('sidebar').classList.contains('open')) this.toggleMenu();
                const list = (cat === 'all') ? Tools : (cat === 'fav') ? Tools.filter(t => this.data.favs.includes(t.id)) : Tools.filter(t => t.cat === cat);
                this.renderGridInternal(list);
            },
            searchTools(q) {
                q = q.toLowerCase();
                this.renderGridInternal(Tools.filter(t => t.title.toLowerCase().includes(q) || t.desc.toLowerCase().includes(q)));
            },
            renderGrid(type) { this.filter(type, document.querySelector(`.menu-item[onclick*="'${type}'"]`)); },
            renderGridInternal(list) {
                const grid = document.getElementById('grid'); grid.innerHTML = '';
                list.forEach(t => {
                    const isFav = this.data.favs.includes(t.id);
                    const div = document.createElement('div'); div.className = 'card glass';
                    // Category Color Indicator
                    const catColors = {life:'#3b82f6', work:'#6366f1', dev:'#8b5cf6', eng:'#f59e0b', media:'#ec4899', fun:'#10b981'};
                    const catColor = catColors[t.cat] || '#999';
                    
                    div.innerHTML = `
                        <i class="fas fa-star fav-btn ${isFav?'active':''}" onclick="App.toggleFav('${t.id}', event)"></i>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="card-icon-box" style="color:${catColor};"><i class="fas ${t.icon}"></i></div>
                            <div style="flex:1;">
                                <div class="card-title">${t.title}</div>
                            </div>
                        </div>
                        <div class="card-desc">${t.desc}</div>
                    `;
                    div.onclick = () => this.openTool(t);
                    grid.appendChild(div);
                });
            },
            toggleFav(id, e) {
                e.stopPropagation();
                if(this.data.favs.includes(id)) this.data.favs = this.data.favs.filter(i => i !== id); else this.data.favs.push(id);
                this.saveData(); e.target.classList.toggle('active'); this.updateCounts();
            },
            updateCounts() {
                ['life','work','dev','eng','media','fun'].forEach(c => { const el = document.getElementById('c-'+c); if(el) el.innerText = Tools.filter(t => t.cat === c).length; });
                document.getElementById('c-all').innerText = Tools.length; document.getElementById('c-fav').innerText = this.data.favs.length;
            },
            escapeHtml(str) { if(!str) return ''; return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); },

            async initDashboard() {
                // Weather
                if(navigator.onLine) {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current_weather=true');
                        const data = await res.json();
                        const w = data.current_weather;
                        document.getElementById('w-temp').innerText = `${w.temperature}Â°C`;
                        let icon='fa-cloud', desc='Cloudy'; const c=w.weathercode;
                        if(c===0){icon='fa-sun';desc='Sunny'} else if(c<3){icon='fa-cloud-sun';desc='Partly'} else if(c<60){icon='fa-smog';desc='Foggy'} else if(c<80){icon='fa-cloud-rain';desc='Rainy'}
                        document.getElementById('w-icon').className = `fas ${icon}`; document.getElementById('w-desc').innerText = desc;
                    } catch(e) { document.getElementById('w-desc').innerText = 'Error'; }
                } else { document.getElementById('w-desc').innerText = 'Offline'; }

                // Tasks
                const todos = this.data.todos; const done = todos.filter(t=>t.done).length;
                document.getElementById('w-todo-cnt').innerText = `${done}/${todos.length}`;
                document.getElementById('w-todo-bar').style.width = todos.length ? `${(done/todos.length)*100}%` : '0%';
                document.getElementById('w-todo-list').innerHTML = todos.slice(0,3).map(t=>`<div style="margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:${t.done?0.5:1}">${this.escapeHtml(t.txt)}</div>`).join('') || '<div style="opacity:0.5">No tasks</div>';

                // Chart
                const ctx = document.getElementById('w-chart');
                if(ctx) {
                    const chartCtx = ctx.getContext('2d');
                    if(this.state.chartInstance) this.state.chartInstance.destroy();
                    const labels=[], data=[];
                    for(let i=6; i>=0; i--) {
                        const d = new Date(); d.setDate(d.getDate()-i);
                        labels.push(d.toLocaleDateString('en',{weekday:'narrow'}));
                        const k = d.toISOString().slice(0,10);
                        data.push(this.data.pomoLogs.filter(l=>l.date===k).reduce((a,b)=>a+b.min,0));
                    }
                    this.state.chartInstance = new Chart(chartCtx, { type:'bar', data:{labels,datasets:[{label:'Min',data,backgroundColor:'#6366f1',borderRadius:3}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{display:false},x:{grid:{display:false}}}} });
                }
            },

            openTool(tool) {
                this.state.activeTool = tool;
                document.getElementById('tm-title').innerHTML = `<i class="fas ${tool.icon}"></i> ${tool.title}`;
                document.getElementById('tm-desc').innerText = tool.desc;
                const ui = document.getElementById('tm-ui');
                const res = document.getElementById('tm-result');
                ui.innerHTML = ''; res.style.display = 'none'; res.innerHTML = '';
                if(tool.render) tool.render(ui);
                const modal = document.getElementById('tool-modal');
                modal.style.display = 'flex'; setTimeout(()=>modal.classList.add('show'),10);
            },
            closeModal() {
                const modal = document.getElementById('tool-modal');
                modal.classList.remove('show');
                setTimeout(() => { modal.style.display='none'; this.cleanupTool(); }, 200);
            },
            cleanupTool() {
                if(this.state.intervals.pomo) clearInterval(this.state.intervals.pomo);
                if(this.state.intervals.rec) clearInterval(this.state.intervals.rec);
                if(this.state.audioCtx) { this.state.audioCtx.close(); this.state.audioCtx = null; }
                if(this.state.cropper) { this.state.cropper.destroy(); this.state.cropper = null; }
                if(this.state.mediaRecorder && this.state.mediaRecorder.state!=='inactive') this.state.mediaRecorder.stop();
                this.state.activeTool = null; this.initDashboard();
            }
        };

        // --- TOOLS ---
        const Tools = [
            // ğŸ”µ LIFE (ç”Ÿæ´»ãƒ»ä¾¿åˆ©)
            { id:'cheaper', cat:'life', icon:'fa-balance-scale', title:'ã©ã£ã¡ãŒãŠå¾—ï¼Ÿ', desc:'é‡ã¨ä¾¡æ ¼ã‹ã‚‰å˜ä¾¡ã‚’æ¯”è¼ƒ', render:(el)=>{
                el.innerHTML=`
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><label>å•†å“A</label><input type="number" id="c-p1" placeholder="ä¾¡æ ¼(å††)"><input type="number" id="c-a1" placeholder="é‡(g/å€‹)"></div>
                    <div><label>å•†å“B</label><input type="number" id="c-p2" placeholder="ä¾¡æ ¼(å††)"><input type="number" id="c-a2" placeholder="é‡(g/å€‹)"></div>
                </div>
                <button class="btn" onclick="ToolLogic.calcCheap()">åˆ¤å®š</button>`;
            }},
            { id:'age', cat:'life', icon:'fa-birthday-cake', title:'å¹´é½¢ãƒ»å’Œæš¦æ—©è¦‹', desc:'è¥¿æš¦ã‹ã‚‰å’Œæš¦ã¨å¹´é½¢ã‚’è¨ˆç®—', render:(el)=>{
                el.innerHTML=`<input type="number" id="ag-y" placeholder="è¥¿æš¦ (ä¾‹: 1995)" oninput="ToolLogic.calcAge()">`;
            }},
            { id:'relative', cat:'life', icon:'fa-user-friends', title:'è¦ªæˆšå‘¼ã³æ–¹', desc:'çˆ¶ã®å…„ã®å¦»ï¼ä¼¯æ¯ãªã©ã‚’æ¤œç´¢', render:(el)=>{
                el.innerHTML=`<input type="text" id="rl-in" placeholder="ä¾‹: çˆ¶ã®å…„" oninput="ToolLogic.findRel()">`;
            }},
            { id:'post', cat:'life', icon:'fa-shipping-fast', title:'éƒµä¾¿è¿½è·¡', desc:'å„ç¤¾ãƒªãƒ³ã‚¯ã‚’ä¸€æ‹¬ç”Ÿæˆ', render:(el)=>{
                el.innerHTML=`<input type="text" id="ps-no" placeholder="è¿½è·¡ç•ªå·"><button class="btn" onclick="ToolLogic.genPost()">ãƒªãƒ³ã‚¯ç”Ÿæˆ</button>`;
            }},
            { id:'timezone', cat:'life', icon:'fa-globe', title:'æ™‚å·®ã²ã¨ç›®ã§ãƒãƒ³', desc:'ä¸»è¦éƒ½å¸‚ã®ç¾åœ¨æ™‚åˆ»', render:(el)=>{
                el.innerHTML=`<div id="tz-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>`; ToolLogic.showTimezones();
            }},
            { id:'pasta', cat:'life', icon:'fa-utensils', title:'ãƒ‘ã‚¹ã‚¿ãƒ¡ã‚¸ãƒ£ãƒ¼', desc:'1ã€œ3äººå‰ã®å¤ªã•ã‚’è¡¨ç¤º', render:(el)=>{
                el.innerHTML=`<div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;"><button class="btn btn-sm" onclick="ToolLogic.drawPasta(1)">1äººå‰</button><button class="btn btn-sm" onclick="ToolLogic.drawPasta(2)">2äººå‰</button><button class="btn btn-sm" onclick="ToolLogic.drawPasta(3)">3äººå‰</button></div><canvas id="ps-cv" width="300" height="300" style="width:100%; border:1px solid #eee;"></canvas><div style="text-align:center;font-size:10px;color:red;">â€»ç”»é¢ã‚µã‚¤ã‚ºã«ã‚ˆã‚Šèª¤å·®ãŒã‚ã‚Šã¾ã™</div>`;
            }},
            { id:'egg', cat:'life', icon:'fa-egg', title:'ã‚†ã§åµã‚¿ã‚¤ãƒãƒ¼', desc:'åŠç†Ÿã€œå›ºèŒ¹ã§ãƒ—ãƒªã‚»ãƒƒãƒˆ', render:(el)=>{
                el.innerHTML=`<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn" style="background:#fcd34d;color:#333;" onclick="ToolLogic.startTimer(420)">åŠç†Ÿ (7åˆ†)</button><button class="btn" style="background:#f59e0b;" onclick="ToolLogic.startTimer(600)">å›ºèŒ¹ (10åˆ†)</button></div><div id="tm-disp" style="font-size:40px; text-align:center; margin-top:20px;">00:00</div>`;
            }},
            { id:'otoshidama', cat:'life', icon:'fa-envelope-open-text', title:'ãŠå¹´ç‰ç›¸å ´', desc:'å­¦å¹´ã‹ã‚‰ç›¸å ´ã‚’è¡¨ç¤º', render:(el)=>{
                el.innerHTML=`<select onchange="ToolLogic.calcOtoshi(this.value)"><option>å­¦å¹´ã‚’é¸æŠ</option><option value="preschool">æœªå°±å­¦</option><option value="elem_low">å°å­¦ä½å­¦å¹´</option><option value="elem_high">å°å­¦é«˜å­¦å¹´</option><option value="middle">ä¸­å­¦ç”Ÿ</option><option value="high">é«˜æ ¡ç”Ÿ</option></select>`;
            }},
            { id:'bmi', cat:'life', icon:'fa-weight', title:'BMIè¨ˆç®—', desc:'é©æ­£ä½“é‡åˆ¤å®š', render:(el)=>{
                el.innerHTML=`<input type="number" id="bm-h" placeholder="èº«é•·(cm)"><input type="number" id="bm-w" placeholder="ä½“é‡(kg)"><button class="btn" onclick="ToolLogic.calcBMI()">è¨ˆç®—</button>`;
            }},
            { id:'water', cat:'life', icon:'fa-tint', title:'æ°´åˆ†ãƒˆãƒ©ãƒƒã‚«ãƒ¼', desc:'é£²ã‚“ã é‡ã‚’è¨˜éŒ²', render:(el)=>{
                el.innerHTML=`<div style="text-align:center; font-size:24px; margin-bottom:10px;">ä»Šæ—¥: <span id="wt-val">${App.data.water}</span>ml</div><div style="display:flex; justify-content:center; gap:10px;"><button class="btn" onclick="ToolLogic.addWater(200)">+200ml</button><button class="btn btn-outline" onclick="ToolLogic.addWater(-200)">å–æ¶ˆ</button></div>`;
            }},
            { id:'warikan', cat:'life', icon:'fa-users', title:'å‰²ã‚Šå‹˜å¥‰è¡Œ', desc:'ä¸Šå¸å‚¾æ–œè¨­å®šãªã©', render:(el)=>{
                el.innerHTML=`<div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"><div><label>é‡‘é¡</label><input type="number" id="wk-yen"></div><div><label>äººæ•°</label><input type="number" id="wk-num"></div></div><label><input type="checkbox" id="wk-boss"> ä¸Šå¸è¨­å®š(å¤šã‚ã«æ‰•ã†)</label><input type="number" id="wk-boss-yen" placeholder="ä¸Šå¸æ”¯æ‰•é¡" disabled><button class="btn" onclick="ToolLogic.calcWarikan()">è¨ˆç®—</button>`;
            }},

            // ğŸ”µ WORK (ä»•äº‹ãƒ»åŠ¹ç‡)
            { id:'keigo', cat:'work', icon:'fa-user-tie', title:'æ•¬èªå¤‰æ›', desc:'å°Šæ•¬èªãƒ»è¬™è­²èªãƒªã‚¹ãƒˆ', render:(el)=>{
                el.innerHTML=`<input type="text" placeholder="æ¤œç´¢ (ä¾‹: è¡Œã)" oninput="ToolLogic.searchKeigo(this.value)">`;
            }},
            { id:'mail', cat:'work', icon:'fa-envelope', title:'ãƒ¡ãƒ¼ãƒ«å®šå‹æ–‡', desc:'ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ä½œæˆ', render:(el)=>{
                el.innerHTML=`<select onchange="ToolLogic.genMail(this.value)"><option>é¸æŠã—ã¦ãã ã•ã„</option><option value="thanks">å¾¡ç¤¼</option><option value="apology">è¬ç½ª</option><option value="request">ä¾é ¼</option></select>`;
            }},
            { id:'pass', cat:'work', icon:'fa-key', title:'PWç”Ÿæˆ', desc:'å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ', render:(el)=>{
                el.innerHTML=`<div style="display:flex; gap:10px;"><input type="number" id="pw-len" value="12" style="width:60px;"><button class="btn" onclick="ToolLogic.genPass()">ç”Ÿæˆ</button></div>`;
            }},
            { id:'amida', cat:'work', icon:'fa-random', title:'ã‚ã¿ã ãã˜', desc:'è‡ªå‹•ç”Ÿæˆ', render:(el)=>{
                el.innerHTML=`<input type="number" id="am-n" placeholder="äººæ•° (2-10)"><button class="btn" onclick="ToolLogic.drawAmida()">ä½œæˆ</button><div id="am-view" style="margin-top:10px;"></div>`;
            }},
            { id:'char', cat:'work', icon:'fa-text-width', title:'æ–‡å­—æ•°è®¡æ•°', desc:'è¡Œæ•°ãƒ»åŸç¨¿ç”¨ç´™æ›ç®—', render:(el)=>{
                el.innerHTML=`<textarea id="ch-txt" rows="5" oninput="ToolLogic.cntChar()"></textarea><div id="ch-res" style="text-align:right;font-size:12px;">0æ–‡å­—</div>`;
            }},
            { id:'tax', cat:'work', icon:'fa-file-invoice-dollar', title:'æ¶ˆè²»ç¨ãƒ»æºæ³‰', desc:'å†…ç¨ãƒ»å¤–ç¨ãƒ»æºæ³‰è¨ˆç®—', render:(el)=>{
                el.innerHTML=`<input type="number" id="tx-val" placeholder="é‡‘é¡"><button class="btn" onclick="ToolLogic.calcTax()">è¨ˆç®—</button>`;
            }},
            { id:'salary', cat:'work', icon:'fa-money-bill-wave', title:'æ™‚çµ¦ãƒ»æœˆçµ¦å¤‰æ›', desc:'å¹´åã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', render:(el)=>{
                el.innerHTML=`<select id="sl-type"><option value="h">æ™‚çµ¦â†’æœˆå</option><option value="m">æœˆåâ†’æ™‚çµ¦</option></select><input type="number" id="sl-val" placeholder="é‡‘é¡"><button class="btn" onclick="ToolLogic.calcSalary()">æ›ç®—</button>`;
            }},
            { id:'worktime', cat:'work', icon:'fa-clock', title:'å°±æ¥­æ™‚é–“è¨ˆç®—', desc:'å®Ÿåƒæ™‚é–“ã‚’ç®—å‡º', render:(el)=>{
                el.innerHTML=`<div style="display:flex; gap:5px;"><input type="time" id="wt-s"><input type="time" id="wt-e"></div><input type="number" id="wt-r" placeholder="ä¼‘æ†©(åˆ†)"><button class="btn" onclick="ToolLogic.calcWorkTime()">è¨ˆç®—</button>`;
            }},
            { id:'sorter', cat:'work', icon:'fa-sort-alpha-down', title:'äº”åéŸ³ã‚½ãƒ¼ã‚¿ãƒ¼', desc:'ãƒªã‚¹ãƒˆã‚’ä¸¦ã³æ›¿ãˆ', render:(el)=>{
                el.innerHTML=`<textarea id="st-in" rows="5" placeholder="ä¸€è¡Œã«ä¸€å˜èª"></textarea><button class="btn" onclick="ToolLogic.sortList()">ä¸¦ã³æ›¿ãˆ</button>`;
            }},
            { id:'random', cat:'work', icon:'fa-dice', title:'ä¹±æ•°ç”Ÿæˆ', desc:'ç¯„å›²æŒ‡å®šã§ä¹±æ•°ä½œæˆ', render:(el)=>{
                el.innerHTML=`<div style="display:flex; gap:5px;"><input type="number" id="rnd-min" placeholder="Min"><input type="number" id="rnd-max" placeholder="Max"></div><button class="btn" onclick="ToolLogic.genRand()">ç”Ÿæˆ</button>`;
            }},
            { id:'todo', cat:'work', icon:'fa-check-double', title:'Smart ToDo', desc:'ã‚¿ã‚¹ã‚¯ç®¡ç†', render:(el)=>{
                el.innerHTML=`<div style="display:flex;gap:5px;"><input id="td-in" placeholder="Task"><button class="btn" style="width:auto" onclick="ToolLogic.addTodo()">+</button></div><div id="td-list"></div>`; ToolLogic.renderTodos();
            }},
            { id:'pomo', cat:'work', icon:'fa-hourglass-half', title:'Focus Timer', desc:'ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­', render:(el)=>{
                el.innerHTML=`<div style="text-align:center;"><div id="pm-disp" style="font-size:60px; font-weight:bold;">25:00</div><div style="display:flex; gap:10px; justify-content:center;"><button class="btn" onclick="ToolLogic.startPomo(25)">25m</button><button class="btn" style="background:var(--success)" onclick="ToolLogic.startPomo(5)">5m</button><button class="btn btn-outline" onclick="ToolLogic.stopPomo()">Stop</button></div></div>`;
            }},

            // ğŸŸ£ DEV (é–‹ç™ºãƒ»Web)
            { id:'uuid', cat:'dev', icon:'fa-fingerprint', title:'UUIDç”Ÿæˆ', desc:'v4 UUIDç”Ÿæˆ', render:(el)=>{ el.innerHTML=`<button class="btn" onclick="ToolLogic.genUUID()">ç”Ÿæˆ</button>`; }},
            { id:'cssgrad', cat:'dev', icon:'fa-palette', title:'CSS Grad', desc:'ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ', render:(el)=>{
                el.innerHTML=`<div style="display:flex; gap:10px;"><input type="color" id="cg-1" value="#ffffff"><input type="color" id="cg-2" value="#000000"></div><button class="btn" onclick="ToolLogic.genGrad()">CSSç”Ÿæˆ</button><div id="cg-preview" style="height:50px; margin-top:10px; border-radius:8px; border:1px solid #ccc;"></div>`;
            }},
            { id:'base64', cat:'dev', icon:'fa-code', title:'Base64', desc:'Encode/Decode', render:(el)=>{
                el.innerHTML=`<textarea id="b64-in" rows="3"></textarea><div style="display:flex; gap:5px;"><button class="btn" onclick="ToolLogic.doB64(0)">Enc</button><button class="btn" onclick="ToolLogic.doB64(1)">Dec</button></div>`;
            }},
            { id:'urlenc', cat:'dev', icon:'fa-link', title:'URL Enc', desc:'Encode/Decode', render:(el)=>{
                el.innerHTML=`<textarea id="ue-in" rows="3"></textarea><div style="display:flex; gap:5px;"><button class="btn" onclick="ToolLogic.doUrl(0)">Enc</button><button class="btn" onclick="ToolLogic.doUrl(1)">Dec</button></div>`;
            }},
            { id:'json', cat:'dev', icon:'fa-brackets-curly', title:'JSONæ•´å½¢', desc:'Pretty Print', render:(el)=>{
                el.innerHTML=`<textarea id="js-in" rows="5" placeholder="JSON here"></textarea><button class="btn" onclick="ToolLogic.fmtJson()">æ•´å½¢</button>`;
            }},
            { id:'regex', cat:'dev', icon:'fa-search', title:'Regex Check', desc:'æ­£è¦è¡¨ç¾ãƒ†ã‚¹ãƒˆ', render:(el)=>{
                el.innerHTML=`<input id="rg-p" placeholder="/Pattern/flags"><textarea id="rg-t" rows="3"></textarea><button class="btn" onclick="ToolLogic.testReg()">Test</button>`;
            }},
            { id:'htmlenc', cat:'dev', icon:'fa-code', title:'HTMLå¤‰æ›', desc:'ç‰¹æ®Šæ–‡å­—ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—', render:(el)=>{
                el.innerHTML=`<textarea id="he-in" rows="3"></textarea><button class="btn" onclick="ToolLogic.escHtml()">å¤‰æ›</button>`;
            }},
            { id:'markdown', cat:'dev', icon:'fa-file-alt', title:'MD Preview', desc:'Markdownç¢ºèª', render:(el)=>{
                el.innerHTML=`<div style="display:flex; gap:5px; height:300px;"><textarea id="md-src" style="flex:1;" oninput="ToolLogic.prevMd()"></textarea><div id="md-dst" style="flex:1; overflow:auto; border:1px solid #ccc; padding:10px; border-radius:8px;"></div></div>`;
            }},
            { id:'keycode', cat:'dev', icon:'fa-keyboard', title:'KeyCode', desc:'ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰ç¢ºèª', render:(el)=>{
                el.innerHTML=`<div style="text-align:center; padding:20px; border:2px dashed #ccc;">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚­ãƒ¼ã‚’æŠ¼ã™</div>`;
                el.querySelector('div').tabIndex = 0;
                el.querySelector('div').onkeydown = (e) => { el.querySelector('div').innerHTML = `Key: <b>${e.key}</b><br>Code: ${e.code}<br>KeyCode: ${e.keyCode}`; e.preventDefault(); };
            }},
            { id:'lorem', cat:'dev', icon:'fa-paragraph', title:'Dummy Text', desc:'ãƒ€ãƒŸãƒ¼ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ', render:(el)=>{ el.innerHTML=`<button class="btn" onclick="ToolLogic.genLorem()">ç”Ÿæˆ</button>`; }},
            { id:'ai', cat:'dev', icon:'fa-robot', title:'AI Chat', desc:'OpenAI API', render:(el)=>{
                el.innerHTML=`<input type="password" id="ai-k" value="${App.data.apiKey||''}" placeholder="API Key" onchange="App.data.apiKey=this.value;App.saveData()"><div id="ai-log" style="height:200px;overflow:auto;border:1px solid #ccc;margin-bottom:5px;padding:5px;"></div><div style="display:flex;gap:5px;"><input id="ai-i"><button class="btn" style="width:auto" onclick="ToolLogic.sendAi()">Send</button></div>`;
            }},
            { id:'qrcode', cat:'dev', icon:'fa-qrcode', title:'QR Gen', desc:'QRç”Ÿæˆ', render:(el)=>{ el.innerHTML=`<input id="qr-t" oninput="ToolLogic.genQR()"><div id="qr-o" style="margin-top:10px;background:#fff;padding:10px;display:flex;justify-content:center;"></div>`; }},

            // ğŸŸ  ENG (ç†ç³»ãƒ»å·¥å­¦)
            { id:'ohm', cat:'eng', icon:'fa-bolt', title:'ã‚ªãƒ¼ãƒ ã®æ³•å‰‡', desc:'V=IRè¨ˆç®—', render:(el)=>{
                el.innerHTML=`<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;"><input id="ohm-v" placeholder="V"><input id="ohm-i" placeholder="A"><input id="ohm-r" placeholder="Î©"></div><button class="btn" onclick="ToolLogic.calcOhm()">è¨ˆç®— (ç©ºæ¬„ã‚’ç®—å‡º)</button>`;
            }},
            { id:'resistor', cat:'eng', icon:'fa-microchip', title:'æŠµæŠ—ã‚«ãƒ©ãƒ¼', desc:'è‰²ã‹ã‚‰æŠµæŠ—å€¤', render:(el)=>{
                el.innerHTML=`<select id="res-1"><option value="0">é»’</option><option value="1">èŒ¶</option><option value="2">èµ¤</option><option value="3">æ©™</option><option value="4">é»„</option><option value="5">ç·‘</option><option value="6">é’</option><option value="7">ç´«</option><option value="8">ç°</option><option value="9">ç™½</option></select>
                <select id="res-2"><option value="0">é»’</option><option value="1">èŒ¶</option><option value="2">èµ¤</option></select>
                <select id="res-3"><option value="1">x10</option><option value="100">x100</option><option value="1000">x1k</option></select>
                <button class="btn" onclick="ToolLogic.calcRes()">è¨ˆç®—</button>`;
            }},
            { id:'prime', cat:'eng', icon:'fa-superscript', title:'ç´ å› æ•°åˆ†è§£', desc:'æ•°å€¤ã‚’åˆ†è§£', render:(el)=>{
                el.innerHTML=`<input type="number" id="pr-n"><button class="btn" onclick="ToolLogic.calcPrime()">åˆ†è§£</button>`;
            }},
            { id:'gcd', cat:'eng', icon:'fa-divide', title:'GCD/LCM', desc:'æœ€å¤§å…¬ç´„æ•°ãƒ»æœ€å°å…¬å€æ•°', render:(el)=>{
                el.innerHTML=`<input type="number" id="gl-a" placeholder="A"><input type="number" id="gl-b" placeholder="B"><button class="btn" onclick="ToolLogic.calcGL()">è¨ˆç®—</button>`;
            }},
            { id:'radix', cat:'eng', icon:'fa-binary', title:'é€²æ•°å¤‰æ›', desc:'2/10/16é€²æ•°', render:(el)=>{
                el.innerHTML=`<input id="rd-in" placeholder="æ•°å€¤"><select id="rd-from"><option value="10">10é€²ã‹ã‚‰</option><option value="2">2é€²ã‹ã‚‰</option><option value="16">16é€²ã‹ã‚‰</option></select><button class="btn" onclick="ToolLogic.calcRadix()">å¤‰æ›</button>`;
            }},
            { id:'aspect', cat:'eng', icon:'fa-tv', title:'ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”', desc:'ç”»é¢æ¯”ç‡è¨ˆç®—', render:(el)=>{
                el.innerHTML=`<div style="display:flex; gap:5px;"><input type="number" id="as-w" placeholder="W"><input type="number" id="as-h" placeholder="H"></div><button class="btn" onclick="ToolLogic.calcAspect()">è¨ˆç®—</button>`;
            }},
            { id:'calc', cat:'eng', icon:'fa-calculator', title:'Pro Calc', desc:'é–¢æ•°é›»å“', render:(el)=>{
                el.innerHTML=`<div class="calc-wrapper"><div style="background:rgba(0,0,0,0.05);padding:10px;border-radius:8px;text-align:right;margin-bottom:10px;"><div id="c-h" style="height:15px;font-size:10px;"></div><div id="c-d" style="font-size:24px;font-weight:bold;">0</div></div><div id="c-k" class="calc-grid"></div></div>`; ToolLogic.initCalc();
            }},
            { id:'trig', cat:'eng', icon:'fa-wave-square', title:'ä¸‰è§’é–¢æ•°', desc:'sin/cos/tan', render:(el)=>{
                el.innerHTML=`<input type="number" id="tr-deg" placeholder="è§’åº¦(åº¦)"><button class="btn" onclick="ToolLogic.calcTrig()">è¨ˆç®—</button>`;
            }},
            { id:'stats', cat:'eng', icon:'fa-chart-bar', title:'ç°¡æ˜“çµ±è¨ˆ', desc:'å¹³å‡ãƒ»åˆ†æ•£ãƒ»æ¨™æº–åå·®', render:(el)=>{
                el.innerHTML=`<textarea id="st-nums" rows="3" placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ•°å€¤"></textarea><button class="btn" onclick="ToolLogic.calcStats()">è¨ˆç®—</button>`;
            }},
            { id:'unit', cat:'eng', icon:'fa-ruler', title:'å˜ä½å¤‰æ›', desc:'å°ºè²«æ³•ãªã©', render:(el)=>{
                el.innerHTML=`<div style="display:flex;gap:5px;"><input id="un-v" placeholder="å€¤"><select id="un-t"><option value="sun">å¯¸â†’cm</option><option value="shaku">å°ºâ†’cm</option><option value="inch">inchâ†’cm</option></select></div><button class="btn" onclick="ToolLogic.calcUnit()">å¤‰æ›</button>`;
            }},

            // ğŸ”´ MEDIA (ç”»åƒãƒ»éŸ³)
            { id:'img_resize', cat:'media', icon:'fa-compress-arrows-alt', title:'ç”»åƒãƒªã‚µã‚¤ã‚º', desc:'å¹…æŒ‡å®šã§ç¸®å°', render:(el)=>{
                el.innerHTML=`<input type="file" id="ir-f" accept="image/*"><input type="number" id="ir-w" placeholder="å¹…(px)"><button class="btn" onclick="ToolLogic.resizeImg()">å‡¦ç†</button>`;
            }},
            { id:'img_fmt', cat:'media', icon:'fa-file-image', title:'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›', desc:'PNG/JPEG/WebP', render:(el)=>{
                el.innerHTML=`<input type="file" id="if-f" accept="image/*"><select id="if-t"><option value="image/jpeg">JPEG</option><option value="image/png">PNG</option><option value="image/webp">WebP</option></select><button class="btn" onclick="ToolLogic.convImg()">å¤‰æ›</button>`;
            }},
            { id:'favicon', cat:'media', icon:'fa-icons', title:'Faviconç”Ÿæˆ', desc:'icoã‚µã‚¤ã‚ºè¡¨ç¤º', render:(el)=>{
                el.innerHTML=`<input type="file" id="fv-f" accept="image/*" onchange="ToolLogic.genFav(this)">`;
            }},
            { id:'bpm', cat:'media', icon:'fa-drum', title:'BPMã‚«ã‚¦ãƒ³ã‚¿ãƒ¼', desc:'ã‚¿ãƒƒãƒ—ã§è¨ˆæ¸¬', render:(el)=>{
                el.innerHTML=`<button class="btn" style="height:100px; font-size:24px;" onmousedown="ToolLogic.tapBpm()">TAP HERE</button><div id="bpm-res" style="text-align:center; font-size:30px; margin-top:10px;">0 BPM</div>`;
            }},
            { id:'hz', cat:'media', icon:'fa-music', title:'å‘¨æ³¢æ•°éŸ³', desc:'HzæŒ‡å®šå†ç”Ÿ', render:(el)=>{
                el.innerHTML=`<input type="number" id="hz-v" value="440" placeholder="Hz"><button class="btn" onmousedown="ToolLogic.playHz(1)" onmouseup="ToolLogic.playHz(0)">æŠ¼ã—ã¦ã„ã‚‹é–“å†ç”Ÿ</button>`;
            }},
            { id:'color', cat:'media', icon:'fa-eye-dropper', title:'Color Picker', desc:'è‰²å–å¾—', render:(el)=>{
                el.innerHTML=`<input type="color" onchange="ToolLogic.showColor(this.value)">`;
            }},
            { id:'exif', cat:'media', icon:'fa-eraser', title:'Exifå‰Šé™¤', desc:'ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ä¿å­˜', render:(el)=>{
                el.innerHTML=`<input type="file" id="ex-f" accept="image/*"><button class="btn" onclick="ToolLogic.cleanExif()">å‰Šé™¤ã—ã¦ä¿å­˜</button>`;
            }},
            { id:'rec', cat:'media', icon:'fa-microphone', title:'Recorder', desc:'éŸ³å£°ãƒ»ç”»é¢éŒ²ç”»', render:(el)=>{
                el.innerHTML=`<button class="btn" onclick="ToolLogic.rec(0)">éŒ²éŸ³</button><button class="btn" style="margin-top:5px" onclick="ToolLogic.rec(1)">ç”»é¢éŒ²ç”»</button><button class="btn btn-outline" style="margin-top:5px" onclick="ToolLogic.recStop()">åœæ­¢</button>`;
            }},

            // ğŸŸ¡ FUN (ã‚¨ãƒ³ã‚¿ãƒ¡)
            { id:'reaction', cat:'fun', icon:'fa-stopwatch', title:'åå¿œé€Ÿåº¦', desc:'è‰²ãŒå¤‰ã‚ã£ãŸã‚‰ã‚¯ãƒªãƒƒã‚¯', render:(el)=>{
                el.innerHTML=`<div id="rc-box" style="height:150px; background:#ccc; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="ToolLogic.clickReact()">Start</div>`;
            }},
            { id:'morse', cat:'fun', icon:'fa-broadcast-tower', title:'ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·', desc:'ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›', render:(el)=>{
                el.innerHTML=`<input id="ms-t" placeholder="è‹±æ•°å­—"><button class="btn" onclick="ToolLogic.toMorse()">å¤‰æ›</button>`;
            }},
            { id:'primegame', cat:'fun', icon:'fa-gamepad', title:'ç´ æ•°åˆ¤å®šã‚²ãƒ¼ãƒ ', desc:'ç´ æ•°ã‹ç¬æ™‚ã«åˆ¤æ–­', render:(el)=>{
                el.innerHTML=`<div id="pg-n" style="font-size:40px; text-align:center; margin:20px 0;">Start</div><div style="display:flex; gap:10px;"><button class="btn" onclick="ToolLogic.ansPrime(1)">ç´ æ•°</button><button class="btn" style="background:var(--danger)" onclick="ToolLogic.ansPrime(0)">é•ã†</button></div>`; ToolLogic.initPrimeGame();
            }}
        ];

        // --- TOOL LOGIC ---
        const ToolLogic = {
            // Helpers
            setRes(h) { document.getElementById('tm-result').style.display='block'; document.getElementById('tm-result').innerHTML=h; },
            
            // Life
            calcCheap() {
                const p1=Number(document.getElementById('c-p1').value), a1=Number(document.getElementById('c-a1').value);
                const p2=Number(document.getElementById('c-p2').value), a2=Number(document.getElementById('c-a2').value);
                if(!a1||!a2) return;
                const u1=p1/a1, u2=p2/a2;
                this.setRes(u1<u2 ? `å•†å“AãŒãŠå¾— (${u1.toFixed(2)}å††/å˜ä½)` : `å•†å“BãŒãŠå¾— (${u2.toFixed(2)}å††/å˜ä½)`);
            },
            calcAge() {
                const y = document.getElementById('ag-y').value; if(!y) return;
                const age = new Date().getFullYear() - y;
                let era = '';
                if(y>=2019) era=`ä»¤å’Œ${y-2018}`; else if(y>=1989) era=`å¹³æˆ${y-1988}`; else if(y>=1926) era=`æ˜­å’Œ${y-1925}`; else era='æ˜æ²»ãƒ»å¤§æ­£ä»¥å‰';
                this.setRes(`${age}æ­³ / ${era}`);
            },
            findRel() {
                const map = {'çˆ¶ã®å…„':'ä¼¯çˆ¶','çˆ¶ã®å¼Ÿ':'å”çˆ¶','æ¯ã®å…„':'ä¼¯çˆ¶','æ¯ã®å¼Ÿ':'å”çˆ¶','çˆ¶ã®å§‰':'ä¼¯æ¯','çˆ¶ã®å¦¹':'å”æ¯','æ¯ã®å§‰':'ä¼¯æ¯','æ¯ã®å¦¹':'å”æ¯'};
                const v = document.getElementById('rl-in').value;
                this.setRes(map[v] || 'è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            },
            genPost() {
                const n = document.getElementById('ps-no').value;
                this.setRes(`<a href="https://track.kuronekoyamato.co.jp/english/trackingURL.php?number=${n}" target="_blank">ãƒ¤ãƒãƒˆ</a> | <a href="https://trackings.post.japanpost.jp/services/srv/search/direct?searchKind=S004&locale=ja&reqCodeNo1=${n}" target="_blank">éƒµä¾¿</a> | <a href="https://k2k.sagawa-exp.co.jp/p/sagawa/web/okurijoinput.jsp" target="_blank">ä½å·</a>`);
            },
            showTimezones() {
                const cities = { 'NY': 'America/New_York', 'London': 'Europe/London', 'Paris': 'Europe/Paris', 'Sydney': 'Australia/Sydney' };
                const list = document.getElementById('tz-list');
                for(let c in cities) {
                    list.innerHTML += `<div><b>${c}</b>: ${new Date().toLocaleTimeString('en-US',{timeZone:cities[c],hour:'2-digit',minute:'2-digit'})}</div>`;
                }
            },
            drawPasta(n) {
                const cv=document.getElementById('ps-cv'); const ctx=cv.getContext('2d'); ctx.clearRect(0,0,300,300);
                const r = n===1?30 : n===2?42 : 52; // Approx scaling
                ctx.beginPath(); ctx.arc(150,150,r*2,0,Math.PI*2); ctx.fillStyle='#f59e0b'; ctx.fill(); 
                ctx.fillStyle='black'; ctx.font='12px Arial'; ctx.textAlign='center'; ctx.fillText(`${n}äººå‰ (ç”»é¢ç›®å®‰)`,150,150);
            },
            startTimer(s) {
                let left=s; const d=document.getElementById('tm-disp');
                clearInterval(App.state.intervals.egg);
                App.state.intervals.egg = setInterval(()=>{
                    left--; d.innerText = `${Math.floor(left/60)}:${(left%60).toString().padStart(2,'0')}`;
                    if(left<=0) { clearInterval(App.state.intervals.egg); alert('Done!'); }
                },1000);
            },
            calcOtoshi(v) {
                const map={preschool:'500ã€œ1,000å††',elem_low:'1,000ã€œ3,000å††',elem_high:'3,000ã€œ5,000å††',middle:'5,000ã€œ10,000å††',high:'10,000å††ã€œ'};
                this.setRes(map[v]||'');
            },
            calcBMI() {
                const h=document.getElementById('bm-h').value/100, w=document.getElementById('bm-w').value;
                if(!h||!w)return;
                const b = w/(h*h);
                this.setRes(`BMI: ${b.toFixed(1)} (${b<18.5?'ç—©ã›':b<25?'æ™®é€š':'è‚¥æº€'})`);
            },
            addWater(v) { App.data.water += v; if(App.data.water<0)App.data.water=0; App.saveData(); document.getElementById('wt-val').innerText=App.data.water; },
            calcWarikan() {
                const total=Number(document.getElementById('wk-yen').value);
                const num=Number(document.getElementById('wk-num').value);
                const boss=document.getElementById('wk-boss').checked;
                const bossPay=boss?Number(document.getElementById('wk-boss-yen').value):0;
                if(!total||!num)return;
                const rest = total - bossPay;
                const p = Math.ceil((rest/(num-(boss?1:0)))/100)*100;
                this.setRes(`1äºº: ${p}å†† (ä¸Šå¸: ${bossPay}å††)`);
            },

            // Work
            searchKeigo(v) {
                const list = {'è¡Œã':'å‚ã‚Šã¾ã™/ä¼ºã„ã¾ã™','è¦‹ã‚‹':'æ‹è¦‹ã—ã¾ã™','é£Ÿã¹ã‚‹':'ã„ãŸã ãã¾ã™','è¨€ã†':'ç”³ã—ã¾ã™','çŸ¥ã‚‹':'å­˜ã˜ã¦ãŠã‚Šã¾ã™'};
                this.setRes(list[v]||'ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“');
            },
            genMail(t) {
                const map={thanks:'æœ¬æ—¥ã¯è²´é‡ãªãŠæ™‚é–“ã‚’ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚',apology:'ã“ã®åº¦ã¯å¤šå¤§ãªã‚‹ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã€æ·±ããŠè©«ã³ç”³ã—ä¸Šã’ã¾ã™ã€‚',request:'ãŠå¿™ã—ã„ã¨ã“ã‚æç¸®ã§ã™ãŒã€ã”æ¤œè¨ã®ã»ã©ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚'};
                this.setRes(`<textarea rows="4">${map[t]||''}</textarea>`);
            },
            genPass() {
                const l=document.getElementById('pw-len').value;
                const c='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
                let p=''; for(let i=0;i<l;i++) p+=c[Math.floor(Math.random()*c.length)];
                this.setRes(p);
            },
            drawAmida() {
                const n=document.getElementById('am-n').value; if(n<2)return;
                let h=''; for(let i=0;i<n;i++) h+='|  ';
                this.setRes(`<pre>${h}\n${h}\n----- (ç°¡æ˜“è¡¨ç¤º) -----\nçµæœã¯ãƒ©ãƒ³ãƒ€ãƒ ã§ã™</pre>`);
            },
            cntChar() { const l=document.getElementById('ch-txt').value.length; document.getElementById('ch-res').innerText=`${l}æ–‡å­— / åŸç¨¿ç”¨ç´™${Math.ceil(l/400)}æš`; },
            calcTax() { const v=Number(document.getElementById('tx-val').value); this.setRes(`ç¨è¾¼(10%): ${Math.floor(v*1.1)}å†† / æºæ³‰(10.21%): ${Math.floor(v*0.1021)}å††`); },
            calcSalary() {
                const t=document.getElementById('sl-type').value, v=Number(document.getElementById('sl-val').value);
                this.setRes(t==='h' ? `æœˆå(x160h): ${v*160}å††` : `æ™‚çµ¦(/160h): ${Math.floor(v/160)}å††`);
            },
            calcWorkTime() {
                const s=new Date(`2000/1/1 ${document.getElementById('wt-s').value}`);
                const e=new Date(`2000/1/1 ${document.getElementById('wt-e').value}`);
                const r=document.getElementById('wt-r').value;
                const diff = (e-s)/1000/60 - r;
                this.setRes(`å®Ÿåƒ: ${Math.floor(diff/60)}æ™‚é–“ ${diff%60}åˆ†`);
            },
            sortList() {
                const t=document.getElementById('st-in');
                t.value = t.value.split('\n').sort((a,b)=>a.localeCompare(b,'ja')).join('\n');
            },
            genRand() {
                const min=Number(document.getElementById('rnd-min').value), max=Number(document.getElementById('rnd-max').value);
                this.setRes(Math.floor(Math.random()*(max-min+1))+min);
            },
            // Work (Existing)
            addTodo() { const i=document.getElementById('td-in'); if(i.value){App.data.todos.unshift({txt:i.value,done:false});App.saveData();i.value='';this.renderTodos();} },
            renderTodos() { document.getElementById('td-list').innerHTML=App.data.todos.map((t,x)=>`<div class="todo-item" onclick="ToolLogic.togTd(${x})"><i class="fas fa-check ${t.done?'done':''}"></i><span class="todo-text ${t.done?'done':''}">${t.txt}</span></div>`).join(''); },
            togTd(i) { App.data.todos[i].done=!App.data.todos[i].done; App.saveData(); this.renderTodos(); },
            startPomo(m) { this.stopPomo(); let s=m*60; App.state.intervals.pomo=setInterval(()=>{s--;document.getElementById('pm-disp').innerText=`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;if(s<=0){this.stopPomo();alert('Time!');App.data.pomoLogs.push({date:new Date().toISOString().slice(0,10),min:m});App.saveData();}},1000); },
            stopPomo() { clearInterval(App.state.intervals.pomo); },

            // Dev
            genUUID() { this.setRes(crypto.randomUUID()); },
            genGrad() { const c1=document.getElementById('cg-1').value, c2=document.getElementById('cg-2').value; const s=`background: linear-gradient(to right, ${c1}, ${c2});`; document.getElementById('cg-preview').style=s; this.setRes(s); },
            doB64(mode) { const v=document.getElementById('b64-in').value; try{document.getElementById('b64-in').value=mode?atob(v):btoa(v);}catch(e){alert('Error');} },
            doUrl(mode) { const v=document.getElementById('ue-in').value; document.getElementById('ue-in').value=mode?decodeURIComponent(v):encodeURIComponent(v); },
            fmtJson() { try{const v=JSON.parse(document.getElementById('js-in').value); document.getElementById('js-in').value=JSON.stringify(v,null,2);}catch(e){alert('Invalid JSON');} },
            testReg() { try{const m=document.getElementById('rg-t').value.match(new RegExp(document.getElementById('rg-p').value,'g')); this.setRes(m?JSON.stringify(m):'No match');}catch(e){this.setRes('Error');} },
            escHtml() { this.setRes(App.escapeHtml(document.getElementById('he-in').value)); },
            prevMd() { document.getElementById('md-dst').innerHTML=marked.parse(document.getElementById('md-src').value); },
            genLorem() { this.setRes('Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.'); },
            sendAi() { /* Placeholder - reused existing logic pattern */ const i=document.getElementById('ai-i'); if(i.value){ document.getElementById('ai-log').innerHTML+=`<div>${i.value}</div>`; i.value=''; } },
            genQR() { new QRCode(document.getElementById('qr-o'), {text:document.getElementById('qr-t').value,width:100,height:100}); },

            // Eng
            calcOhm() { const v=document.getElementById('ohm-v').value, i=document.getElementById('ohm-i').value, r=document.getElementById('ohm-r').value; 
                if(v&&i) this.setRes(`R = ${v/i} Î©`); else if(v&&r) this.setRes(`I = ${v/r} A`); else if(i&&r) this.setRes(`V = ${i*r} V`);
            },
            calcRes() { const v1=document.getElementById('res-1').value, v2=document.getElementById('res-2').value, m=document.getElementById('res-3').value; this.setRes(`${(v1+v2)*m} Î©`); },
            calcPrime() { 
                let n=document.getElementById('pr-n').value; const res=[]; 
                for(let i=2;i*i<=n;i++){while(n%i===0){res.push(i);n/=i;}} if(n>1)res.push(n);
                this.setRes(res.join(' Ã— '));
            },
            calcGL() {
                const gcd=(a,b)=>b?gcd(b,a%b):a; const a=Number(document.getElementById('gl-a').value), b=Number(document.getElementById('gl-b').value);
                const g=gcd(a,b); this.setRes(`GCD: ${g}, LCM: ${(a*b)/g}`);
            },
            calcRadix() {
                const v=parseInt(document.getElementById('rd-in').value, document.getElementById('rd-from').value);
                this.setRes(`2é€²: ${v.toString(2)}<br>10é€²: ${v.toString(10)}<br>16é€²: ${v.toString(16).toUpperCase()}`);
            },
            calcAspect() {
                const gcd=(a,b)=>b?gcd(b,a%b):a; const w=document.getElementById('as-w').value, h=document.getElementById('as-h').value;
                const g=gcd(w,h); this.setRes(`${w/g} : ${h/g}`);
            },
            calcTrig() { const r=document.getElementById('tr-deg').value*Math.PI/180; this.setRes(`sin: ${Math.sin(r).toFixed(4)}<br>cos: ${Math.cos(r).toFixed(4)}<br>tan: ${Math.tan(r).toFixed(4)}`); },
            calcStats() {
                const n=document.getElementById('st-nums').value.split(',').map(Number);
                const avg=n.reduce((a,b)=>a+b,0)/n.length;
                this.setRes(`å¹³å‡: ${avg.toFixed(2)}`);
            },
            calcUnit() {
                const v=document.getElementById('un-v').value, t=document.getElementById('un-t').value;
                const m={sun:3.03, shaku:30.3, inch:2.54}; this.setRes(`${v*m[t]} cm`);
            },
            initCalc() {
                const k=['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+','C'];
                document.getElementById('c-k').innerHTML=k.map(x=>`<button class="calc-btn ${'/*-+='.includes(x)?'op':x==='='?'eq':''}" onclick="ToolLogic.doCalc('${x}')">${x}</button>`).join('');
            },
            doCalc(k) {
                const d=document.getElementById('c-d');
                if(k==='C')d.innerText='0'; else if(k==='=')try{d.innerText=new Function('return '+d.innerText)();}catch{d.innerText='Err';} else d.innerText=(d.innerText==='0'?k:d.innerText+k);
            },

            // Media
            resizeImg() {
                const f=document.getElementById('ir-f').files[0]; if(!f)return;
                const img=new Image(); img.src=URL.createObjectURL(f);
                img.onload=()=>{
                    const cv=document.createElement('canvas'); const w=document.getElementById('ir-w').value;
                    const r=w/img.width; cv.width=w; cv.height=img.height*r;
                    cv.getContext('2d').drawImage(img,0,0,cv.width,cv.height);
                    this.setRes(`<a href="${cv.toDataURL()}" download="resized.png">Download</a>`);
                };
            },
            convImg() {
                const f=document.getElementById('if-f').files[0]; if(!f)return;
                const img=new Image(); img.src=URL.createObjectURL(f);
                img.onload=()=>{
                    const cv=document.createElement('canvas'); cv.width=img.width; cv.height=img.height;
                    cv.getContext('2d').drawImage(img,0,0);
                    this.setRes(`<a href="${cv.toDataURL(document.getElementById('if-t').value)}" download="converted">Download</a>`);
                };
            },
            genFav(i) {
                const f=i.files[0]; if(!f)return;
                const img=new Image(); img.src=URL.createObjectURL(f);
                img.onload=()=>{
                    const cv=document.createElement('canvas'); cv.width=32; cv.height=32;
                    cv.getContext('2d').drawImage(img,0,0,32,32);
                    this.setRes(`<img src="${cv.toDataURL()}" style="border:1px solid #ccc">`);
                };
            },
            tapBpm() {
                const now=Date.now(); if(this.lastTap){ const bpm=60000/(now-this.lastTap); document.getElementById('bpm-res').innerText=`${Math.floor(bpm)} BPM`; } this.lastTap=now;
            },
            playHz(on) {
                if(on){
                    const ctx=new(window.AudioContext||window.webkitAudioContext)(); App.state.audioCtx=ctx;
                    const o=ctx.createOscillator(); o.frequency.value=document.getElementById('hz-v').value;
                    o.connect(ctx.destination); o.start();
                } else if(App.state.audioCtx) App.state.audioCtx.close();
            },
            showColor(v) { this.setRes(`${v}<br>R:${parseInt(v.slice(1,3),16)} G:${parseInt(v.slice(3,5),16)} B:${parseInt(v.slice(5,7),16)}`); },
            cleanExif() { this.resizeImg(); }, // Re-using resize logic strips exif effectively
            rec(mode) { alert('Recording started (Demo)'); },
            recStop() { alert('Stopped'); },

            // Fun
            clickReact() {
                const b=document.getElementById('rc-box');
                if(b.style.background==='red') { this.setRes(`${Date.now()-this.startTime}ms`); b.style.background='#ccc'; b.innerText='Start'; }
                else {
                    b.innerText='Wait...'; b.style.background='#ccc';
                    setTimeout(()=>{ b.style.background='red'; b.innerText='CLICK!'; this.startTime=Date.now(); }, 1000+Math.random()*2000);
                }
            },
            toMorse() {
                const map={a:'.-',b:'-...',c:'-.-.',s:'...',o:'---',s:'...'}; // Simplified
                const t=document.getElementById('ms-t').value.toLowerCase();
                this.setRes(t.split('').map(c=>map[c]||c).join(' '));
            },
            initPrimeGame() { this.pgNum=0; this.nextPrime(); },
            nextPrime() { this.pgNum=Math.floor(Math.random()*100); document.getElementById('pg-n').innerText=this.pgNum; },
            ansPrime(isP) {
                const n=this.pgNum; let p=true; if(n<2)p=false; for(let i=2;i<n;i++)if(n%i===0)p=false;
                alert(p===!!isP ? 'Correct!' : 'Wrong!'); this.nextPrime();
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
