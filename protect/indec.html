<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFã‚’ä¿è­· - PDFç¥ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7/download.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <nav class="bg-white shadow p-4">
        <div class="container mx-auto">
            <a href="../" class="text-blue-600 hover:underline font-bold">â† ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        </div>
    </nav>

    <main class="container mx-auto p-6 flex-grow max-w-2xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">PDFã‚’ä¿è­·ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰</h1>
        
        <div class="bg-white p-8 rounded-xl shadow-lg">
            <div class="border-4 border-dashed border-gray-300 rounded-lg p-10 text-center hover:bg-gray-100 transition relative">
                <input type="file" id="fileInput" accept="application/pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <p class="text-gray-500 text-lg">PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
            </div>
            <p id="fileName" class="text-center mt-4 font-bold text-gray-700"></p>

            <div id="controls" class="hidden mt-6">
                <label class="block text-gray-700 font-bold mb-2">è¨­å®šã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="password" class="w-full p-3 border rounded mb-6" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                
                <button id="protectBtn" class="w-full bg-gray-800 text-white font-bold py-4 px-6 rounded-lg hover:bg-black transition">
                    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
    </main>

    <script>
        const { PDFDocument, StandardFonts } = PDFLib;
        const fileInput = document.getElementById('fileInput');
        const controls = document.getElementById('controls');
        let currentFile = null;

        fileInput.addEventListener('change', (e) => {
            if(e.target.files[0]){
                currentFile = e.target.files[0];
                document.getElementById('fileName').innerText = "ğŸ“„ " + currentFile.name;
                controls.classList.remove('hidden');
            }
        });

        document.getElementById('protectBtn').addEventListener('click', async () => {
            const password = document.getElementById('password').value;
            if (!currentFile || !password) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            try {
                const arrayBuffer = await currentFile.arrayBuffer();
                const pdfDoc = await PDFDocument.load(arrayBuffer);

                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æš—å·åŒ–å‡¦ç†
                // 128-bit AESæš—å·åŒ–ã‚’ä½¿ç”¨
                const pdfBytes = await pdfDoc.save({
                    userPassword: password,
                    ownerPassword: password, // ç·¨é›†æ¨©é™ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆåŒã˜ã«ã—ã¦ãŠãï¼‰
                    permissions: {
                        printing: 'highResolution',
                        modifying: false,
                        copying: false,
                    }
                });

                download(pdfBytes, "protected_" + currentFile.name, "application/pdf");
            } catch (err) {
                console.error(err);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ—¢ã«ä¿è­·ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
            }
        });
    </script>
</body>
</html>
