<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF分割・抽出 - PDF神ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7/download.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <nav class="bg-white shadow p-4">
        <div class="container mx-auto">
            <a href="../" class="text-blue-600 hover:underline font-bold">← トップへ戻る</a>
        </div>
    </nav>

    <main class="container mx-auto p-6 flex-grow max-w-2xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">PDF分割・抽出</h1>
        
        <div class="bg-white p-8 rounded-xl shadow-lg">
            <div class="border-4 border-dashed border-red-200 rounded-lg p-10 text-center hover:bg-red-50 transition relative">
                <input type="file" id="fileInput" accept="application/pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <p class="text-gray-500 text-lg">ここにPDFをドラッグ&ドロップ<br>（1ファイルのみ）</p>
            </div>

            <div id="fileInfo" class="hidden mt-6 bg-blue-50 p-4 rounded text-center">
                <p class="font-bold text-lg" id="fileName">filename.pdf</p>
                <p class="text-sm text-gray-600">全 <span id="pageCount" class="font-bold">0</span> ページ</p>
            </div>

            <div id="actions" class="hidden mt-8 space-y-6">
                
                <div class="border-t pt-6">
                    <h3 class="font-bold text-lg mb-2">① 全ページをバラバラにする</h3>
                    <p class="text-sm text-gray-500 mb-3">1ページごとのPDFファイルに分割し、ZIPでまとめて保存します。</p>
                    <button id="splitAllBtn" class="w-full bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 transition">
                        全ページ分割してZIPダウンロード
                    </button>
                </div>

                <div class="border-t pt-6">
                    <h3 class="font-bold text-lg mb-2">② 特定ページを抜き出す</h3>
                    <p class="text-sm text-gray-500 mb-3">例: "1" (1枚目のみ), "1-3" (1から3枚目), "1,3,5" (指定ページ)</p>
                    <div class="flex gap-2">
                        <input type="text" id="pageRange" placeholder="例: 1-5, 8" class="border p-3 rounded-lg flex-grow">
                        <button id="extractBtn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">
                            抽出
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        const { PDFDocument } = PDFLib;
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileNameSpan = document.getElementById('fileName');
        const pageCountSpan = document.getElementById('pageCount');
        const actionsDiv = document.getElementById('actions');
        
        let currentPdfBytes = null;
        let currentFileName = "";

        // ファイル読み込み
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            currentFileName = file.name;
            currentPdfBytes = await file.arrayBuffer();

            // ページ数を数えるためにロード
            const pdfDoc = await PDFDocument.load(currentPdfBytes);
            
            fileNameSpan.innerText = currentFileName;
            pageCountSpan.innerText = pdfDoc.getPageCount();
            
            fileInfo.classList.remove('hidden');
            actionsDiv.classList.remove('hidden');
        });

        // ① 全ページ分割（ZIP作成）
        document.getElementById('splitAllBtn').addEventListener('click', async () => {
            const btn = document.getElementById('splitAllBtn');
            btn.innerText = "処理中...";
            btn.disabled = true;

            try {
                const pdfDoc = await PDFDocument.load(currentPdfBytes);
                const pageCount = pdfDoc.getPageCount();
                const zip = new JSZip();

                // 全ページループ処理
                for (let i = 0; i < pageCount; i++) {
                    const newPdf = await PDFDocument.create();
                    const [copiedPage] = await newPdf.copyPages(pdfDoc, [i]);
                    newPdf.addPage(copiedPage);
                    const pdfBytes = await newPdf.save();
                    
                    // ZIPに追加 (ファイル名: original_p1.pdf)
                    const name = currentFileName.replace('.pdf', '') + `_p${i + 1}.pdf`;
                    zip.file(name, pdfBytes);
                }

                // ZIP生成とダウンロード
                const content = await zip.generateAsync({type:"blob"});
                download(content, "split_files.zip", "application/zip");

            } catch (err) {
                console.error(err);
                alert("エラーが発生しました");
            } finally {
                btn.innerText = "全ページ分割してZIPダウンロード";
                btn.disabled = false;
            }
        });

        // ② 特定ページ抽出
        document.getElementById('extractBtn').addEventListener('click', async () => {
            const rangeStr = document.getElementById('pageRange').value;
            if (!rangeStr) return alert("ページ範囲を入力してください");

            try {
                const pdfDoc = await PDFDocument.load(currentPdfBytes);
                const totalPages = pdfDoc.getPageCount();
                const newPdf = await PDFDocument.create();

                // ページ指定文字列を解析（"1-3, 5" -> [0, 1, 2, 4]）
                const pageIndices = parsePageRange(rangeStr, totalPages);
                
                if (pageIndices.length === 0) return alert("有効なページが見つかりません");

                const copiedPages = await newPdf.copyPages(pdfDoc, pageIndices);
                copiedPages.forEach(page => newPdf.addPage(page));

                const pdfBytes = await newPdf.save();
                download(pdfBytes, "extracted_" + currentFileName, "application/pdf");

            } catch (err) {
                console.error(err);
                alert("指定形式が正しくないか、エラーが発生しました");
            }
        });

        // "1-3, 5" みたいな文字列を配列にする関数
        function parsePageRange(rangeStr, maxPages) {
            const pages = new Set();
            const parts = rangeStr.split(',');

            parts.forEach(part => {
                const p = part.trim();
                if (p.includes('-')) {
                    const [start, end] = p.split('-').map(Number);
                    if (start && end) {
                        for (let i = start; i <= end; i++) pages.add(i - 1);
                    }
                } else {
                    const num = Number(p);
                    if (num) pages.add(num - 1);
                }
            });

            // 範囲外を除外してソート
            return Array.from(pages)
                .filter(i => i >= 0 && i < maxPages)
                .sort((a, b) => a - b);
        }
    </script>
</body>
</html>
